<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Ð Ñ‹Ð±Ð°Ð»ÐºÐ° ÐžÐ½Ð»Ð°Ð¹Ð½: Ð ÐµÐ±Ð¾Ñ€Ð½</title>
<link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&family=Neucha&display=swap" rel="stylesheet">
<style>
/* ============================================================
   ROOT VARIABLES
   ============================================================ */
:root {
  --wood-dark:   #2a1605;
  --wood-mid:    #4a2808;
  --wood-light:  #7a4e20;
  --plank:       #8a5520;
  --accent-gold: #d4a030;
  --coin:        #e8b830;
  --rope:        #7a6030;

  /* Sky / weather colors - animated by JS */
  --sky-top:    #020609;
  --sky-bot:    #081812;
  --water-top:  #0c3820;
  --water-bot:  #030e08;
  --amb-light:  rgba(0,0,0,0);

  /* Transition for weather */
  --wtrans: 4s;
}

/* ============================================================
   RESET & BASE
   ============================================================ */
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

html {
  width:100%; height:100%;
  /* fill safe area on phones */
  background:#0d0905;
}
body {
  width:100%; height:100%;
  display:flex; justify-content:center; align-items:center;
  overflow:hidden; background:#0d0905;
  /* avoid iOS bounce */
  position:fixed; top:0; left:0;
}

/* ============================================================
   GAME WRAPPER â€” always 360Ã—700, scaled to fit screen
   ============================================================ */
#game-scale-wrapper {
  transform-origin: center center;
  /* JS sets transform: scale() */
}

#game {
  width:360px; height:700px;
  position:relative; overflow:hidden;
  border-radius:12px;
  border:5px solid var(--wood-dark);
  box-shadow:0 0 0 2px var(--wood-mid), 0 0 80px rgba(0,0,0,.95);
  background:#000;
}

/* ============================================================
   SCREEN SYSTEM
   ============================================================ */
.screen {
  position:absolute; inset:0;
  display:none; z-index:5;
  padding-bottom:60px; /* space for navtabs */
}
.screen.active { display:block; }

/* ============================================================
   STATUSBAR
   ============================================================ */
#statusbar {
  position:absolute; top:0; left:0; right:0; height:46px; z-index:200;
}
#statusbar-bg {
  position:absolute; inset:0;
  background:
    repeating-linear-gradient(90deg,transparent 0,transparent 20px,rgba(0,0,0,.07) 20px,rgba(0,0,0,.07) 22px),
    linear-gradient(to bottom,#a06030,#5a2e08);
  border-bottom:3px solid var(--wood-dark);
}
#statusbar-bg::after {
  content:''; position:absolute; inset:0;
  background:repeating-linear-gradient(173deg,transparent 0,transparent 8px,rgba(0,0,0,.03) 8px,rgba(0,0,0,.03) 9px);
}
.s-nail {
  position:absolute; width:10px; height:10px;
  background:radial-gradient(circle at 35% 35%,#bbb,#444);
  border-radius:50%; border:1px solid #222;
  box-shadow:1px 1px 2px rgba(0,0,0,.6); z-index:5;
}
.s-nail.tl{top:8px;left:8px;} .s-nail.tr{top:8px;right:8px;}

#time-box {
  position:absolute; left:26px; top:9px;
  background:rgba(0,0,0,.5); border:1px solid var(--wood-dark); border-radius:4px;
  padding:4px 10px; font-family:'Neucha',cursive; font-size:14px; color:#e8c880;
  letter-spacing:1px; text-shadow:0 1px 3px rgba(0,0,0,.8); z-index:5;
  display:flex; align-items:center; gap:5px;
}
#weather-icon { font-size:16px; animation:weatherBob 2s ease-in-out infinite alternate; display:inline-block; }
@keyframes weatherBob { 0%{transform:translateY(0)} 100%{transform:translateY(-2px)} }

#coins-box {
  position:absolute; right:26px; top:9px;
  background:rgba(0,0,0,.5); border:1px solid #a07020; border-radius:4px;
  padding:4px 10px; font-family:'Neucha',cursive; font-size:14px; color:var(--coin);
  display:flex; align-items:center; gap:5px; text-shadow:0 1px 3px rgba(0,0,0,.8); z-index:5;
}
.coin-spin {
  font-size:16px; animation:coinSpin 4s ease-in-out infinite;
  display:inline-block; transform-style:preserve-3d;
}
@keyframes coinSpin {
  0%,40%{transform:rotateY(0)}
  50%{transform:rotateY(180deg)}
  60%,100%{transform:rotateY(360deg)}
}

/* ENERGY */
#energybar {
  position:absolute; top:46px; left:0; right:0; height:8px;
  background:rgba(0,0,0,.6); z-index:200; border-bottom:1px solid var(--wood-dark);
}
#energyfill {
  height:100%; width:65%;
  background:linear-gradient(to right,#1e5010,#4aaa20,#90e840);
  transition:width .5s; box-shadow:0 0 7px rgba(80,200,40,.5);
}

/* ============================================================
   FISHING SCENE â€” full screen from 54px to navtabs (640px)
   ============================================================ */
#fishing-screen {
  top:0; bottom:0; left:0; right:0;
  display:none; padding-bottom:0; /* custom layout */
}
#fishing-screen.active { display:block; }

/* SKY */
#sky {
  position:absolute;
  top:54px; left:0; right:0; bottom:42%;
  background:linear-gradient(to bottom, var(--sky-top) 0%, var(--sky-bot) 100%);
  transition:background var(--wtrans);
}
#sky-overlay {
  position:absolute; inset:0;
  background:var(--amb-light);
  transition:background var(--wtrans);
  pointer-events:none;
}

/* Stars container */
#stars { position:absolute; inset:0; pointer-events:none; }
.star {
  position:absolute; background:#fff; border-radius:50%;
  animation:twinkle var(--d,3s) ease-in-out infinite alternate;
  animation-delay:var(--delay,0s);
  transition:opacity 3s;
}
@keyframes twinkle { 0%{opacity:.15;transform:scale(.8)} 100%{opacity:1;transform:scale(1.3)} }

/* Moon */
#moon {
  position:absolute; top:20px; right:60px;
  transition:opacity 3s, top 4s;
}
#moon-circle {
  width:36px; height:36px;
  background:radial-gradient(circle at 40% 35%,#fffae0,#e8cc70,#b89030);
  border-radius:50%;
  box-shadow:0 0 25px rgba(220,180,60,.6),0 0 50px rgba(220,180,60,.2);
  animation:moonGlow 4s ease-in-out infinite alternate;
}
#moon-shadow { position:absolute; top:3px; left:11px; width:28px; height:28px; background:rgba(6,14,10,.6); border-radius:50%; }
@keyframes moonGlow {
  0%{box-shadow:0 0 18px rgba(220,180,60,.4),0 0 35px rgba(220,180,60,.15)}
  100%{box-shadow:0 0 30px rgba(220,180,60,.8),0 0 60px rgba(220,180,60,.35)}
}

/* Sun */
#sun {
  position:absolute; top:30px; left:60px;
  width:40px; height:40px;
  opacity:0; transition:opacity 3s, top 4s, left 4s;
}
#sun-circle {
  width:40px; height:40px;
  background:radial-gradient(circle at 40% 35%,#fff5a0,#ffd040,#ff8820);
  border-radius:50%;
  box-shadow:0 0 30px rgba(255,200,50,.8),0 0 70px rgba(255,160,30,.4);
  animation:sunPulse 5s ease-in-out infinite alternate;
}
#sun-rays {
  position:absolute; inset:-14px;
  animation:sunRotate 20s linear infinite;
}
#sun-rays::before, #sun-rays::after {
  content:''; position:absolute; left:50%; top:0;
  width:3px; height:14px; margin-left:-1.5px;
  background:rgba(255,200,50,.5); border-radius:2px;
  transform-origin:1.5px 34px;
}
#sun-rays::after { transform:rotate(45deg); }
@keyframes sunPulse {
  0%{box-shadow:0 0 25px rgba(255,200,50,.7),0 0 60px rgba(255,160,30,.3)}
  100%{box-shadow:0 0 40px rgba(255,220,60,.9),0 0 90px rgba(255,180,40,.5)}
}
@keyframes sunRotate { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }

/* Extra sun rays via canvas-less approach */
.sun-ray {
  position:absolute; left:50%; top:50%;
  width:3px; height:18px;
  background:rgba(255,210,50,.4); border-radius:2px;
  transform-origin:1.5px -20px;
}

/* Clouds */
#clouds { position:absolute; inset:0; pointer-events:none; overflow:hidden; }
.cloud {
  position:absolute;
  background:rgba(200,220,240,.12);
  border-radius:50%;
  filter:blur(6px);
  animation:cloudDrift var(--cd,30s) linear infinite;
  animation-delay:var(--cdelay,0s);
  transition:opacity 3s;
}
@keyframes cloudDrift {
  0%{transform:translateX(-120px)}
  100%{transform:translateX(460px)}
}

/* Rain */
#rain-canvas {
  position:absolute; inset:0; pointer-events:none;
  opacity:0; transition:opacity 2s; z-index:8;
}

/* Mountains */
#mountains {
  position:absolute;
  bottom:0; left:0; right:0; height:200px;
  pointer-events:none;
}

/* Forest */
#forest {
  position:absolute;
  bottom:0; left:0; right:0; height:95px;
  overflow:hidden; pointer-events:none;
}
#forest svg { position:absolute; bottom:0; width:100%; height:95px; }

/* WATER */
#water {
  position:absolute;
  top:auto; bottom:60px; left:0; right:0;
  height:58%; /* water zone */
  overflow:hidden;
}
#water-bg {
  position:absolute; inset:0;
  background:linear-gradient(to bottom, var(--water-top) 0%, var(--water-bot) 100%);
  transition:background var(--wtrans);
}
#water-lines {
  position:absolute; inset:0;
  background:repeating-linear-gradient(to bottom,transparent 0,transparent 5px,rgba(25,90,50,.08) 5px,rgba(25,90,50,.08) 6px);
  animation:waterFlow 7s linear infinite;
}
@keyframes waterFlow { 0%{transform:translateY(0)} 100%{transform:translateY(6px)} }
#moon-reflection {
  position:absolute; top:4%; left:50%; transform:translateX(-28%);
  width:65px; height:130px;
  background:linear-gradient(to bottom,rgba(200,160,40,.4) 0%,rgba(200,160,40,.08) 60%,transparent 100%);
  border-radius:50%; filter:blur(5px);
  animation:reflWaver 3s ease-in-out infinite alternate;
  transition:opacity 3s;
}
#sun-reflection {
  position:absolute; top:3%; left:30%; transform:translateX(-20%);
  width:80px; height:150px;
  background:linear-gradient(to bottom,rgba(255,200,50,.35) 0%,rgba(255,180,30,.08) 60%,transparent 100%);
  border-radius:50%; filter:blur(6px);
  animation:reflWaver 4s ease-in-out infinite alternate;
  opacity:0; transition:opacity 3s;
}
@keyframes reflWaver {
  0%{transform:translateX(-20%) scaleX(1);opacity:.7}
  100%{transform:translateX(-20%) scaleX(1.4);opacity:1}
}
#water-shimmer {
  position:absolute; top:0; left:0; right:0; height:5px;
  background:linear-gradient(to right,transparent 0%,rgba(50,160,90,.35) 30%,rgba(110,210,140,.55) 50%,rgba(50,160,90,.35) 70%,transparent 100%);
  animation:shimmerMove 4s ease-in-out infinite alternate;
}
@keyframes shimmerMove { 0%{opacity:.4;transform:scaleX(.9)} 100%{opacity:1;transform:scaleX(1.05)} }

/* Fog */
#fog {
  position:absolute; bottom:60px; left:0; right:0; height:40%;
  background:linear-gradient(to top,rgba(150,180,160,.15) 0%,transparent 100%);
  pointer-events:none; opacity:0; transition:opacity 3s; z-index:9;
}

/* Swimming fish shadows */
.swimming-fish {
  position:absolute; pointer-events:none;
  animation:swimAcross var(--sd,12s) linear infinite;
  animation-delay:var(--sdelay,0s);
  opacity:.3;
}
@keyframes swimAcross {
  0%{transform:translateX(-60px) scaleX(1)}
  49%{transform:translateX(430px) scaleX(1)}
  50%{transform:translateX(430px) scaleX(-1)}
  100%{transform:translateX(-60px) scaleX(-1)}
}

/* Lily pads */
.lily { position:absolute; animation:lilyWobble 4s ease-in-out infinite alternate; pointer-events:none; }
@keyframes lilyWobble { 0%{transform:rotate(-3deg)} 100%{transform:rotate(3deg)} }

/* Fireflies */
.firefly {
  position:absolute; width:3px; height:3px; border-radius:50%;
  background:rgba(160,255,80,.9); box-shadow:0 0 6px rgba(160,255,80,.8);
  animation:fireflyFloat var(--fd,5s) ease-in-out infinite;
  animation-delay:var(--fdelay,0s);
  transition:opacity 3s;
}
@keyframes fireflyFloat {
  0%{transform:translate(0,0);opacity:.1}
  25%{transform:translate(var(--fx,10px),var(--fy,-8px));opacity:1}
  50%{transform:translate(var(--fx2,-5px),var(--fy2,-15px));opacity:.2}
  75%{transform:translate(var(--fx3,8px),var(--fy3,-5px));opacity:.9}
  100%{transform:translate(0,0);opacity:.1}
}

/* Birds */
.bird {
  position:absolute; font-size:14px; opacity:.5;
  animation:birdFly var(--bd,22s) linear infinite;
  animation-delay:var(--bdelay,0s);
  transition:opacity 3s;
}
@keyframes birdFly { 0%{transform:translateX(-40px)} 100%{transform:translateX(420px)} }

/* ============================================================
   DOCK
   ============================================================ */
#dock { position:absolute; bottom:60px; right:0; width:90px; height:75%; z-index:10; pointer-events:none; }
#dock svg { width:90px; height:100%; }

/* ============================================================
   FISHING ROD
   ============================================================ */
#rod-wrapper {
  position:absolute; bottom:60px; right:18px;
  width:35px; height:85%; z-index:15; pointer-events:none;
  transform-origin:bottom center;
}
#rod-body {
  position:absolute; bottom:0; right:6px; width:7px; height:93%;
  background:linear-gradient(to right,#2e1804,#7a4e20,#4e2e10,#2e1804);
  border-radius:3px 2px 0 0; transform-origin:bottom center;
  box-shadow:2px 0 4px rgba(0,0,0,.5);
  transition:transform .3s ease-out;
}
#rod-body.casting { animation:rodCast .55s ease-out forwards; }
@keyframes rodCast {
  0%{transform:rotate(0deg)}
  25%{transform:rotate(50deg)}
  60%{transform:rotate(-18deg)}
  100%{transform:rotate(-8deg)}
}
.rod-ring { position:absolute; right:-3px; width:13px; height:3px; background:linear-gradient(to right,#888,#ccc,#888); border-radius:2px; }
#rod-reel { position:absolute; bottom:22%; right:-2px; width:30px; height:22px; }
#rod-reel svg { transition:transform .1s; }
#rod-reel svg.spinning { animation:reelSpin .25s linear infinite; }
@keyframes reelSpin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }

/* ROD 2 */
#rod-wrapper2 {
  position:absolute; bottom:60px; left:18px;
  width:35px; height:85%; z-index:15; pointer-events:none;
  transform-origin:bottom center; transform:scaleX(-1);
}
#rod-body2 {
  position:absolute; bottom:0; left:6px; width:7px; height:93%;
  background:linear-gradient(to right,#2e1804,#60a040,#3e2810,#2e1804);
  border-radius:3px 2px 0 0; transform-origin:bottom center;
  box-shadow:2px 0 4px rgba(0,0,0,.5);
}


#linecanvas { position:absolute; top:54px; left:0; width:100%; bottom:60px; pointer-events:none; z-index:16; }

/* ============================================================
   BOBBER
   ============================================================ */
#bobber-wrap {
  position:absolute; width:20px; height:48px;
  display:none; z-index:20;
  transform:translate(-50%,-50%); pointer-events:none;
}
#bobber-top {
  width:10px; height:28px; margin:0 auto;
  background:linear-gradient(to right,#aa1010,#ee2222,#aa1010);
  border-radius:5px 5px 2px 2px;
  box-shadow:0 0 6px rgba(200,20,20,.5); position:relative;
}
#bobber-antenna {
  position:absolute; top:-13px; left:50%; transform:translateX(-50%);
  width:2px; height:14px; background:linear-gradient(to bottom,#888,#555); border-radius:1px;
}
#bobber-antenna::after {
  content:''; position:absolute; top:-3px; left:-2px; width:6px; height:6px;
  background:radial-gradient(circle at 40% 35%,#ff6666,#cc0000);
  border-radius:50%; box-shadow:0 0 5px rgba(255,50,50,.9);
}
#bobber-bottom {
  width:10px; height:20px; margin:0 auto;
  background:linear-gradient(to right,#aa8800,#ffdd00,#aa8800);
  border-radius:2px 2px 5px 5px; box-shadow:0 0 4px rgba(200,160,0,.4);
}
#bobber-ring {
  position:absolute; bottom:10px; left:50%; transform:translateX(-50%);
  width:28px; height:8px; border-radius:50%; border:1px solid rgba(80,200,120,.4);
}
@keyframes floatBob {
  0%{transform:translate(-50%,-50%) translateY(0)}
  50%{transform:translate(-50%,-50%) translateY(-5px)}
  100%{transform:translate(-50%,-50%) translateY(0)}
}
@keyframes floatBite {
  0%{transform:translate(-50%,-50%) translateY(0)}
  15%{transform:translate(-50%,-50%) translateY(22px)}
  30%{transform:translate(-50%,-50%) translateY(-5px)}
  50%{transform:translate(-50%,-50%) translateY(18px)}
  65%{transform:translate(-50%,-50%) translateY(-4px)}
  100%{transform:translate(-50%,-50%) translateY(16px)}
}

/* Ripples */
.ripple {
  position:absolute; border-radius:50%; pointer-events:none;
  border:1px solid rgba(60,180,100,.5);
  animation:rippleOut 1.8s ease-out forwards;
  transform:translate(-50%,-60%) scale(0);
}
@keyframes rippleOut {
  0%{transform:translate(-50%,-60%) scale(0);opacity:.8}
  100%{transform:translate(-50%,-60%) scale(1);opacity:0}
}

/* ============================================================
   STATS OVERLAY (fishing screen)
   ============================================================ */
#stats {
  position:absolute; top:60px; left:8px; z-index:80; pointer-events:none;
}
.stat-plank {
  background:
    repeating-linear-gradient(90deg,transparent 0,transparent 14px,rgba(0,0,0,.06) 14px,rgba(0,0,0,.06) 15px),
    linear-gradient(to bottom,var(--plank),var(--wood-mid));
  border:2px solid var(--wood-dark); border-radius:4px;
  padding:4px 10px; margin-bottom:5px;
  font-family:'Neucha',cursive; font-size:13px; color:#f0d898;
  text-shadow:0 1px 2px rgba(0,0,0,.7); box-shadow:1px 2px 4px rgba(0,0,0,.5);
  position:relative;
}
.stat-plank::before,.stat-plank::after {
  content:''; position:absolute; top:50%; transform:translateY(-50%);
  width:5px; height:5px; background:radial-gradient(circle at 35% 35%,#bbb,#555); border-radius:50%;
}
.stat-plank::before{left:3px;} .stat-plank::after{right:3px;}

/* WEATHER BADGE */
#weather-badge {
  position:absolute; top:60px; right:8px; z-index:80;
  background:rgba(0,0,0,.45); border:1px solid var(--wood-mid);
  border-radius:8px; padding:4px 8px;
  font-family:'Neucha',cursive; font-size:11px; color:#c8d0b0;
  text-align:center; pointer-events:none;
  animation:badgePop .4s ease-out;
}
@keyframes badgePop { 0%{transform:scale(0)} 60%{transform:scale(1.1)} 100%{transform:scale(1)} }

/* ROD NAME */
#current-rod-name {
  position:absolute; bottom:145px; left:50%; transform:translateX(-50%);
  font-family:'Neucha',cursive; font-size:11px; color:#c8a060;
  text-shadow:0 1px 2px rgba(0,0,0,.8); white-space:nowrap; z-index:201; pointer-events:none;
}

/* CAST HINT */
#cast-hint {
  position:absolute; bottom:148px; left:50%; transform:translateX(-50%);
  font-family:'Neucha',cursive; font-size:14px; color:rgba(200,180,120,.85);
  text-shadow:0 1px 3px rgba(0,0,0,.9); white-space:nowrap;
  pointer-events:none; z-index:50;
  animation:hintPulse 2s ease-in-out infinite alternate;
}
@keyframes hintPulse { 0%{opacity:.35} 100%{opacity:1} }

/* BITE INDICATOR */
#bite-indicator {
  position:absolute; top:66px; left:50%;
  transform:translateX(-50%) scale(0); z-index:150; cursor:pointer;
  transition:transform .25s cubic-bezier(0.34,1.56,0.64,1);
}
#bite-indicator.visible { transform:translateX(-50%) scale(1); }
#bite-plank {
  background:
    repeating-linear-gradient(90deg,transparent 0,transparent 12px,rgba(0,0,0,.06) 12px,rgba(0,0,0,.06) 13px),
    linear-gradient(to bottom,#c04010,#902808);
  border:2px solid #601a04; border-radius:6px;
  padding:8px 20px; font-family:'Neucha',cursive; font-size:17px; color:#ffe0a0;
  text-shadow:0 1px 3px rgba(0,0,0,.8);
  box-shadow:0 4px 12px rgba(0,0,0,.6),0 0 20px rgba(200,50,10,.4);
  animation:biteShake .4s ease-in-out infinite alternate; letter-spacing:1px;
}
@keyframes biteShake {
  0%{transform:rotate(-1.5deg);box-shadow:0 4px 12px rgba(0,0,0,.6),0 0 20px rgba(200,50,10,.4)}
  100%{transform:rotate(1.5deg);box-shadow:0 4px 12px rgba(0,0,0,.6),0 0 38px rgba(200,80,10,.9)}
}

/* Score pop */
.score-pop {
  position:absolute; font-family:'Neucha',cursive; font-size:18px;
  color:var(--accent-gold); text-shadow:0 2px 4px rgba(0,0,0,.8);
  pointer-events:none; z-index:100; animation:scoreFly 1.8s ease-out forwards;
}
@keyframes scoreFly {
  0%{opacity:1;transform:translateY(0) scale(1)}
  100%{opacity:0;transform:translateY(-70px) scale(1.5)}
}

/* ============================================================
   TOOLBAR (fishing screen)
   ============================================================ */
#toolbar {
  position:absolute; bottom:60px; left:0; right:0; height:80px;
  z-index:200; overflow:hidden; display:flex; align-items:center; justify-content:center; gap:16px;
}
#toolbar-bg {
  position:absolute; inset:0;
  background:
    repeating-linear-gradient(90deg,transparent 0,transparent 22px,rgba(0,0,0,.07) 22px,rgba(0,0,0,.07) 24px),
    linear-gradient(to bottom,var(--plank),var(--wood-mid));
  border-top:3px solid var(--wood-dark); border-bottom:2px solid var(--wood-dark);
}
#toolbar-bg::after {
  content:''; position:absolute; inset:0;
  background:repeating-linear-gradient(178deg,transparent 0,transparent 8px,rgba(0,0,0,.03) 8px,rgba(0,0,0,.03) 9px);
}
.tnail { position:absolute; width:10px; height:10px; background:radial-gradient(circle at 35% 35%,#bbb,#444); border-radius:50%; border:1px solid #222; top:10px; z-index:5; }

.tool-btn { width:58px; height:58px; border-radius:50%; position:relative; cursor:pointer; transition:transform .15s; z-index:2; flex-shrink:0; }
.tool-btn:active{transform:scale(.9);}
.tool-btn svg{width:58px;height:58px;}
.tool-btn-ring { position:absolute; inset:-4px; border-radius:50%; border:3px solid var(--wood-dark); pointer-events:none; transition:border-color .2s,box-shadow .2s; }
.tool-btn.active .tool-btn-ring { border-color:#80cc30; box-shadow:0 0 14px rgba(100,220,40,.7); }

/* Animated tool icons */
@keyframes toolWiggle { 0%,100%{transform:rotate(0)} 25%{transform:rotate(-8deg)} 75%{transform:rotate(8deg)} }
@keyframes toolBounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-4px)} }
@keyframes toolSpin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
@keyframes toolPulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.12)} }
@keyframes toolShine { 0%,100%{filter:brightness(1)} 50%{filter:brightness(1.4)} }

.tool-icon-rod { animation:toolWiggle 3s ease-in-out infinite; transform-origin:bottom center; }
.tool-icon-bait { animation:toolBounce 1.8s ease-in-out infinite; }
.tool-icon-lure { animation:toolSpin 5s linear infinite; }

/* ============================================================
   CATCH POPUP
   ============================================================ */
#catch-popup {
  position:absolute; top:50%; left:50%;
  transform:translate(-50%,-50%) scale(0) rotate(-5deg);
  z-index:300; transition:transform .4s cubic-bezier(0.34,1.56,0.64,1); width:250px;
}
#catch-popup.show { transform:translate(-50%,-50%) scale(1) rotate(0deg); }
#catch-board {
  background:
    repeating-linear-gradient(90deg,transparent 0,transparent 20px,rgba(0,0,0,.05) 20px,rgba(0,0,0,.05) 22px),
    linear-gradient(to bottom,var(--plank),var(--wood-mid),var(--plank));
  border:4px solid var(--wood-dark); border-radius:8px;
  padding:20px 24px 16px; box-shadow:0 8px 30px rgba(0,0,0,.9),inset 0 1px 0 rgba(255,255,255,.08);
  position:relative;
}
#catch-board::before {
  content:''; position:absolute; top:-24px; left:50%; transform:translateX(-50%);
  width:3px; height:24px; background:linear-gradient(to bottom,var(--rope),var(--wood-dark)); border-radius:2px;
}
.board-nail { position:absolute; width:9px; height:9px; background:radial-gradient(circle at 35% 35%,#bbb,#444); border-radius:50%; border:1px solid #222; }
.board-nail.tl{top:6px;left:8px;} .board-nail.tr{top:6px;right:8px;} .board-nail.bl{bottom:6px;left:8px;} .board-nail.br{bottom:6px;right:8px;}
#catch-header { font-family:'UnifrakturMaguntia',cursive; font-size:20px; color:var(--accent-gold); text-align:center; text-shadow:0 2px 4px rgba(0,0,0,.7); margin-bottom:12px; border-bottom:2px solid var(--wood-dark); padding-bottom:8px; }
#catch-fish-svg { display:block; margin:10px auto; animation:fishWigglePop .6s ease-in-out infinite alternate; }
@keyframes fishWigglePop { 0%{transform:rotate(-8deg) scaleX(1)} 100%{transform:rotate(8deg) scaleX(1.05)} }
#catch-name-txt { font-family:'Neucha',cursive; font-size:20px; color:#f5e0a0; text-align:center; text-shadow:0 1px 3px rgba(0,0,0,.7); margin-top:6px; }
#catch-weight-txt { font-family:'Neucha',cursive; font-size:13px; color:#c8b070; text-align:center; margin-top:4px; }
#catch-rarity { font-family:'Neucha',cursive; font-size:12px; text-align:center; margin-top:3px; padding:2px 8px; border-radius:8px; display:inline-block; width:100%; }
.rarity-common{color:#a8b8a0;} .rarity-rare{color:#60a8ff;} .rarity-epic{color:#d060ff;} .rarity-legend{color:#ff9030;text-shadow:0 0 10px rgba(255,140,30,.8);animation:legendGlow 1s ease-in-out infinite alternate;}
@keyframes legendGlow{0%{text-shadow:0 0 8px rgba(255,140,30,.6)}100%{text-shadow:0 0 20px rgba(255,180,50,1)}}
.catch-btns { display:flex; gap:8px; margin-top:14px; }
.catch-btn { flex:1; border:2px solid; border-radius:18px; padding:7px 10px; font-family:'Neucha',cursive; font-size:14px; cursor:pointer; text-shadow:0 1px 2px rgba(0,0,0,.6); box-shadow:0 3px 8px rgba(0,0,0,.5); transition:transform .1s; text-align:center; animation:btnPop .3s ease-out; }
@keyframes btnPop { 0%{transform:scale(0)} 60%{transform:scale(1.08)} 100%{transform:scale(1)} }
.catch-btn:active{transform:scale(.95);}
.btn-keep { background:linear-gradient(to bottom,#4a7a28,#2a5010); border-color:#1a3808; color:#d4f090; }
.btn-sell-pop { background:linear-gradient(to bottom,#7a5a18,#4a3008); border-color:#2a1808; color:#f0d060; }

/* ============================================================
   NAV TABS
   ============================================================ */
#navtabs {
  position:absolute; bottom:0; left:0; right:0; height:60px; z-index:300;
  display:flex;
}
.navtab {
  flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
  font-family:'Neucha',cursive; font-size:11px; color:#c8a050; cursor:pointer; gap:3px;
  background:
    repeating-linear-gradient(90deg,transparent 0,transparent 18px,rgba(0,0,0,.06) 18px,rgba(0,0,0,.06) 19px),
    linear-gradient(to bottom,#7a4818,#4a2808);
  border-top:3px solid var(--wood-dark); border-right:1px solid var(--wood-dark);
  transition:all .15s; position:relative; text-shadow:0 1px 2px rgba(0,0,0,.8);
}
.navtab:last-child{border-right:none;}
.navtab.active { background:repeating-linear-gradient(90deg,transparent 0,transparent 18px,rgba(0,0,0,.06) 18px,rgba(0,0,0,.06) 19px),linear-gradient(to bottom,#a06828,#6a3810); color:#f0d878; box-shadow:0 -3px 0 #d4a030 inset; }
.navtab svg { width:22px; height:22px; transition:transform .2s; }
.navtab:hover svg { transform:scale(1.15); }
.navtab.active svg { animation:navIconBounce .4s ease-out; }
@keyframes navIconBounce { 0%{transform:scale(.8)} 60%{transform:scale(1.2)} 100%{transform:scale(1)} }

/* ============================================================
   SHOP SCREEN
   ============================================================ */
#shop-screen {
  background:
    repeating-linear-gradient(90deg,transparent 0,transparent 22px,rgba(0,0,0,.04) 22px,rgba(0,0,0,.04) 24px),
    linear-gradient(to bottom,#3a1e08 0%,#1e0e04 100%);
  display:none; flex-direction:column; overflow:hidden;
  top:0; padding-bottom:0;
}
#shop-screen.active { display:flex; }
.shop-header {
  height:66px; flex-shrink:0; position:relative;
  background:
    repeating-linear-gradient(90deg,transparent 0,transparent 20px,rgba(0,0,0,.07) 20px,rgba(0,0,0,.07) 22px),
    linear-gradient(to bottom,#8a5522,#4a2808);
  border-bottom:4px solid var(--wood-dark);
  display:flex; align-items:center; justify-content:center;
}
.shop-header::before,.shop-header::after { content:''; position:absolute; bottom:-4px; width:40%; height:3px; background:linear-gradient(to right,transparent,var(--accent-gold),transparent); }
.shop-header::before{left:0;} .shop-header::after{right:0;}
.shop-title { font-family:'UnifrakturMaguntia',cursive; font-size:26px; color:var(--accent-gold); text-shadow:0 2px 6px rgba(0,0,0,.8),0 0 20px rgba(200,150,30,.4); letter-spacing:2px; animation:shopTitleGlow 3s ease-in-out infinite alternate; }
@keyframes shopTitleGlow { 0%{text-shadow:0 2px 6px rgba(0,0,0,.8),0 0 10px rgba(200,150,30,.3)} 100%{text-shadow:0 2px 6px rgba(0,0,0,.8),0 0 30px rgba(200,150,30,.7)} }

.shop-banner { flex-shrink:0; padding:8px 10px 0; display:flex; gap:6px; overflow-x:auto; scrollbar-width:none; }
.shop-banner::-webkit-scrollbar{display:none;}
.shop-tab { font-family:'Neucha',cursive; font-size:12px; padding:5px 12px; border-radius:14px; cursor:pointer; border:2px solid var(--wood-mid); color:#c8a060; white-space:nowrap; transition:all .2s; background:rgba(0,0,0,.35); flex-shrink:0; }
.shop-tab.active { background:linear-gradient(to bottom,#7a4818,#4a2808); border-color:var(--accent-gold); color:#f0d878; box-shadow:0 0 8px rgba(200,160,30,.4); }
.shop-tab:active{transform:scale(.95);}

.shop-body { flex:1; overflow-y:auto; padding:8px 10px 70px; scrollbar-width:thin; scrollbar-color:var(--wood-mid) transparent; }
.shop-body::-webkit-scrollbar{width:5px;} .shop-body::-webkit-scrollbar-thumb{background:var(--wood-mid);border-radius:3px;}

.shop-item {
  display:flex; align-items:center; gap:10px;
  background:
    repeating-linear-gradient(90deg,transparent 0,transparent 18px,rgba(0,0,0,.04) 18px,rgba(0,0,0,.04) 19px),
    linear-gradient(to bottom,rgba(90,50,15,.85),rgba(50,25,6,.95));
  border:2px solid var(--wood-dark); border-radius:8px;
  padding:9px 10px; margin-bottom:9px; position:relative; overflow:hidden;
  box-shadow:0 2px 8px rgba(0,0,0,.5);
  animation:itemSlideIn .3s ease-out;
}
@keyframes itemSlideIn { 0%{opacity:0;transform:translateX(-10px)} 100%{opacity:1;transform:translateX(0)} }
.shop-item::before { content:''; position:absolute; top:0; left:0; right:0; height:1px; background:linear-gradient(to right,transparent,rgba(200,160,60,.3),transparent); }
.shop-item.owned { border-color:#4a7a18; }
.shop-item.equipped { border-color:#80cc30; box-shadow:0 2px 8px rgba(0,0,0,.5),0 0 14px rgba(100,220,40,.35); }
.shop-item-icon { width:52px; height:52px; flex-shrink:0; display:flex; align-items:center; justify-content:center; }
.shop-item-icon svg { animation:iconFloat 2.5s ease-in-out infinite alternate; }
@keyframes iconFloat { 0%{transform:translateY(0)} 100%{transform:translateY(-4px)} }
.shop-item-icon .icon-jar svg { animation:iconSpin 6s linear infinite; }
@keyframes iconSpin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
.shop-item-info { flex:1; min-width:0; }
.shop-item-name { font-family:'Neucha',cursive; font-size:14px; color:#f0d090; text-shadow:0 1px 2px rgba(0,0,0,.7); }
.shop-item-desc { font-family:'Neucha',cursive; font-size:10px; color:#a09060; margin-top:1px; }
.shop-item-stats { font-family:'Neucha',cursive; font-size:11px; color:#80b050; margin-top:2px; }
.shop-item-price { display:flex; align-items:center; gap:4px; font-family:'Neucha',cursive; font-size:12px; color:var(--coin); margin-top:3px; }
.shop-item-btn { font-family:'Neucha',cursive; font-size:12px; padding:5px 10px; border-radius:10px; cursor:pointer; border:2px solid; flex-shrink:0; transition:transform .12s,filter .12s; text-shadow:0 1px 2px rgba(0,0,0,.6); box-shadow:0 2px 5px rgba(0,0,0,.4); white-space:nowrap; }
.shop-item-btn:active{transform:scale(.93);}
.shop-item-btn:hover{filter:brightness(1.15);}
.btn-buy-shop { background:linear-gradient(to bottom,#6a8a30,#3a5010); border-color:#2a3808; color:#d0f060; }
.btn-equip-shop { background:linear-gradient(to bottom,#3a6a20,#1a4008); border-color:#0a2804; color:#a0e060; }
.btn-owned-shop { background:rgba(0,0,0,.3); border-color:#3a3828; color:#706858; cursor:default; }
.btn-equipped-shop { background:linear-gradient(to bottom,#204a10,#103008); border-color:#80cc30; color:#80cc30; cursor:default; }

/* ============================================================
   INVENTORY SCREEN
   ============================================================ */
#inventory-screen {
  background:
    repeating-linear-gradient(90deg,transparent 0,transparent 22px,rgba(0,0,0,.04) 22px,rgba(0,0,0,.04) 24px),
    linear-gradient(to bottom,#3a1e08 0%,#1e0e04 100%);
  display:none; flex-direction:column; overflow:hidden;
  top:0; padding-bottom:0;
}
#inventory-screen.active { display:flex; }
.inv-header { height:66px; flex-shrink:0; background:repeating-linear-gradient(90deg,transparent 0,transparent 20px,rgba(0,0,0,.07) 20px,rgba(0,0,0,.07) 22px),linear-gradient(to bottom,#8a5522,#4a2808); border-bottom:4px solid var(--wood-dark); display:flex; align-items:center; justify-content:center; gap:12px; }
.inv-title { font-family:'UnifrakturMaguntia',cursive; font-size:26px; color:var(--accent-gold); text-shadow:0 2px 6px rgba(0,0,0,.8); letter-spacing:2px; }
.inv-total-badge { background:rgba(0,0,0,.45); border:1px solid var(--accent-gold); border-radius:8px; padding:3px 10px; font-family:'Neucha',cursive; font-size:12px; color:var(--coin); }
.inv-body { flex:1; overflow-y:auto; padding:10px; display:grid; grid-template-columns:repeat(3,1fr); gap:8px; align-content:start; scrollbar-width:thin; scrollbar-color:var(--wood-mid) transparent; }
.inv-body::-webkit-scrollbar{width:5px;} .inv-body::-webkit-scrollbar-thumb{background:var(--wood-mid);border-radius:3px;}
.inv-slot { background:repeating-linear-gradient(45deg,transparent 0,transparent 6px,rgba(0,0,0,.03) 6px,rgba(0,0,0,.03) 7px),rgba(30,14,4,.85); border:2px solid var(--wood-mid); border-radius:8px; padding:7px; display:flex; flex-direction:column; align-items:center; gap:3px; min-height:88px; position:relative; cursor:pointer; transition:border-color .2s,transform .1s; }
.inv-slot:active{transform:scale(.95);}
.inv-slot:hover:not(.empty){ border-color:#d4a030; }
.inv-slot.empty { opacity:.4; cursor:default; }
.inv-fish-name { font-family:'Neucha',cursive; font-size:11px; color:#d4b060; text-align:center; text-shadow:0 1px 2px rgba(0,0,0,.7); line-height:1.2; }
.inv-fish-weight { font-family:'Neucha',cursive; font-size:10px; color:#908060; text-align:center; }
.inv-coins-small { font-family:'Neucha',cursive; font-size:10px; color:var(--coin); text-align:center; }
.inv-fish-svg { animation:fishSlot 2s ease-in-out infinite alternate; display:block; }
@keyframes fishSlot { 0%{transform:rotate(-5deg)} 100%{transform:rotate(5deg)} }
.sell-all-btn { margin:10px; background:linear-gradient(to bottom,#8a5a18,#5a3008); border:2px solid #3a1808; border-radius:18px; padding:10px; font-family:'Neucha',cursive; font-size:15px; color:#f0d060; text-align:center; cursor:pointer; text-shadow:0 1px 3px rgba(0,0,0,.7); box-shadow:0 3px 10px rgba(0,0,0,.5); transition:transform .1s,filter .1s; flex-shrink:0; animation:sellBtnGlow 2s ease-in-out infinite alternate; }
.sell-all-btn:active{transform:scale(.95);}
@keyframes sellBtnGlow { 0%{box-shadow:0 3px 10px rgba(0,0,0,.5)} 100%{box-shadow:0 3px 14px rgba(200,150,30,.5)} }

/* ============================================================
   MULTIPLAYER / ONLINE SCREEN
   ============================================================ */
#multi-screen {
  background:linear-gradient(to bottom,#080c20 0%,#040810 100%);
  display:none; flex-direction:column; align-items:flex-start;
  overflow:hidden; overflow-y:auto; top:0; padding-bottom:60px; padding-top:54px;
}
#multi-screen.active { display:flex; }
.multi-header { width:100%; padding:12px 16px 6px; font-family:'UnifrakturMaguntia',cursive; font-size:22px; color:#8090ff; text-shadow:0 0 16px rgba(100,120,255,.7); }
.multi-section { width:100%; padding:8px 16px; }
.multi-section-title { font-family:'Neucha',cursive; font-size:13px; color:#5060a0; margin-bottom:6px; text-transform:uppercase; letter-spacing:1px; }
.multi-toggle-row { display:flex; align-items:center; justify-content:space-between; background:rgba(80,100,255,.1); border:1.5px solid rgba(100,120,255,.2); border-radius:12px; padding:12px 14px; margin-bottom:8px; }
.multi-toggle-label { font-family:'Neucha',cursive; font-size:14px; color:#9090d0; }
.multi-toggle-desc { font-family:'Neucha',cursive; font-size:11px; color:#4050a0; margin-top:2px; }
.toggle-switch { position:relative; width:44px; height:24px; flex-shrink:0; }
.toggle-switch input { opacity:0; width:0; height:0; }
.toggle-slider { position:absolute; cursor:pointer; inset:0; background:#1a1a3a; border-radius:24px; border:1.5px solid #3040a0; transition:.3s; }
.toggle-slider:before { content:''; position:absolute; height:18px; width:18px; left:2px; bottom:2px; background:#4050a0; border-radius:50%; transition:.3s; }
.toggle-switch input:checked + .toggle-slider { background:rgba(80,140,255,.3); border-color:#6080ff; }
.toggle-switch input:checked + .toggle-slider:before { transform:translateX(20px); background:#6080ff; box-shadow:0 0 8px rgba(100,150,255,.8); }
.multi-player-card { display:flex; align-items:center; gap:10px; background:rgba(50,70,180,.12); border:1.5px solid rgba(80,110,255,.2); border-radius:12px; padding:10px 14px; margin-bottom:8px; }
.player-avatar { width:36px; height:36px; border-radius:50%; background:linear-gradient(135deg,#4060c0,#8090ff); display:flex; align-items:center; justify-content:center; font-size:18px; border:2px solid rgba(100,140,255,.4); }
.player-info { flex:1; }
.player-name { font-family:'Neucha',cursive; font-size:14px; color:#b0b8f0; }
.player-status { font-family:'Neucha',cursive; font-size:11px; color:#5060a0; margin-top:1px; }
.player-location-badge { font-family:'Neucha',cursive; font-size:10px; color:#7080d0; background:rgba(80,100,255,.15); border-radius:8px; padding:2px 8px; display:flex; align-items:center; gap:4px; }
.multi-fish-parade { position:absolute; bottom:70px; left:0; right:0; height:55px; overflow:hidden; }
.multi-shared-stats { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; margin-bottom:8px; }
.shared-stat { background:rgba(80,100,200,.12); border:1.5px solid rgba(100,120,255,.15); border-radius:10px; padding:8px; text-align:center; }
.shared-stat-val { font-family:'UnifrakturMaguntia',cursive; font-size:18px; color:#8090e0; }
.shared-stat-lbl { font-family:'Neucha',cursive; font-size:10px; color:#4050a0; }
.multi-room-input { display:flex; gap:8px; margin-bottom:8px; }
.multi-room-input input { flex:1; background:rgba(30,40,100,.5); border:1.5px solid #3040a0; border-radius:10px; padding:8px 12px; font-family:'Neucha',cursive; font-size:13px; color:#9090d0; outline:none; }
.multi-room-input input::placeholder { color:#303870; }
.multi-btn { background:linear-gradient(135deg,rgba(80,100,255,.3),rgba(50,70,200,.4)); border:1.5px solid #5060d0; border-radius:10px; padding:8px 16px; font-family:'Neucha',cursive; font-size:13px; color:#9090e0; cursor:pointer; transition:.2s; }
.multi-btn:active { background:rgba(80,100,255,.5); }
.multi-session-id { font-family:'Neucha',cursive; font-size:11px; color:#3040a0; text-align:center; margin-top:4px; }

/* ============================================================
   GARDEN SCREEN
   ============================================================ */
#garden-screen {
  top:0; bottom:0; left:0; right:0;
  display:none; padding-bottom:0;
  background:#000;
}
#garden-screen.active { display:block; }

/* Scene layers */
.garden-scene { position:absolute; inset:0; transition:opacity .7s; }

/* Garden main view */
#gscene-garden {
  background:linear-gradient(to bottom, #1a3a0a 0%, #0a2005 100%);
  overflow:hidden;
}
.gdn-sky {
  position:absolute; top:0; left:0; right:0; height:200px;
  background:linear-gradient(to bottom,#1a3a70 0%,#2a6040 100%);
}
.gdn-ground {
  position:absolute; bottom:60px; left:0; right:0; height:320px;
  background:linear-gradient(to bottom,#2a5015 0%,#1a3a0a 100%);
}
.gdn-path {
  position:absolute; bottom:60px; left:50%; transform:translateX(-50%);
  width:70px; height:340px;
  background:repeating-linear-gradient(to bottom, #8a6030 0, #6a4818 12px, #7a5520 12px, #8a6030 24px);
  border-left:3px solid #5a3808; border-right:3px solid #5a3808;
  cursor:pointer; z-index:5;
}
.gdn-path:active { filter:brightness(1.2); }
.gdn-path-label { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-family:'Neucha',cursive; font-size:11px; color:rgba(255,220,150,.7); text-align:center; pointer-events:none; white-space:nowrap; }
.gdn-tree { position:absolute; bottom:60px; pointer-events:none; }
.gdn-tree-trunk { width:14px; height:50px; background:linear-gradient(to right,#3a1e08,#7a4a18,#3a1e08); border-radius:4px 4px 2px 2px; margin:0 auto; }
.gdn-tree-top { width:60px; height:70px; background:radial-gradient(circle at 50% 60%,#2a6a10,#0e3808); border-radius:50% 50% 40% 40%; margin:0 auto; transform:translateY(8px); }
.gdn-flower-bed { position:absolute; bottom:60px; display:flex; flex-wrap:wrap; gap:4px; padding:6px; z-index:3; }
.gdn-plot { width:55px; height:55px; border:2px solid #3a2008; border-radius:8px; display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; transition:.15s; position:relative; }
.gdn-plot.empty { background:rgba(40,20,5,.6); }
.gdn-plot.seeded { background:rgba(30,60,10,.6); }
.gdn-plot.growing { background:rgba(20,60,15,.7); }
.gdn-plot.ready { background:rgba(20,80,20,.8); box-shadow:0 0 8px rgba(80,200,60,.4); }
.gdn-plot:active { filter:brightness(1.3); }
.gdn-plot-icon { font-size:26px; }
.gdn-plot-label { font-family:'Neucha',cursive; font-size:9px; color:rgba(200,255,150,.7); }
.gdn-progress { position:absolute; bottom:2px; left:3px; right:3px; height:3px; background:rgba(0,0,0,.4); border-radius:2px; overflow:hidden; }
.gdn-progress-fill { height:100%; background:linear-gradient(to right,#40a020,#80e040); border-radius:2px; transition:width .5s; }

/* Road scene (walking animation) */
/* SHOP BUILDING â€” fixed layout */
.shop-building {
  position:absolute; top:54px; left:50%; transform:translateX(-50%);
  width:160px; text-align:center; z-index:5;
}
.shop-roof-wrap {
  width:180px; margin:0 auto;
}
.shop-chimney {
  width:18px; height:24px;
  background:linear-gradient(to right,#6a3010,#9a5020,#6a3010);
  border:2px solid #4a2008; border-radius:3px 3px 0 0;
  margin:0 0 -3px 110px; position:relative; z-index:2;
}
.shop-chimney::after {
  content:'ðŸ’¨'; position:absolute; top:-18px; left:50%; transform:translateX(-50%);
  font-size:12px; opacity:0.7; animation:chimneySmoke 3s ease-in-out infinite;
}
@keyframes chimneySmoke { 0%,100%{opacity:.3;transform:translateX(-50%) translateY(0)} 50%{opacity:.8;transform:translateX(-50%) translateY(-6px)} }
.shop-roof-svg { width:180px; height:60px; display:block; filter:drop-shadow(0 4px 6px rgba(0,0,0,.5)); }
.shop-walls {
  background:linear-gradient(160deg, #e8c880 0%, #c8a050 40%, #a07838 100%);
  width:160px; height:100px; border-radius:4px 4px 0 0;
  margin:0 auto; position:relative;
  border:3px solid #6a4010; border-bottom:none;
  box-shadow:inset -8px 0 16px rgba(0,0,0,.2), inset 0 -8px 16px rgba(0,0,0,.1);
}
/* Wood plank texture on walls */
.shop-walls::before {
  content:''; position:absolute; inset:0;
  background:repeating-linear-gradient(to bottom, transparent 0, transparent 14px, rgba(0,0,0,.06) 14px, rgba(0,0,0,.06) 15px);
  border-radius:2px 2px 0 0;
}
.shop-walls-base {
  width:168px; height:12px; margin:0 auto;
  background:linear-gradient(to bottom,#6a4010,#4a2808);
  border:2px solid #3a1806; border-top:none;
}
.shop-door {
  position:absolute; bottom:0; left:50%; transform:translateX(-50%);
  width:36px; height:52px;
  background:linear-gradient(160deg,#7a4020,#4a2008);
  border-radius:6px 6px 0 0; cursor:pointer; transition:.3s;
  border:2px solid #3a1806; border-bottom:none;
  box-shadow:inset -3px 0 6px rgba(0,0,0,.3);
}
.shop-door::after {
  content:''; position:absolute; right:5px; top:50%; transform:translateY(-50%);
  width:5px; height:5px; border-radius:50%; background:#c8a040;
  box-shadow:0 0 4px rgba(200,160,40,.6);
}
.shop-door.open { transform:translateX(-50%) perspective(200px) rotateY(-75deg); transform-origin:left center; }
.shop-window {
  position:absolute; top:16px; width:30px; height:28px;
  background:linear-gradient(135deg,rgba(180,220,255,.7),rgba(140,180,220,.4));
  border:2px solid #7a5020; border-radius:4px;
  box-shadow:inset 0 0 8px rgba(150,200,255,.3);
}
.shop-window::after {
  content:''; position:absolute; inset:2px;
  background:linear-gradient(135deg,rgba(255,255,255,.3) 0%,transparent 60%);
}
.shop-window.cross::before {
  content:''; position:absolute; inset:0;
  background:linear-gradient(to right,transparent 45%,#7a5020 45%,#7a5020 55%,transparent 55%),
             linear-gradient(to bottom,transparent 45%,#7a5020 45%,#7a5020 55%,transparent 55%);
}
.shop-window.left { left:16px; }
.shop-window.right { right:16px; }
.shop-sign {
  font-family:'Neucha',cursive; font-size:13px; color:#f0d880;
  text-shadow:1px 1px 2px rgba(0,0,0,.8);
  margin:0 auto 6px; background:rgba(60,30,5,.9);
  padding:4px 12px; border-radius:6px;
  border:1.5px solid #8a6020; display:inline-block;
  box-shadow:0 2px 6px rgba(0,0,0,.5);
}
/* Ground / grass under building */
.shop-ground {
  position:absolute; bottom:60px; left:0; right:0; height:80px;
  background:linear-gradient(to bottom,#2a5015,#1a3a0a);
  z-index:1;
}
.shop-ground::before {
  content:''; position:absolute; top:0; left:0; right:0; height:8px;
  background:linear-gradient(to bottom,#3a7020,#2a5015);
  border-radius:4px 4px 0 0;
}
/* Road perspective effect */
.road-path-visual {
  position:absolute; bottom:60px; left:50%; transform:translateX(-50%);
  width:80px; height:580px;
  background:repeating-linear-gradient(to bottom, #8a6030 0, #6a4818 16px, #7a5520 16px, #8a6030 32px);
  border-left:3px solid #5a3808; border-right:3px solid #5a3808;
  box-shadow:inset 2px 0 8px rgba(0,0,0,.3), inset -2px 0 8px rgba(0,0,0,.3);
  z-index:2;
}
/* Side grass strips */
.road-grass-left, .road-grass-right {
  position:absolute; top:0; bottom:60px; width:calc(50% - 43px);
  background:linear-gradient(to bottom,#1a4010,#0e2808);
}
.road-grass-left { left:0; }
.road-grass-right { right:0; }
/* Small flowers on the side */
.road-flower {
  position:absolute; font-size:14px; pointer-events:none;
  animation:roadFlowerSway 3s ease-in-out infinite alternate;
}
@keyframes roadFlowerSway { 0%{transform:rotate(-5deg)} 100%{transform:rotate(5deg)} }


/* Road scene container */
#gscene-road {
  background:linear-gradient(to bottom, #0a1a30 0%, #1a4020 50%, #0e2810 100%);
  display:none; position:absolute; inset:0;
}
#gscene-road.active-scene { display:block; }
.walker {
  position:absolute; font-size:32px; left:50%; transform:translateX(-50%);
  animation:walkBob 0.5s steps(2) infinite;
  z-index:10;
}
.walker.to-shop { animation:walkToShop 2.8s linear forwards, walkBob 0.5s steps(2) infinite; }
.walker.from-shop { animation:walkFromShop 2.2s linear forwards, walkBob 0.5s steps(2) infinite; }
@keyframes walkBob { 0%{transform:translateX(-50%) translateY(0) scaleX(1)} 50%{transform:translateX(-50%) translateY(-4px) scaleX(1)} }
@keyframes walkToShop { 0%{bottom:160px;} 100%{bottom:520px;} }
@keyframes walkFromShop { 0%{bottom:520px;} 100%{bottom:160px;} }

/* Seed shop scene */
#gscene-seedshop {
  background:linear-gradient(to bottom,#2a1a08 0%,#1a0e04 100%);
  display:flex; flex-direction:column; align-items:center; overflow-y:auto; padding-bottom:70px; padding-top:54px;
}
.seedshop-counter { background:linear-gradient(to bottom,#6a4018,#3a2008); border-radius:8px; border:3px solid #2a1004; padding:8px 12px; width:94%; margin-bottom:10px; display:flex; align-items:center; gap:8px; }
.seedshop-counter-img { font-size:32px; }
.seedshop-title { font-family:'UnifrakturMaguntia',cursive; font-size:18px; color:#f0c860; text-shadow:0 2px 6px rgba(0,0,0,.8); }
.seedshop-sub { font-family:'Neucha',cursive; font-size:11px; color:#a07040; margin-top:2px; }
.seed-pack { width:94%; background:rgba(40,25,8,.8); border:2px solid #5a3510; border-radius:12px; padding:12px; margin-bottom:10px; display:flex; gap:10px; cursor:pointer; transition:.15s; }
.seed-pack:active { background:rgba(60,40,15,.9); }
.seed-pack-left { flex-shrink:0; }
.seed-pack-bag { width:64px; height:64px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:38px; border:2px solid rgba(200,150,60,.3); }
.seed-pack-info { flex:1; }
.seed-pack-name { font-family:'Neucha',cursive; font-size:15px; color:#e0b060; margin-bottom:2px; }
.seed-pack-desc { font-family:'Neucha',cursive; font-size:11px; color:#806040; margin-bottom:4px; }
.seed-pack-flower { display:flex; align-items:center; gap:6px; margin-bottom:4px; }
.seed-pack-flower-icon { font-size:20px; }
.seed-pack-flower-desc { font-family:'Neucha',cursive; font-size:10px; color:#908060; }
.seed-pack-price { font-family:'Neucha',cursive; font-size:13px; color:#f0c040; display:flex; align-items:center; gap:4px; }
.seed-buy-btn { background:linear-gradient(to bottom,#6a8a20,#3a5010); border:2px solid #2a3808; border-radius:8px; padding:5px 12px; font-family:'Neucha',cursive; font-size:12px; color:#c0e040; cursor:pointer; margin-top:4px; display:inline-block; }
.seed-buy-btn:active { filter:brightness(1.3); }
.seed-pack-detail { display:none; }
.seed-pack.expanded .seed-pack-detail { display:block; margin-top:8px; padding-top:8px; border-top:1px solid rgba(150,100,30,.3); }

/* Scene transition overlay */
#scene-fade {
  position:absolute; inset:0; background:#000; opacity:0; pointer-events:none; z-index:100; transition:opacity .6s;
}
#scene-fade.fading { opacity:1; pointer-events:all; }

/* Garden nav indicator for multiplayer */
.nav-player-dot { position:absolute; top:2px; right:2px; width:8px; height:8px; border-radius:50%; background:#6080ff; box-shadow:0 0 4px #6080ff; display:none; }
.navtab { position:relative; }

/* ============================================================
   TOAST NOTIFICATION
   ============================================================ */
#toast {
  position:absolute; bottom:68px; left:50%;
  transform:translateX(-50%) translateY(80px);
  background:rgba(20,50,15,.95); border:2px solid #4a7a18; border-radius:20px;
  padding:8px 20px; font-family:'Neucha',cursive; font-size:13px; color:#a0f060;
  white-space:nowrap; z-index:500;
  transition:transform .4s cubic-bezier(0.34,1.56,0.64,1),opacity .4s; opacity:0;
  text-shadow:0 1px 2px rgba(0,0,0,.8);
  pointer-events:none;
}
#toast.show { transform:translateX(-50%) translateY(0); opacity:1; }

/* ============================================================
   WEATHER TIME LABEL
   ============================================================ */
#time-period-label {
  position:absolute; top:60px; left:50%; transform:translateX(-50%);
  font-family:'Neucha',cursive; font-size:12px; color:rgba(220,200,140,.7);
  pointer-events:none; z-index:50; transition:opacity 1s;
  white-space:nowrap;
}

/* ============================================================
   MISC ANIMATIONS
   ============================================================ */
@keyframes coinBurst {
  0%{transform:translate(0,0) scale(1);opacity:1}
  100%{transform:translate(var(--cx,0),var(--cy,-40px)) scale(0);opacity:0}
}
.coin-burst {
  position:absolute; font-size:16px; pointer-events:none; z-index:400;
  animation:coinBurst 1s ease-out forwards;
}

/* ============================================================
   FORTUNE WHEEL OVERLAY
   ============================================================ */
#fortune-overlay {
  position:absolute; inset:0; background:rgba(0,0,0,.85); z-index:600;
  display:none; align-items:center; justify-content:center; flex-direction:column;
}
#fortune-overlay.show { display:flex; }
#fortune-wheel-wrap { position:relative; width:260px; height:260px; }
#fortune-wheel-canvas { border-radius:50%; }
#fortune-wheel-pointer {
  position:absolute; top:-18px; left:50%; transform:translateX(-50%);
  width:0; height:0;
  border-left:14px solid transparent; border-right:14px solid transparent;
  border-top:30px solid #f0d040;
  filter:drop-shadow(0 2px 6px rgba(0,0,0,.8));
}
#fortune-spin-btn {
  margin-top:16px; padding:10px 32px;
  background:linear-gradient(135deg,#c04010,#801010);
  border:2px solid #f0d040; border-radius:20px;
  font-family:'Neucha',cursive; font-size:16px; color:#f0d040;
  cursor:pointer; text-shadow:0 1px 3px rgba(0,0,0,.8);
  box-shadow:0 4px 12px rgba(0,0,0,.6);
}
#fortune-spin-btn:active { transform:scale(.95); }
#fortune-close-btn {
  margin-top:10px; padding:6px 20px;
  background:rgba(0,0,0,.4); border:1px solid #555; border-radius:12px;
  font-family:'Neucha',cursive; font-size:13px; color:#aaa; cursor:pointer;
}
#fortune-title {
  font-family:'UnifrakturMaguntia',cursive; font-size:24px; color:#f0d040;
  text-shadow:0 0 20px rgba(240,200,50,.6); margin-bottom:12px;
}
#fortune-cost { font-family:'Neucha',cursive; font-size:12px; color:#a08040; margin-top:4px; }
#fortune-result {
  font-family:'Neucha',cursive; font-size:16px; color:#a0f060;
  margin-top:10px; min-height:24px; text-align:center;
}

/* Fortune wheel button on fishing screen */
#fortune-btn {
  position:absolute; bottom:255px; left:10px;
  background:linear-gradient(135deg,#8a3010,#501808);
  border:2px solid #f0d040; border-radius:50%; width:44px; height:44px;
  display:flex; align-items:center; justify-content:center; font-size:22px;
  cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.6);
  animation:wheelPulse 2s ease-in-out infinite alternate;
  z-index:30;
}
@keyframes wheelPulse {
  0%{box-shadow:0 2px 8px rgba(0,0,0,.6)}
  100%{box-shadow:0 2px 16px rgba(240,200,50,.5)}
}

/* ============================================================
   POKEMON MAP OVERLAY / STYLE
   ============================================================ */
/* Pokemon mode â€” overlay on water */
#poke-overlay {
  position:absolute; inset:0; pointer-events:none; z-index:6;
  transition:opacity .8s;
}
#poke-mode-badge {
  position:absolute; top:56px; left:50%; transform:translateX(-50%);
  background:linear-gradient(135deg,#3050e0,#8040c0);
  border:2px solid #f0f040; border-radius:12px; padding:3px 12px;
  font-family:'Neucha',cursive; font-size:11px; color:#f0f040;
  text-shadow:0 1px 2px rgba(0,0,0,.8); z-index:50; display:none;
  animation:pokeBadgeGlow 1.5s ease-in-out infinite alternate;
}
@keyframes pokeBadgeGlow {
  0%{box-shadow:0 0 6px rgba(100,100,255,.4)} 100%{box-shadow:0 0 18px rgba(255,100,255,.7)}
}

/* Pikachu coins display */
#pika-coins-box {
  position:absolute; right:26px; top:26px;
  background:rgba(0,0,0,.5); border:1px solid #f0d040; border-radius:4px;
  padding:3px 8px; font-family:'Neucha',cursive; font-size:12px; color:#f0e040;
  display:none; align-items:center; gap:4px; text-shadow:0 1px 3px rgba(0,0,0,.8); z-index:5;
}

/* PikaBuffs shop section */
.pikabufs-section {
  background:linear-gradient(135deg,rgba(50,50,200,.15),rgba(150,50,200,.15));
  border:2px solid rgba(150,100,255,.3); border-radius:12px;
  padding:10px; margin-bottom:10px;
}
.pikabufs-title {
  font-family:'UnifrakturMaguntia',cursive; font-size:16px; color:#c0a0ff;
  text-align:center; margin-bottom:8px; text-shadow:0 0 10px rgba(150,100,255,.5);
}

/* ============================================================
   MAP SELECTOR (Normal / Pokemon)
   ============================================================ */
#map-selector {
  position:absolute; bottom:145px; left:10px;
  background:rgba(0,0,0,.75); border:1px solid var(--wood-mid); border-radius:10px;
  padding:5px 7px; z-index:30; display:flex; flex-direction:column; gap:5px;
}
.map-btn {
  font-family:'Neucha',cursive; font-size:12px; padding:6px 10px;
  border-radius:8px; cursor:pointer; border:2px solid;
  transition:.2s; text-align:center; white-space:nowrap; min-width:80px;
}
.map-btn.active { background:rgba(200,160,30,.35); border-color:#d4a030; color:#f0d060; }
.map-btn:not(.active) { background:rgba(0,0,0,.4); border-color:#555; color:#999; }
.map-btn:active { transform:scale(.93); }

/* ============================================================
   LEADERBOARD SCREEN
   ============================================================ */
#leaderboard-screen {
  background:linear-gradient(to bottom,#08081a 0%,#04040e 100%);
  display:none; flex-direction:column; align-items:flex-start;
  overflow:hidden; overflow-y:auto; top:0; padding-bottom:60px; padding-top:54px;
}
#leaderboard-screen.active { display:flex; }
.lb-header {
  width:100%; padding:12px 16px 6px;
  font-family:'UnifrakturMaguntia',cursive; font-size:22px;
  color:#f0d040; text-shadow:0 0 16px rgba(240,200,50,.7);
}
.lb-tabs {
  display:flex; gap:8px; padding:0 16px 8px; width:100%;
}
.lb-tab {
  flex:1; text-align:center; padding:6px 8px;
  font-family:'Neucha',cursive; font-size:12px;
  border-radius:10px; cursor:pointer; border:1.5px solid;
  transition:.2s;
}
.lb-tab.active { background:rgba(240,200,50,.2); border-color:#f0d040; color:#f0d040; }
.lb-tab:not(.active) { background:rgba(0,0,0,.3); border-color:#444; color:#888; }
.lb-row {
  width:90%; margin:4px auto; display:flex; align-items:center; gap:10px;
  background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08);
  border-radius:10px; padding:8px 14px;
}
.lb-rank { font-family:'Neucha',cursive; font-size:16px; color:#f0d040; width:28px; flex-shrink:0; }
.lb-name { font-family:'Neucha',cursive; font-size:13px; color:#c0c0e0; flex:1; }
.lb-val { font-family:'Neucha',cursive; font-size:14px; color:#80e080; }
.lb-me { border-color:rgba(240,200,50,.4); background:rgba(240,200,50,.06); }

/* ============================================================
   ROAD CHOICE (Shop or Kiosk)
   ============================================================ */
#road-choice {
  position:absolute; bottom:100px; left:50%; transform:translateX(-50%);
  display:none; flex-direction:column; align-items:center; gap:10px; z-index:20;
}
.road-choice-btn {
  padding:10px 24px; font-family:'Neucha',cursive; font-size:14px;
  border-radius:14px; cursor:pointer; border:2px solid; text-align:center;
  min-width:150px; box-shadow:0 3px 10px rgba(0,0,0,.5); transition:.15s;
}
.road-choice-btn:active { transform:scale(.95); }
.road-choice-plant {
  background:linear-gradient(135deg,#2a6010,#1a3808);
  border-color:#4a8a18; color:#a0e040;
}
.road-choice-kiosk {
  background:linear-gradient(135deg,#604010,#3a2008);
  border-color:#c08020; color:#f0c040;
}

/* ============================================================
   KIOSK SCREEN
   ============================================================ */
#gscene-kiosk {
  background:linear-gradient(to bottom,#1a0a04 0%,#0e0604 100%);
  display:none; flex-direction:column; align-items:center; overflow-y:auto; padding-bottom:70px; padding-top:54px;
}
#gscene-kiosk.active-scene { display:flex; }
.kiosk-header {
  width:94%; background:linear-gradient(to bottom,#7a4010,#3a1a04);
  border-radius:8px; border:3px solid #2a0e04; padding:8px 12px;
  margin-bottom:10px; display:flex; align-items:center; gap:8px;
}
.kiosk-title { font-family:'UnifrakturMaguntia',cursive; font-size:18px; color:#f0c840; }
.kiosk-subtitle { font-family:'Neucha',cursive; font-size:11px; color:#a07040; margin-top:2px; }
.kiosk-section-title {
  font-family:'Neucha',cursive; font-size:12px; color:#a08040;
  text-transform:uppercase; letter-spacing:1px; margin:8px 0 4px; width:94%;
}
.kiosk-my-listing {
  width:94%; background:rgba(60,40,10,.6); border:2px solid #7a5010;
  border-radius:10px; padding:10px; margin-bottom:8px; display:flex; align-items:center; gap:8px;
}
.kiosk-listing-icon { font-size:28px; }
.kiosk-listing-info { flex:1; }
.kiosk-listing-name { font-family:'Neucha',cursive; font-size:13px; color:#e0b060; }
.kiosk-listing-price { font-family:'Neucha',cursive; font-size:12px; color:#f0c040; }
.kiosk-listing-btn {
  padding:6px 12px; font-family:'Neucha',cursive; font-size:11px;
  border-radius:8px; cursor:pointer; border:1.5px solid; transition:.15s;
}
.kiosk-listing-btn:active { transform:scale(.93); }
.btn-list { background:linear-gradient(135deg,#406010,#203008); border-color:#608020; color:#a0d040; }
.btn-buy-listing { background:linear-gradient(135deg,#604010,#3a2008); border-color:#a06020; color:#e0a040; }
.btn-cancel-listing { background:rgba(60,10,10,.6); border-color:#803030; color:#e06060; }
.kiosk-price-input {
  width:80px; background:rgba(30,20,5,.8); border:1.5px solid #7a5010;
  border-radius:8px; padding:5px 8px; font-family:'Neucha',cursive; font-size:13px;
  color:#e0b060; outline:none; text-align:center;
}

/* ============================================================
   ROD VISUAL UPGRADE (color on fishing screen)
   ============================================================ */
#rod-body {
  transition: filter .5s;
}

/* ============================================================
   MULTIPLAYER ROD 2 IMPROVEMENTS
   ============================================================ */
#rod-wrapper2 {
  transition:opacity .4s;
}
#rod-body2-inner {
  width:100%; height:100%; position:relative;
}

/* ============================================================
   SCORE POP & OTHER
   ============================================================ */
.score-pop {
  position:absolute; pointer-events:none; z-index:300;
  font-family:'Neucha',cursive; font-size:14px; color:#f0d040;
  text-shadow:0 1px 3px rgba(0,0,0,.8);
  animation:scorePop 1.8s ease-out forwards;
}
@keyframes scorePop {
  0%{opacity:1;transform:translateY(0) scale(1)}
  100%{opacity:0;transform:translateY(-50px) scale(1.3)}
}
</style>
<!-- Firebase compat SDK v9 â€” reliable CDN URLs, no dynamic import() needed -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<div id="game-scale-wrapper">
<div id="game">

  <!-- ===== STATUS BAR ===== -->
  <div id="statusbar">
    <div id="statusbar-bg"></div>
    <div class="s-nail tl"></div>
    <div class="s-nail tr"></div>
    <div id="time-box">
      <span id="weather-icon">ðŸŒ™</span>
      <span id="game-time">00:00</span>
    </div>
    <div id="coins-box">
      <span class="coin-spin">ðŸª™</span>
      <span id="coins-display">150</span>
    </div>
    <!-- Pika coins (pokemon mode) -->
    <div id="pika-coins-box">
      <span>âš¡</span>
      <span id="pika-coins-display">0</span>
    </div>
  </div>
  <div id="energybar"><div id="energyfill"></div></div>

  <!-- ===== FISHING SCREEN ===== -->
  <div id="fishing-screen" class="screen active">
    <!-- Sky -->
    <div id="sky">
      <div id="sky-overlay"></div>
      <div id="stars"></div>
      <div id="moon"><div id="moon-circle"></div><div id="moon-shadow"></div></div>
      <div id="sun">
        <div id="sun-circle"></div>
        <div id="sun-rays"></div>
      </div>
      <div id="clouds"></div>
    </div>
    <!-- Mountains -->
    <div id="mountains">
      <svg viewBox="0 0 360 200" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
        <polygon points="-30,200 130,0 236,200" fill="#071008"/>
        <polygon points="80,200 210,40 340,200" fill="#050c06"/>
        <polygon points="200,200 310,20 410,200" fill="#060e08"/>
        <polygon points="130,0 152,0 158,32 148,32" fill="rgba(200,220,210,.2)"/>
      </svg>
    </div>
    <!-- Forest -->
    <div id="forest">
      <svg viewBox="0 0 360 90" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
        <g id="forest-trees-back" fill="#08160a">
          <polygon points="0,90 18,18 36,90"/><polygon points="22,90 38,28 54,90"/>
          <polygon points="42,90 60,12 78,90"/><polygon points="62,90 78,25 96,90"/>
          <polygon points="80,90 98,8 116,90"/><polygon points="100,90 116,20 134,90"/>
          <polygon points="118,90 136,16 154,90"/><polygon points="138,90 154,22 172,90"/>
          <polygon points="156,90 172,10 190,90"/><polygon points="174,90 192,25 208,90"/>
          <polygon points="194,90 210,14 228,90"/><polygon points="212,90 230,20 246,90"/>
          <polygon points="232,90 248,12 266,90"/><polygon points="250,90 268,28 284,90"/>
          <polygon points="268,90 286,18 302,90"/><polygon points="288,90 304,16 322,90"/>
          <polygon points="306,90 322,22 342,90"/><polygon points="326,90 344,8 360,90"/>
        </g>
        <g id="forest-trees-front" fill="#0e2210" opacity="0.85">
          <polygon points="0,90 12,36 26,90"/><polygon points="30,90 44,28 58,90"/>
          <polygon points="58,90 74,20 90,90"/><polygon points="88,90 104,33 120,90"/>
          <polygon points="116,90 132,26 148,90"/><polygon points="148,90 164,18 180,90"/>
          <polygon points="178,90 192,30 210,90"/><polygon points="208,90 224,24 240,90"/>
          <polygon points="238,90 256,16 272,90"/><polygon points="268,90 284,28 300,90"/>
          <polygon points="296,90 314,20 330,90"/><polygon points="328,90 346,33 360,90"/>
        </g>
        <g fill="#3a2008" opacity="0.45">
          <rect x="17" y="78" width="3" height="12"/><rect x="59" y="76" width="3" height="14"/>
          <rect x="97" y="74" width="3" height="16"/><rect x="153" y="76" width="3" height="14"/>
          <rect x="209" y="74" width="3" height="16"/>
        </g>
      </svg>
    </div>
    <!-- Water -->
    <div id="water">
      <div id="water-bg"></div>
      <div id="water-lines"></div>
      <div id="moon-reflection"></div>
      <div id="sun-reflection"></div>
      <div id="water-shimmer"></div>
      <!-- Swimming fish -->
      <svg class="swimming-fish" style="bottom:28%;--sd:16s;" width="38" height="18" viewBox="0 0 38 18"><ellipse cx="16" cy="9" rx="13" ry="6" fill="rgba(80,140,70,.5)"/><polygon points="29,9 38,4 38,14" fill="rgba(80,140,70,.4)"/></svg>
      <svg class="swimming-fish" style="bottom:52%;--sd:23s;--sdelay:-9s;" width="28" height="14" viewBox="0 0 28 14"><ellipse cx="11" cy="7" rx="9" ry="4.5" fill="rgba(60,100,180,.4)"/><polygon points="20,7 28,3 28,11" fill="rgba(60,100,180,.35)"/></svg>
      <svg class="swimming-fish" style="bottom:70%;--sd:20s;--sdelay:-13s;" width="48" height="24" viewBox="0 0 48 24"><ellipse cx="20" cy="12" rx="17" ry="8.5" fill="rgba(100,60,40,.4)"/><polygon points="37,12 48,6 48,18" fill="rgba(100,60,40,.35)"/></svg>
      <!-- Lily pads -->
      <svg class="lily" style="left:13%;bottom:18%;" width="28" height="16" viewBox="0 0 28 16"><ellipse cx="14" cy="10" rx="13" ry="6" fill="#1a5a18" stroke="#0a3010" stroke-width="1"/><path d="M14,10 L14,0" stroke="#0a3010" stroke-width="1"/><circle cx="14" cy="5" r="3" fill="#e85080" opacity=".8"/></svg>
      <svg class="lily" style="right:28%;bottom:32%;animation-delay:-2s;" width="22" height="12" viewBox="0 0 22 12"><ellipse cx="11" cy="8" rx="10" ry="5" fill="#154a14" stroke="#082008" stroke-width="1"/><path d="M11,8 L11,0" stroke="#082008" stroke-width="1"/></svg>
    </div>
    <!-- Fog overlay -->
    <div id="fog"></div>
    <!-- Rain canvas -->
    <canvas id="rain-canvas"></canvas>

    <!-- Dock -->
    <div id="dock">
      <svg viewBox="0 0 90 300" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
        <defs><linearGradient id="plankG" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#2e1604"/><stop offset="30%" stop-color="#7a4e22"/><stop offset="70%" stop-color="#5a3010"/><stop offset="100%" stop-color="#2e1604"/></linearGradient></defs>
        <rect x="10" y="0" width="8" height="300" fill="url(#plankG)" rx="3"/>
        <rect x="72" y="0" width="8" height="300" fill="url(#plankG)" rx="3"/>
        <rect x="6" y="20" width="78" height="9" fill="url(#plankG)" rx="2"/>
        <rect x="6" y="58" width="78" height="9" fill="url(#plankG)" rx="2"/>
        <rect x="6" y="96" width="78" height="9" fill="url(#plankG)" rx="2"/>
        <rect x="6" y="134" width="78" height="9" fill="url(#plankG)" rx="2"/>
        <rect x="6" y="172" width="78" height="9" fill="url(#plankG)" rx="2"/>
        <rect x="6" y="210" width="78" height="9" fill="url(#plankG)" rx="2"/>
        <rect x="6" y="248" width="78" height="9" fill="url(#plankG)" rx="2"/>
        <circle cx="14" cy="24" r="2.5" fill="#888"/><circle cx="76" cy="24" r="2.5" fill="#888"/>
        <circle cx="14" cy="62" r="2.5" fill="#888"/><circle cx="76" cy="62" r="2.5" fill="#888"/>
        <circle cx="14" cy="100" r="2.5" fill="#888"/><circle cx="76" cy="100" r="2.5" fill="#888"/>
      </svg>
    </div>

    <!-- Rod -->
    <div id="rod-wrapper">
      <div id="rod-body">
        <div class="rod-ring" style="bottom:88%;"></div>
        <div class="rod-ring" style="bottom:74%;"></div>
        <div class="rod-ring" style="bottom:59%;"></div>
        <div class="rod-ring" style="bottom:44%;"></div>
        <div class="rod-ring" style="bottom:31%;"></div>
      </div>
      <div id="rod-reel">
        <svg viewBox="0 0 30 22" xmlns="http://www.w3.org/2000/svg">
          <defs><radialGradient id="reelG" cx="40%" cy="35%"><stop offset="0%" stop-color="#aaa"/><stop offset="100%" stop-color="#444"/></radialGradient></defs>
          <ellipse cx="15" cy="11" rx="13" ry="9" fill="url(#reelG)" stroke="#333" stroke-width="1.5"/>
          <ellipse cx="15" cy="11" rx="7" ry="5" fill="#555" stroke="#333" stroke-width="1"/>
          <ellipse cx="15" cy="11" rx="3" ry="2" fill="#777"/>
          <line x1="15" y1="2" x2="15" y2="20" stroke="#333" stroke-width=".5" opacity=".5"/>
          <line x1="2" y1="11" x2="28" y2="11" stroke="#333" stroke-width=".5" opacity=".5"/>
          <circle cx="22" cy="4" r="2" fill="#888" stroke="#555" stroke-width=".5"/>
        </svg>
      </div>
    </div>

    <!-- Rod 2 (multiplayer partner) -->
    <div id="rod-wrapper2" style="display:none;left:18px;right:auto;">
      <div id="rod-body2" style="left:6px;right:auto;">
        <div class="rod-ring" style="bottom:88%;"></div>
        <div class="rod-ring" style="bottom:74%;"></div>
        <div class="rod-ring" style="bottom:59%;"></div>
      </div>
    </div>

    <!-- Line canvas -->
    <canvas id="linecanvas"></canvas>
    <!-- Second line canvas (multiplayer) -->
    <canvas id="linecanvas2" style="display:none;"></canvas>
    <!-- Bobber -->
    <div id="bobber-wrap">
      <div id="bobber-top"><div id="bobber-antenna"></div></div>
      <div id="bobber-bottom"></div>
      <div id="bobber-ring"></div>
    </div>

    <!-- Stats -->
    <div id="stats">
      <div class="stat-plank">ðŸŸ <span id="fish-count">0</span></div>
      <div class="stat-plank">â­ <span id="score-val">0</span></div>
    </div>

    <!-- Weather badge -->
    <div id="weather-badge">ðŸŒ™ ÐÐ¾Ñ‡ÑŒ</div>

    <!-- Time period label -->
    <div id="time-period-label"></div>

    <!-- Current rod name -->
    <div id="current-rod-name">Ð£Ð´Ð¾Ñ‡ÐºÐ°: Ð”ÐµÑ€ÐµÐ²ÐµÐ½ÑÐºÐ°Ñ</div>

    <!-- Hint -->
    <div id="cast-hint">ÐÐ°Ð¶Ð¼Ð¸ Ð½Ð° Ð²Ð¾Ð´Ñƒ Ð´Ð»Ñ Ð·Ð°Ð±Ñ€Ð¾ÑÐ°</div>

    <!-- Pokemon mode badge -->
    <div id="poke-mode-badge">âš¡ ÐŸÐžÐšÐ•ÐœÐžÐ Ð Ð•Ð–Ð˜Ðœ</div>

    <!-- Fortune Wheel button -->
    <div id="fortune-btn" onclick="openFortune()" title="ÐšÐ¾Ð»ÐµÑÐ¾ Ð¤Ð¾Ñ€Ñ‚ÑƒÐ½Ñ‹">ðŸŽ¡</div>

    <!-- Map selector -->
    <div id="map-selector">
      <div class="map-btn active" id="map-btn-normal" onclick="setMap('normal')">ðŸŒŠ ÐžÐ±Ñ‹Ñ‡Ð½Ð°Ñ</div>
      <div class="map-btn" id="map-btn-pokemon" onclick="setMap('pokemon')">âš¡ ÐŸÐ¾ÐºÐµÐ¼Ð¾Ð½</div>
    </div>

    <!-- Bite indicator -->
    <div id="bite-indicator"><div id="bite-plank">ðŸŽ£ ÐšÐ›Ð®ÐÐ¢! ÐŸÐ¾Ð´ÑÐµÐºÐ°Ð¹!</div></div>

    <!-- Toolbar -->
    <div id="toolbar">
      <div id="toolbar-bg"></div>
      <div class="tnail" style="left:15px;"></div>
      <div class="tnail" style="left:50%;transform:translateX(-50%);"></div>
      <div class="tnail" style="right:15px;"></div>
      <!-- Rod button -->
      <div class="tool-btn active" id="btn-rod" onclick="selectTool('rod')">
        <div class="tool-btn-ring"></div>
        <svg viewBox="0 0 58 58" xmlns="http://www.w3.org/2000/svg">
          <defs><radialGradient id="tb2" cx="40%" cy="35%"><stop offset="0%" stop-color="#4a7a30"/><stop offset="100%" stop-color="#1e3a10"/></radialGradient></defs>
          <circle cx="29" cy="29" r="27" fill="url(#tb2)"/>
          <g class="tool-icon-rod">
            <line x1="44" y1="14" x2="14" y2="44" stroke="#8b5e2a" stroke-width="5" stroke-linecap="round"/>
            <path d="M 44,14 Q 48,28 40,44" stroke="#ccc" stroke-width="1" fill="none" stroke-dasharray="3,2"/>
            <rect x="37" y="40" width="6" height="8" rx="3" fill="#ee2222"/>
            <rect x="37" y="48" width="6" height="5" rx="2" fill="#ffdd00"/>
            <circle cx="24" cy="34" r="5" fill="none" stroke="#888" stroke-width="2"/>
            <circle cx="24" cy="34" r="2" fill="#888"/>
          </g>
        </svg>
      </div>
      <!-- Bait button -->
      <div class="tool-btn" id="btn-bait" onclick="selectTool('bait')">
        <div class="tool-btn-ring"></div>
        <svg viewBox="0 0 58 58" xmlns="http://www.w3.org/2000/svg">
          <defs><radialGradient id="tb1" cx="40%" cy="35%"><stop offset="0%" stop-color="#4a7a30"/><stop offset="100%" stop-color="#1e3a10"/></radialGradient></defs>
          <circle cx="29" cy="29" r="27" fill="url(#tb1)"/>
          <g class="tool-icon-bait">
            <rect x="17" y="22" width="24" height="14" rx="3" fill="#c8a450" stroke="#7a5018" stroke-width="1.5"/>
            <path d="M 23,29 Q 26,24 29,29 Q 32,34 35,29" stroke="#8b4020" stroke-width="2.5" fill="none" stroke-linecap="round"/>
            <path d="M 42,27 Q 48,27 48,33 Q 48,39 42,39" stroke="#aaa" stroke-width="2" fill="none" stroke-linecap="round"/>
          </g>
        </svg>
      </div>
      <!-- Lure button -->
      <div class="tool-btn" id="btn-lure" onclick="selectTool('lure')">
        <div class="tool-btn-ring"></div>
        <svg viewBox="0 0 58 58" xmlns="http://www.w3.org/2000/svg">
          <defs><radialGradient id="tb3" cx="40%" cy="35%"><stop offset="0%" stop-color="#4a7a30"/><stop offset="100%" stop-color="#1e3a10"/></radialGradient></defs>
          <circle cx="29" cy="29" r="27" fill="url(#tb3)"/>
          <g class="tool-icon-lure">
            <rect x="18" y="23" width="22" height="20" rx="4" fill="rgba(200,230,200,.2)" stroke="#8b6a30" stroke-width="2"/>
            <rect x="16" y="17" width="26" height="8" rx="3" fill="#8b6a30" stroke="#5a3808" stroke-width="1.5"/>
            <path d="M 22,32 Q 25,28 28,32 Q 31,36 34,32 Q 37,28 40,32" stroke="#7a3818" stroke-width="2" fill="none" stroke-linecap="round" opacity=".8"/>
          </g>
        </svg>
      </div>
    </div>
  </div><!-- /fishing-screen -->

  <!-- ===== SHOP SCREEN ===== -->
  <div id="shop-screen" class="screen">
    <div class="shop-header"><div class="shop-title">ðŸª Ð›Ð°Ð²ÐºÐ° Ð Ñ‹Ð±Ð°ÐºÐ°</div></div>
    <div class="shop-banner" id="shop-tabs">
      <div class="shop-tab active" onclick="switchShopTab('rods',this)">ðŸŽ£ Ð£Ð´Ð¾Ñ‡ÐºÐ¸</div>
      <div class="shop-tab" onclick="switchShopTab('bait',this)">ðŸª± ÐÐ°Ð¶Ð¸Ð²ÐºÐ°</div>
      <div class="shop-tab" onclick="switchShopTab('lures',this)">ðŸª ÐŸÑ€Ð¸Ð¼Ð°Ð½ÐºÐ¸</div>
      <div class="shop-tab" onclick="switchShopTab('upgrades',this)">âš¡ Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ñ</div>
      <div class="shop-tab" onclick="switchShopTab('pikabufs',this)">âš¡ ÐŸÐ¸ÐºÐ°Ð‘Ð°Ñ„Ñ„Ñ‹</div>
    </div>
    <div class="shop-body" id="shop-body"></div>
  </div>

  <!-- ===== INVENTORY SCREEN ===== -->
  <div id="inventory-screen" class="screen">
    <div class="inv-header">
      <div class="inv-title">ðŸŽ’ Ð£Ð»Ð¾Ð²</div>
      <div class="inv-total-badge">ðŸª™ <span id="inv-total">0</span></div>
    </div>
    <div class="inv-body" id="inv-body"></div>
    <div class="sell-all-btn" onclick="sellAll()">ÐŸÑ€Ð¾Ð´Ð°Ñ‚ÑŒ Ð²ÑÑ‘ ðŸª™<span id="sell-all-amount">0</span></div>
  </div>

  <!-- ===== MULTIPLAYER / ONLINE SCREEN ===== -->
  <div id="multi-screen" class="screen">
    <div class="multi-header">ðŸŒ ÐžÐ½Ð»Ð°Ð¹Ð½</div>

    <!-- Room -->
    <div class="multi-section">
      <div class="multi-section-title">ÐšÐ¾Ð¼Ð½Ð°Ñ‚Ð°</div>
      <div class="multi-room-input">
        <input id="room-code-input" placeholder="ÐšÐ¾Ð´ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹ (4 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð°)" maxlength="6"/>
        <button class="multi-btn" onclick="joinRoom()">Ð’Ð¾Ð¹Ñ‚Ð¸</button>
      </div>
      <button class="multi-btn" style="width:100%;margin-bottom:6px;" onclick="createRoom()">âž• Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ</button>
      <button class="multi-btn" style="width:100%;margin-bottom:6px;border-color:#703030;color:#c06060;" onclick="leaveRoom()">ðŸšª Ð’Ñ‹Ð¹Ñ‚Ð¸ Ð¸Ð· ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹</button>
      <div class="multi-session-id" id="session-label">ðŸ”´ ÐÐµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ñ‘Ð½</div>
    </div>

    <!-- Full multiplayer toggle -->
    <div class="multi-section">
      <div class="multi-section-title">Ð ÐµÐ¶Ð¸Ð¼ Ð¸Ð³Ñ€Ñ‹</div>
      <div class="multi-toggle-row">
        <div>
          <div class="multi-toggle-label">ðŸ‘¥ ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ð¼ÑƒÐ»ÑŒÑ‚Ð¸Ð¿Ð»ÐµÐµÑ€</div>
          <div class="multi-toggle-desc">ÐžÐ±Ñ‰Ð¸Ð¹ Ð¸Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€ÑŒ, ÑÐ°Ð´ Ð¸ Ð¼Ð¾Ð½ÐµÑ‚Ñ‹</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="full-multi-toggle" onchange="toggleFullMulti(this.checked)">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div id="full-multi-note" style="display:none;padding:6px 10px;background:rgba(80,100,255,.1);border-radius:8px;font-family:'Neucha',cursive;font-size:11px;color:#5060a0;margin-bottom:6px;">
        ÐŸÑ€Ð¸ Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¸ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ ÑÐ²Ð¾ÑŽ Ñ‡ÐµÑÑ‚Ð½ÑƒÑŽ Ð´Ð¾Ð»ÑŽ Ð¼Ð¾Ð½ÐµÑ‚, Ñ€Ñ‹Ð±Ñ‹ Ð¸ Ñ†Ð²ÐµÑ‚Ð¾Ð²!
      </div>
    </div>

    <!-- Shared stats (visible in full multi) -->
    <div class="multi-section" id="shared-stats-section" style="display:none;">
      <div class="multi-section-title">ÐžÐ±Ñ‰Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°</div>
      <div class="multi-shared-stats">
        <div class="shared-stat"><div class="shared-stat-val" id="shared-coins">0</div><div class="shared-stat-lbl">ðŸª™ ÐœÐ¾Ð½ÐµÑ‚Ñ‹</div></div>
        <div class="shared-stat"><div class="shared-stat-val" id="shared-fish">0</div><div class="shared-stat-lbl">ðŸŸ Ð Ñ‹Ð±</div></div>
        <div class="shared-stat"><div class="shared-stat-val" id="shared-flowers">0</div><div class="shared-stat-lbl">ðŸŒ¸ Ð¦Ð²ÐµÑ‚Ð¾Ð²</div></div>
      </div>
    </div>

    <!-- Players online -->
    <div class="multi-section">
      <div class="multi-section-title">Ð˜Ð³Ñ€Ð¾ÐºÐ¸ Ð¾Ð½Ð»Ð°Ð¹Ð½</div>
      <div id="players-list">
        <div style="font-family:'Neucha',cursive;font-size:12px;color:#3040a0;padding:6px 0;">Ð’Ð¾Ð¹Ð´Ð¸Ñ‚Ðµ Ð² ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ð¸Ð´ÐµÑ‚ÑŒ Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²</div>
      </div>
    </div>

    <div class="multi-fish-parade" id="multi-parade"></div>
  </div>

  <!-- ===== LEADERBOARD SCREEN ===== -->
  <div id="leaderboard-screen" class="screen">
    <div class="lb-header">ðŸ† Ð›Ð¸Ð´ÐµÑ€Ð±Ð¾Ñ€Ð´</div>
    <div class="lb-tabs">
      <div class="lb-tab active" id="lb-tab-fish" onclick="switchLbTab('fish',this)">ðŸŸ Ð Ñ‹Ð±Ñ‹</div>
      <div class="lb-tab" id="lb-tab-pika" onclick="switchLbTab('pika',this)">âš¡ ÐŸÐ¸ÐºÐ°Ñ‡Ñƒ</div>
      <div class="lb-tab" id="lb-tab-coins" onclick="switchLbTab('coins',this)">ðŸª™ ÐœÐ¾Ð½ÐµÑ‚Ñ‹</div>
    </div>
    <div id="lb-list" style="width:100%;padding:0 8px;"></div>
    <div style="font-family:'Neucha',cursive;font-size:10px;color:#3a3a6a;text-align:center;margin-top:8px;padding:0 16px;">
      Ð›Ð¸Ð´ÐµÑ€Ð±Ð¾Ñ€Ð´ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ÑÑ Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ñ‡ÐµÑ€ÐµÐ· Firebase
    </div>
  </div>

  <!-- ===== GARDEN SCREEN ===== -->
  <div id="garden-screen" class="screen">
    <!-- Scene: main garden view -->
    <div id="gscene-garden" class="garden-scene">
      <div class="gdn-sky"></div>

      <!-- Decorative trees -->
      <div class="gdn-tree" style="left:10px;">
        <div class="gdn-tree-top"></div><div class="gdn-tree-trunk"></div>
      </div>
      <div class="gdn-tree" style="right:10px;">
        <div class="gdn-tree-top"></div><div class="gdn-tree-trunk"></div>
      </div>
      <div class="gdn-tree" style="left:30px;bottom:120px;">
        <div class="gdn-tree-top" style="width:46px;height:55px;"></div><div class="gdn-tree-trunk" style="width:11px;height:38px;"></div>
      </div>
      <div class="gdn-tree" style="right:28px;bottom:130px;">
        <div class="gdn-tree-top" style="width:50px;height:60px;"></div><div class="gdn-tree-trunk" style="width:12px;height:42px;"></div>
      </div>

      <div class="gdn-ground"></div>

      <!-- Flower plots - left side -->
      <div class="gdn-flower-bed" id="garden-plots-left" style="left:10px;bottom:120px;width:130px;"></div>
      <!-- Flower plots - right side -->
      <div class="gdn-flower-bed" id="garden-plots-right" style="right:10px;bottom:120px;width:130px;"></div>

      <!-- Path to shop -->
      <div class="gdn-path" id="garden-path" onclick="walkToShop()">
        <div class="gdn-path-label">â¬†ï¸ Ð’ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½</div>
      </div>

      <!-- Garden UI bar -->
      <div style="position:absolute;bottom:68px;left:0;right:0;display:flex;justify-content:space-between;align-items:center;padding:0 12px;z-index:20;">
        <div style="font-family:'Neucha',cursive;font-size:12px;color:rgba(200,255,150,.7);">ðŸŒ¸ Ð¡Ð°Ð´</div>
        <button onclick="harvestAll()" style="background:rgba(40,80,20,.8);border:1.5px solid #4a7a20;border-radius:8px;padding:4px 12px;font-family:'Neucha',cursive;font-size:11px;color:#a0e040;cursor:pointer;">Ð¡Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ Ð²ÑÑ‘ ðŸŒº</button>
      </div>
    </div>

    <!-- Scene: road walk animation -->
    <div id="gscene-road" class="garden-scene" style="display:none;">
      <!-- Side grass -->
      <div class="road-grass-left"></div>
      <div class="road-grass-right"></div>
      <!-- Road -->
      <div class="road-path-visual"></div>
      <!-- Ground strip -->
      <div class="shop-ground"></div>
      <!-- Side flowers -->
      <div class="road-flower" style="left:22%;top:38%;">ðŸŒ¸</div>
      <div class="road-flower" style="right:18%;top:42%;animation-delay:1s;">ðŸŒ¼</div>
      <div class="road-flower" style="left:14%;top:55%;animation-delay:1.5s;">ðŸŒ¿</div>
      <div class="road-flower" style="right:22%;top:52%;animation-delay:.5s;">ðŸŒº</div>
      <!-- Shop building: ROOF on top, WALLS below -->
      <div class="shop-building">
        <div class="shop-sign" id="road-building-sign">ðŸŒ± Ð›Ð°Ð²ÐºÐ° Ð¡ÐµÐ¼ÑÐ½</div>
        <!-- Chimney -->
        <div class="shop-chimney"></div>
        <!-- Roof SVG -->
        <svg class="shop-roof-svg" viewBox="0 0 180 60" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="roofG" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stop-color="#c03010"/>
              <stop offset="100%" stop-color="#7a1a06"/>
            </linearGradient>
          </defs>
          <polygon points="0,60 90,4 180,60" fill="url(#roofG)" stroke="#5a1006" stroke-width="2"/>
          <line x1="90" y1="4" x2="90" y2="60" stroke="rgba(0,0,0,.15)" stroke-width="2"/>
          <line x1="45" y1="34" x2="45" y2="60" stroke="rgba(0,0,0,.1)" stroke-width="1"/>
          <line x1="135" y1="34" x2="135" y2="60" stroke="rgba(0,0,0,.1)" stroke-width="1"/>
          <!-- Roof ridge cap -->
          <rect x="82" y="2" width="16" height="6" rx="3" fill="#e04020" stroke="#8a2010" stroke-width="1"/>
        </svg>
        <!-- Walls -->
        <div class="shop-walls">
          <div class="shop-window left cross"></div>
          <div class="shop-window right cross"></div>
          <div class="shop-door" id="shop-door" onclick="enterShopFromRoad()"></div>
        </div>
        <!-- Base/foundation -->
        <div class="shop-walls-base"></div>
      </div>
      <!-- Walker -->
      <div class="walker" id="walker" style="bottom:160px;">ðŸš¶</div>
      <!-- Road choice (shown when arrived) -->
      <div id="road-choice">
        <div style="font-family:'Neucha',cursive;font-size:13px;color:rgba(240,210,140,.9);margin-bottom:6px;text-align:center;">ÐšÑƒÐ´Ð° Ð¸Ð´Ñ‘Ð¼?</div>
        <div class="road-choice-btn road-choice-plant" onclick="enterShop()">ðŸŒ± ÐœÐ°Ð³Ð°Ð·Ð¸Ð½ Ð Ð°ÑÑ‚ÐµÐ½Ð¸Ð¹</div>
        <div class="road-choice-btn road-choice-kiosk" onclick="enterKiosk()">ðŸ›– ÐšÐ¸Ð¾ÑÐº (Ñ‚Ð¾Ñ€Ð³Ð¾Ð²Ð»Ñ)</div>
      </div>
      <!-- Hint -->
      <div style="position:absolute;bottom:72px;left:50%;transform:translateX(-50%);font-family:'Neucha',cursive;font-size:13px;color:rgba(220,200,140,.9);white-space:nowrap;background:rgba(0,0,0,.5);padding:4px 12px;border-radius:10px;" id="road-hint">Ð˜Ð´Ñ‘Ð¼ Ð² Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½...</div>
    </div>
    <!-- Scene: seed shop interior -->
    <div id="gscene-seedshop" class="garden-scene" style="display:none;">
      <div class="seedshop-counter">
        <div class="seedshop-counter-img">ðŸª</div>
        <div>
          <div class="seedshop-title">Ð›Ð°Ð²ÐºÐ° Ð¡ÐµÐ¼ÑÐ½</div>
          <div class="seedshop-sub">Ð’Ñ‹Ð±ÐµÑ€Ð¸ Ð¿Ð°ÐºÐµÑ‚ Ñ ÑÐµÐ¼ÐµÐ½Ð°Ð¼Ð¸</div>
        </div>
      </div>
      <div id="seedshop-items"></div>
      <button onclick="leaveShop()" style="position:fixed;bottom:70px;left:50%;transform:translateX(-50%);background:rgba(60,30,5,.8);border:1.5px solid #5a3010;border-radius:10px;padding:8px 24px;font-family:'Neucha',cursive;font-size:13px;color:#c09040;cursor:pointer;">ðŸšª Ð’Ñ‹Ð¹Ñ‚Ð¸</button>
    </div>

    <!-- Scene: kiosk (player marketplace) -->
    <div id="gscene-kiosk" class="garden-scene" style="display:none;">
      <div class="kiosk-header">
        <div style="font-size:32px;">ðŸ›–</div>
        <div>
          <div class="kiosk-title">Ð Ñ‹Ð±Ð°Ñ†ÐºÐ¸Ð¹ ÐšÐ¸Ð¾ÑÐº</div>
          <div class="kiosk-subtitle">Ð¢Ð¾Ñ€Ð³ÑƒÐ¹ Ñ Ð½Ð°ÑÑ‚Ð¾ÑÑ‰Ð¸Ð¼Ð¸ Ð¸Ð³Ñ€Ð¾ÐºÐ°Ð¼Ð¸!</div>
        </div>
      </div>
      <!-- Sell form -->
      <div class="kiosk-section-title">ðŸ“¦ Ð’Ñ‹ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð½Ð° Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ñƒ</div>
      <div id="kiosk-sell-section" style="width:94%;margin-bottom:8px;"></div>
      <!-- Market listings from other players -->
      <div class="kiosk-section-title">ðŸ›’ Ð Ñ‹Ð½Ð¾Ðº Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²</div>
      <div id="kiosk-market-list" style="width:94%;"></div>
      <button onclick="leaveKiosk()" style="position:fixed;bottom:70px;left:50%;transform:translateX(-50%);background:rgba(60,30,5,.8);border:1.5px solid #5a3010;border-radius:10px;padding:8px 24px;font-family:'Neucha',cursive;font-size:13px;color:#c09040;cursor:pointer;">ðŸšª Ð’Ñ‹Ð¹Ñ‚Ð¸ Ð¸Ð· ÐºÐ¸Ð¾ÑÐºÐ°</button>
    </div>

    <!-- Black fade overlay -->
    <div id="scene-fade"></div>
  </div>

  <!-- ===== FORTUNE WHEEL OVERLAY ===== -->
  <div id="fortune-overlay">
    <div id="fortune-title">ðŸŽ¡ ÐšÐ¾Ð»ÐµÑÐ¾ Ð¤Ð¾Ñ€Ñ‚ÑƒÐ½Ñ‹</div>
    <div id="fortune-wheel-wrap">
      <canvas id="fortune-wheel-canvas" width="260" height="260"></canvas>
      <div id="fortune-wheel-pointer"></div>
    </div>
    <div id="fortune-result"></div>
    <div id="fortune-cost">Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ: 50ðŸª™ Ð·Ð° Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ</div>
    <button id="fortune-spin-btn" onclick="spinFortune()">ðŸŽ² ÐšÑ€ÑƒÑ‚Ð¸Ñ‚ÑŒ!</button>
    <div id="fortune-close-btn" onclick="closeFortune()">Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ</div>
  </div>

  <!-- ===== CATCH POPUP ===== -->
  <div id="catch-popup">
    <div id="catch-board">
      <div class="board-nail tl"></div><div class="board-nail tr"></div>
      <div class="board-nail bl"></div><div class="board-nail br"></div>
      <div id="catch-header">ðŸŽ‰ Ð£Ð»Ð¾Ð²!</div>
      <svg id="catch-fish-svg" width="100" height="55" viewBox="0 0 100 55" xmlns="http://www.w3.org/2000/svg">
        <defs><radialGradient id="fishG" cx="40%" cy="40%"><stop offset="0%" stop-color="#e0a030"/><stop offset="100%" stop-color="#905010"/></radialGradient></defs>
        <ellipse cx="48" cy="28" rx="32" ry="18" fill="url(#fishG)" stroke="#6a3808" stroke-width="1.5"/>
        <polygon points="80,28 98,14 98,42" fill="#c07820" stroke="#6a3808" stroke-width="1"/>
        <path d="M 36,12 Q 48,4 60,12" stroke="#a06018" stroke-width="2" fill="none"/>
        <circle cx="22" cy="24" r="4.5" fill="#fff" stroke="#3a2008" stroke-width="1"/>
        <circle cx="21" cy="24" r="2.2" fill="#1a1008"/>
        <path d="M 36,22 Q 42,17 48,22" stroke="#7a4818" stroke-width="1" fill="none" opacity=".6"/>
        <path d="M 48,22 Q 54,17 60,22" stroke="#7a4818" stroke-width="1" fill="none" opacity=".6"/>
        <path d="M 30,28 Q 40,24 50,28" stroke="#7a4818" stroke-width="1" fill="none" opacity=".6"/>
        <path d="M 16,28 Q 18,32 21,28" stroke="#6a3808" stroke-width="1.5" fill="none"/>
      </svg>
      <div id="catch-pokemon-emoji" style="display:none;font-size:58px;line-height:1;text-align:center;margin:4px 0;filter:drop-shadow(0 2px 8px rgba(100,80,255,.5));"></div>
      <div id="catch-name-txt">ÐšÐ°Ñ€Ð°ÑÑŒ</div>
      <div id="catch-weight-txt">0.5 ÐºÐ³ â€¢ +10 Ð¾Ñ‡ÐºÐ¾Ð²</div>
      <div id="catch-rarity" class="rarity-common">ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹</div>
      <div class="catch-btns">
        <div class="catch-btn btn-keep" onclick="keepFish()">ðŸŽ’ Ð¡ÑƒÐ¼ÐºÐ°</div>
        <div class="catch-btn btn-sell-pop" id="catch-sell-btn" onclick="sellFish()">ÐŸÑ€Ð¾Ð´Ð°Ñ‚ÑŒ ðŸª™<span id="popup-sell-price">0</span></div>
      </div>
    </div>
  </div>

  <!-- ===== NAV TABS ===== -->
  <div id="navtabs">
    <div class="navtab active" id="nav-fish" onclick="switchScreen('fishing')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9.5Q7 4 12 9.5Q17 15 21 9.5"/><path d="M21 9.5 L18 6.5 M21 9.5 L18 12.5"/></svg>
      Ð Ñ‹Ð±Ð°Ð»ÐºÐ°
      <div class="nav-player-dot" id="nav-fish-dot"></div>
    </div>
    <div class="navtab" id="nav-shop" onclick="switchScreen('shop')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18l-2 9H5L3 3z"/><circle cx="9" cy="20" r="1"/><circle cx="17" cy="20" r="1"/></svg>
      Ð›Ð°Ð²ÐºÐ°
      <div class="nav-player-dot" id="nav-shop-dot"></div>
    </div>
    <div class="navtab" id="nav-inv" onclick="switchScreen('inventory')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Ð˜Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€ÑŒ
      <div class="nav-player-dot" id="nav-inv-dot"></div>
    </div>
    <div class="navtab" id="nav-garden" onclick="switchScreen('garden')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2C6 8 4 14 12 22c8-8 6-14 0-22z"/><path d="M12 22V10"/></svg>
      Ð¡Ð°Ð´
      <div class="nav-player-dot" id="nav-garden-dot"></div>
    </div>
    <div class="navtab" id="nav-multi" onclick="switchScreen('multi')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="7" r="4"/><circle cx="15" cy="7" r="4"/><path d="M3 21v-2a7 7 0 0114 0v2"/></svg>
      ÐžÐ½Ð»Ð°Ð¹Ð½
      <div class="nav-player-dot" id="nav-multi-dot"></div>
    </div>
    <div class="navtab" id="nav-lb" onclick="switchScreen('leaderboard')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="12" width="4" height="9"/><rect x="10" y="6" width="4" height="15"/><rect x="17" y="2" width="4" height="19"/></svg>
      Ð¢Ð¾Ð¿
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast"></div>

</div><!-- /game -->
</div><!-- /scale-wrapper -->

<!-- ============================================================
     JAVASCRIPT
     ============================================================ -->
<script>
'use strict';

// ============================================================
// SCALING â€” fit game into any screen
// ============================================================
function applyScale() {
  const wrapper = document.getElementById('game-scale-wrapper');
  const W = 360, H = 700;
  const scaleX = window.innerWidth / W;
  const scaleY = window.innerHeight / H;
  const scale  = Math.min(scaleX, scaleY);
  wrapper.style.transform = `scale(${scale})`;
  wrapper.style.width  = W + 'px';
  wrapper.style.height = H + 'px';
  // Center
  wrapper.style.marginLeft = `${(window.innerWidth  - W * scale) / 2 / scale}px`;
  wrapper.style.marginTop  = `${(window.innerHeight - H * scale) / 2 / scale}px`;
}
applyScale();
window.addEventListener('resize', applyScale);
window.addEventListener('orientationchange', ()=>{ setTimeout(applyScale, 200); });

// ============================================================
// DATA â€” FISH (18 types)
// ============================================================
const FISH_DATA = [
  {name:'ÐšÐ°Ñ€Ð°ÑÑŒ',       w:[.15,.8],  pts:10, coins:5,   rar:'common',  label:'ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹',     col:'#d4902a', col2:'#a06010'},
  {name:'ÐžÐºÑƒÐ½ÑŒ',        w:[.3,1.5],  pts:20, coins:10,  rar:'common',  label:'ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹',     col:'#c04030', col2:'#802020'},
  {name:'ÐŸÐ»Ð¾Ñ‚Ð²Ð°',       w:[.1,.6],   pts:8,  coins:4,   rar:'common',  label:'ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹',     col:'#c0a040', col2:'#808020'},
  {name:'ÐšÑ€Ð°ÑÐ½Ð¾Ð¿ÐµÑ€ÐºÐ°',  w:[.2,.9],   pts:12, coins:6,   rar:'common',  label:'ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹',     col:'#e05028', col2:'#a03018'},
  {name:'Ð•Ñ€Ñˆ',          w:[.05,.3],  pts:6,  coins:3,   rar:'common',  label:'ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹',     col:'#708050', col2:'#404828'},
  {name:'Ð›ÐµÑ‰',          w:[.5,3.0],  pts:30, coins:18,  rar:'rare',    label:'Ð ÐµÐ´ÐºÐ¸Ð¹',      col:'#c09040', col2:'#907020'},
  {name:'Ð›Ð¸Ð½ÑŒ',         w:[.4,2.5],  pts:28, coins:16,  rar:'rare',    label:'Ð ÐµÐ´ÐºÐ¸Ð¹',      col:'#60a040', col2:'#306020'},
  {name:'Ð¯Ð·ÑŒ',          w:[.3,2.0],  pts:25, coins:14,  rar:'rare',    label:'Ð ÐµÐ´ÐºÐ¸Ð¹',      col:'#a07840', col2:'#705020'},
  {name:'Ð“Ð¾Ð»Ð°Ð²Ð»ÑŒ',      w:[.4,2.8],  pts:30, coins:16,  rar:'rare',    label:'Ð ÐµÐ´ÐºÐ¸Ð¹',      col:'#708060', col2:'#405040'},
  {name:'Ð¡ÑƒÐ´Ð°Ðº',        w:[.8,5.0],  pts:45, coins:28,  rar:'rare',    label:'Ð ÐµÐ´ÐºÐ¸Ð¹',      col:'#a08858', col2:'#786038'},
  {name:'Ð©ÑƒÐºÐ°',         w:[1.0,6.0], pts:60, coins:40,  rar:'epic',    label:'Ð­Ð¿Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹',   col:'#507040', col2:'#304828'},
  {name:'Ð¤Ð¾Ñ€ÐµÐ»ÑŒ',       w:[.4,2.5],  pts:50, coins:35,  rar:'epic',    label:'Ð­Ð¿Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹',   col:'#e06040', col2:'#c03020'},
  {name:'ÐÐ°Ð»Ð¸Ð¼',        w:[.6,4.0],  pts:45, coins:30,  rar:'epic',    label:'Ð­Ð¿Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹',   col:'#506070', col2:'#304050'},
  {name:'Ð–ÐµÑ€ÐµÑ…',        w:[.5,4.5],  pts:48, coins:32,  rar:'epic',    label:'Ð­Ð¿Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹',   col:'#c0c0a0', col2:'#808070'},
  {name:'Ð¡Ð¾Ð¼',          w:[2.0,12.], pts:100,coins:80,  rar:'legend',  label:'Ð›ÐµÐ³ÐµÐ½Ð´Ð°Ñ€Ð½Ñ‹Ð¹', col:'#504030', col2:'#302818'},
  {name:'Ð¡Ñ‚ÐµÑ€Ð»ÑÐ´ÑŒ',     w:[.5,3.0],  pts:90, coins:70,  rar:'legend',  label:'Ð›ÐµÐ³ÐµÐ½Ð´Ð°Ñ€Ð½Ñ‹Ð¹', col:'#a09060', col2:'#706040'},
  {name:'Ð¡Ð°Ð·Ð°Ð½',        w:[1.5,10.], pts:85, coins:65,  rar:'legend',  label:'Ð›ÐµÐ³ÐµÐ½Ð´Ð°Ñ€Ð½Ñ‹Ð¹', col:'#c0801a', col2:'#905010'},
  {name:'Ð—Ð¾Ð»Ð¾Ñ‚Ð°Ñ Ð Ñ‹Ð±ÐºÐ°',w:[.1,.5],   pts:200,coins:200, rar:'legend',  label:'Ð›ÐµÐ³ÐµÐ½Ð´Ð°Ñ€Ð½Ñ‹Ð¹!',col:'#ffd030', col2:'#c08010'},
];

// ============================================================
// DATA â€” RODS
// ============================================================
const RODS = [
  {id:'wood',   name:'Ð”ÐµÑ€ÐµÐ²ÐµÐ½ÑÐºÐ°Ñ', desc:'ÐŸÑ€Ð¾ÑÑ‚Ð°Ñ Ð´ÐµÑ€ÐµÐ²ÑÐ½Ð½Ð°Ñ ÑƒÐ´Ð¾Ñ‡ÐºÐ°', price:0,    biteChance:1.0, catchMult:1.0, stats:'ÐšÐ»Ñ‘Ð²: Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ð¹'},
  {id:'bamboo', name:'Ð‘Ð°Ð¼Ð±ÑƒÐºÐ¾Ð²Ð°Ñ',  desc:'Ð›ÐµÐ³Ñ‡Ðµ Ð¸ Ð³Ð¸Ð±Ñ‡Ðµ',             price:80,   biteChance:1.2, catchMult:1.1, stats:'ÐšÐ»Ñ‘Ð²: +20%'},
  {id:'carbon', name:'ÐšÐ°Ñ€Ð±Ð¾Ð½Ð¾Ð²Ð°Ñ',  desc:'Ð¡Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»',      price:250,  biteChance:1.5, catchMult:1.3, stats:'ÐšÐ»Ñ‘Ð²: +50% â€¢ Ð£Ð»Ð¾Ð²: +30%'},
  {id:'magic',  name:'Ð’Ð¾Ð»ÑˆÐµÐ±Ð½Ð°Ñ',   desc:'Ð˜Ð· Ñ‡ÐµÐ³Ð¾ Ð¾Ð½Ð° ÑÐ´ÐµÐ»Ð°Ð½Ð°?',      price:800,  biteChance:2.5, catchMult:2.0, stats:'ÐšÐ»Ñ‘Ð²: x2.5 â€¢ Ð£Ð»Ð¾Ð²: x2'},
  {id:'golden', name:'Ð—Ð¾Ð»Ð¾Ñ‚Ð°Ñ',     desc:'Ð›ÐµÐ³ÐµÐ½Ð´Ð° ÑÑ€ÐµÐ´Ð¸ ÑƒÐ´Ð¾Ñ‡ÐµÐº',      price:2000, biteChance:4.0, catchMult:3.0, stats:'ÐšÐ»Ñ‘Ð²: x4 â€¢ Ð£Ð»Ð¾Ð²: x3'},
];

// ============================================================
// DATA â€” BAIT
// ============================================================
const BAITS = [
  {id:'worm',   name:'Ð§ÐµÑ€Ð²ÑÐº',       desc:'ÐšÐ»Ð°ÑÑÐ¸Ñ‡ÐµÑÐºÐ°Ñ Ð½Ð°Ð¶Ð¸Ð²ÐºÐ°',  price:15, qty:0, biteBonus:.10, icon:'ðŸª±'},
  {id:'maggot', name:'ÐžÐ¿Ð°Ñ€Ñ‹Ñˆ',       desc:'ÐœÐ¾Ñ‚Ñ‹Ð»ÑŒ Ð´Ð»Ñ Ð¾ÐºÑƒÐ½Ñ',      price:20, qty:0, biteBonus:.20, icon:'ðŸ›'},
  {id:'bread',  name:'Ð¥Ð»ÐµÐ±Ð½Ñ‹Ð¹ Ð¼ÑÐºÐ¸Ñˆ',desc:'Ð¥Ð¾Ñ€Ð¾ÑˆÐ¾ Ð´Ð»Ñ ÐºÐ°Ñ€Ð°ÑÑ',     price:10, qty:0, biteBonus:.15, icon:'ðŸž'},
  {id:'corn',   name:'ÐšÑƒÐºÑƒÑ€ÑƒÐ·Ð°',     desc:'Ð”Ð»Ñ ÐºÑ€ÑƒÐ¿Ð½Ð¾Ð¹ Ñ€Ñ‹Ð±Ñ‹',      price:25, qty:0, biteBonus:.25, icon:'ðŸŒ½'},
  {id:'cheese', name:'Ð¡Ñ‹Ñ€',          desc:'Ð ÐµÐ´ÐºÐ°Ñ Ñ€Ñ‹Ð±Ð° ÐºÐ»ÑŽÑ‘Ñ‚ Ñ‡Ð°Ñ‰Ðµ',price:35, qty:0, biteBonus:.30, icon:'ðŸ§€'},
];

// ============================================================
// DATA â€” LURES
// ============================================================
const LURES = [
  {id:'spinner', name:'Ð’ÐµÑ€Ñ‚ÑƒÑˆÐºÐ° â„–1', desc:'Ð”Ð»Ñ Ñ‰ÑƒÐºÐ¸ Ð¸ Ð¾ÐºÑƒÐ½Ñ',  price:50, qty:0, rareBonus:.10, icon:'ðŸŒ€'},
  {id:'wobbler', name:'Ð’Ð¾Ð±Ð»ÐµÑ€',      desc:'Ð˜Ð¼Ð¸Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ Ñ€Ñ‹Ð±ÐºÑƒ',   price:80, qty:0, rareBonus:.20, icon:'ðŸ '},
  {id:'jig',     name:'Ð”Ð¶Ð¸Ð³',        desc:'Ð”Ð»Ñ ÑÑƒÐ´Ð°ÐºÐ° Ð¸ Ñ‰ÑƒÐºÐ¸', price:60, qty:0, rareBonus:.15, icon:'ðŸ’ '},
  {id:'spoon',   name:'Ð‘Ð»ÐµÑÐ½Ð°',      desc:'Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ð°Ñ',     price:45, qty:0, rareBonus:.12, icon:'ðŸ¥„'},
];

// ============================================================
// DATA â€” UPGRADES
// ============================================================
const UPGRADES = [
  {id:'bigger_bag',  name:'Ð‘Ð¾Ð»ÑŒÑˆÐ°Ñ ÑÑƒÐ¼ÐºÐ°',    desc:'Ð‘Ð¾Ð»ÑŒÑˆÐµ Ñ€Ñ‹Ð±Ñ‹ Ð² Ð¸Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€Ðµ',      price:120, effect:'Ð˜Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€ÑŒ: 30 ÑÐ»Ð¾Ñ‚Ð¾Ð²'},
  {id:'fish_radar',  name:'Ð Ñ‹Ð±Ð¸Ð¹ Ñ€Ð°Ð´Ð°Ñ€',      desc:'Ð’Ð¸Ð´Ð¸ÑˆÑŒ Ñ‚ÐµÐ½Ð¸ Ñ€Ñ‹Ð± Ð¿Ð¾Ð´ Ð²Ð¾Ð´Ð¾Ð¹',    price:300, effect:'Ð Ñ‹Ð±Ñ‹ Ð²Ð¸Ð´Ð½Ñ‹'},
  {id:'auto_reel',   name:'Ð­Ð»ÐµÐºÑ‚Ñ€Ð¾ÐºÐ°Ñ‚ÑƒÑˆÐºÐ°',   desc:'ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ð¾Ð´ÑÐµÐºÐ°ÐµÑ‚',      price:500, effect:'ÐÐ²Ñ‚Ð¾-Ð¿Ð¾Ð´ÑÐµÑ‡ÐºÐ°'},
  {id:'lucky_charm', name:'Ð Ñ‹Ð±Ð°Ñ†ÐºÐ¸Ð¹ Ð°Ð¼ÑƒÐ»ÐµÑ‚',  desc:'ÐŸÐ¾Ð²Ñ‹ÑˆÐ°ÐµÑ‚ ÑˆÐ°Ð½Ñ Ð»ÐµÐ³ÐµÐ½Ð´Ð°Ñ€Ð½Ñ‹Ñ…',    price:400, effect:'Ð›ÐµÐ³ÐµÐ½Ð´Ñ‹: +50%'},
  {id:'fast_bite',   name:'Ð§ÑƒÐ´Ð¾-Ð½Ð°Ð¶Ð¸Ð²ÐºÐ°',     desc:'Ð Ñ‹Ð±Ð° ÐºÐ»ÑŽÑ‘Ñ‚ Ð½Ð°Ð¼Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‰Ðµ',     price:350, effect:'ÐšÐ»Ñ‘Ð²: +100%'},
];

// ============================================================
// SAVE / LOAD  (localStorage)
// ============================================================
const SAVE_KEY = 'fishing_reborn_v3';

function saveGame() {
  const data = {
    coins: gs.coins,
    score: gs.score,
    fishCount: gs.fishCount,
    energy: gs.energy,
    inventory: gs.inventory,
    maxInv: gs.maxInv,
    currentRodId: gs.currentRod.id,
    rods: RODS.map(r=>({id:r.id,owned:r.owned||false,equipped:r.equipped||false})),
    baits: BAITS.map(b=>({id:b.id,qty:b.qty})),
    lures: LURES.map(l=>({id:l.id,qty:l.qty})),
    upgrades: UPGRADES.map(u=>({id:u.id,owned:u.owned||false})),
  };
  try { localStorage.setItem(SAVE_KEY, JSON.stringify(data)); } catch(e){}
  // Save extended fields
  try {
    const extra = {
      pikaCoins: gs.pikaCoins,
      pikaCatchCount: gs.pikaCatchCount,
      mapMode: gs.mapMode,
    };
    localStorage.setItem('fishing_reborn_extra', JSON.stringify(extra));
  } catch(e){}
}

function loadGame() {
  try {
    const raw = localStorage.getItem(SAVE_KEY);
    if(!raw) return;
    const data = JSON.parse(raw);
    gs.coins    = data.coins    ?? 150;
    gs.score    = data.score    ?? 0;
    gs.fishCount= data.fishCount?? 0;
    gs.energy   = data.energy   ?? 65;
    gs.inventory= data.inventory?? [];
    gs.maxInv   = data.maxInv   ?? 20;
    // Rods
    if(data.rods) data.rods.forEach(dr=>{ const r=RODS.find(x=>x.id===dr.id); if(r){r.owned=dr.owned;r.equipped=dr.equipped;} });
    // Baits
    if(data.baits) data.baits.forEach(db=>{ const b=BAITS.find(x=>x.id===db.id); if(b) b.qty=db.qty; });
    // Lures
    if(data.lures) data.lures.forEach(dl=>{ const l=LURES.find(x=>x.id===dl.id); if(l) l.qty=dl.qty; });
    // Upgrades
    if(data.upgrades) data.upgrades.forEach(du=>{ const u=UPGRADES.find(x=>x.id===du.id); if(u) u.owned=du.owned; });
    // Current rod
    const equippedRod = RODS.find(r=>r.equipped) || RODS[0];
    gs.currentRod = equippedRod;
    if(!RODS[0].owned) RODS[0].owned = true;
    // Apply upgrade effects silently
    if(UPGRADES.find(u=>u.id==='bigger_bag')?.owned) gs.maxInv=30;
  } catch(e) { console.warn('Load failed', e); }
}

// Auto-save every 15 seconds
setInterval(saveGame, 15000);

// ============================================================
// GAME STATE
// ============================================================
const gs = {
  phase:'idle',
  bobX:0, bobY:0,
  fishCount:0, score:0, energy:65, coins:150,
  fish:null, currentCatch:null,
  biteTimer:null, biteTimeout:null,
  inventory:[], maxInv:20,
  currentRod:RODS[0],
  currentScreen:'fishing',
  shopTab:'rods',
  weather:'night', // night | dawn | day | dusk | rain | storm | fog | snow
  weatherTimer:null,
  rainActive:false,
};

// Default rod 0 owned
RODS[0].owned    = true;
RODS[0].equipped = true;

// ============================================================
// DOM REFS
// ============================================================
const fishingScreen = document.getElementById('fishing-screen');
const bobWrap  = document.getElementById('bobber-wrap');
const linecanvas = document.getElementById('linecanvas');
const lctx     = linecanvas.getContext('2d');
const hint     = document.getElementById('cast-hint');
const biteEl   = document.getElementById('bite-indicator');
const rodBody  = document.getElementById('rod-body');
const reelSvg  = document.querySelector('#rod-reel svg');
const rainCanvas = document.getElementById('rain-canvas');
const rctx     = rainCanvas.getContext('2d');

function resizeCanvases() {
  linecanvas.width  = 360;
  linecanvas.height = 700;
  rainCanvas.width  = 360;
  rainCanvas.height = 700;
}
resizeCanvases();

// ============================================================
// LOAD SAVE DATA
// ============================================================
loadGame();

// ============================================================
// TIME
// ============================================================
function updateTime() {
  const n = new Date();
  document.getElementById('game-time').textContent =
    String(n.getHours()).padStart(2,'0')+':'+String(n.getMinutes()).padStart(2,'0');
}
updateTime();
setInterval(updateTime, 20000);

// ============================================================
// STARS
// ============================================================
(function createStars() {
  const c = document.getElementById('stars');
  for(let i=0;i<70;i++){
    const s = document.createElement('div'); s.className='star';
    const sz = .6+Math.random()*2;
    s.style.cssText=`width:${sz}px;height:${sz}px;left:${Math.random()*100}%;top:${Math.random()*90}%;--d:${2+Math.random()*4}s;--delay:${Math.random()*5}s;`;
    c.appendChild(s);
  }
})();

// ============================================================
// CLOUDS
// ============================================================
(function createClouds() {
  const c = document.getElementById('clouds');
  for(let i=0;i<5;i++){
    const cl = document.createElement('div'); cl.className='cloud';
    const w=80+Math.random()*120, h=30+Math.random()*50;
    cl.style.cssText=`width:${w}px;height:${h}px;top:${10+Math.random()*50}%;left:${Math.random()*300}px;opacity:0;--cd:${25+Math.random()*20}s;--cdelay:${Math.random()*-30}s;`;
    c.appendChild(cl);
  }
})();

// ============================================================
// FIREFLIES
// ============================================================
(function createFireflies() {
  for(let i=0;i<8;i++){
    const f=document.createElement('div'); f.className='firefly';
    f.style.cssText=`left:${10+Math.random()*60}%;top:${58+Math.random()*25}%;--fd:${5+Math.random()*7}s;--fdelay:${Math.random()*8}s;--fx:${-15+Math.random()*30}px;--fy:${-15+Math.random()*15}px;--fx2:${-10+Math.random()*25}px;--fy2:${-20+Math.random()*10}px;--fx3:${-8+Math.random()*20}px;--fy3:${-12+Math.random()*8}px;`;
    fishingScreen.appendChild(f);
  }
})();

// ============================================================
// BIRDS
// ============================================================
(function createBirds() {
  for(let i=0;i<3;i++){
    const b=document.createElement('div'); b.className='bird';
    b.innerHTML=`<svg viewBox="0 0 20 10" width="18" height="9"><path d="M0,5 Q5,0 10,5 Q15,0 20,5" stroke="#0a1810" stroke-width="1.5" fill="none"/></svg>`;
    b.style.cssText=`top:${8+i*5}%;--bd:${18+i*6}s;--bdelay:${-i*6}s;opacity:0;`;
    fishingScreen.appendChild(b);
  }
})();

// ============================================================
// MULTIPLAYER PARADE
// ============================================================
(function createParade() {
  const p = document.getElementById('multi-parade');
  if(!p) return;
  ['ðŸŸ','ðŸ ','ðŸ¡','ðŸ¦ˆ','ðŸ™'].forEach((e,i)=>{
    const f=document.createElement('div');
    f.style.cssText=`position:absolute;font-size:24px;animation:swimAcross ${14+i*4}s linear infinite;animation-delay:${-i*3}s;top:${6+i*8}px;`;
    f.textContent=e;
    p.appendChild(f);
  });
})();

// ============================================================
// WEATHER SYSTEM
// ============================================================
const WEATHERS = {
  night: {
    skyTop:'#020609', skyBot:'#050e0c', waterTop:'#082e18', waterBot:'#030e07',
    moonOpacity:1, sunOpacity:0, starsOpacity:1, cloudsOpacity:.1,
    firefliesOpacity:1, birdsOpacity:0, fogOpacity:0, rainOpacity:0,
    ambLight:'rgba(0,0,0,0)', label:'ðŸŒ™ ÐÐ¾Ñ‡ÑŒ', icon:'ðŸŒ™',
    biteBonus:1.0, forestFill:'#08160a'
  },
  dawn: {
    skyTop:'#2a0e18', skyBot:'#8a3820', waterTop:'#1e3838', waterBot:'#081820',
    moonOpacity:.3, sunOpacity:.6, starsOpacity:.2, cloudsOpacity:.4,
    firefliesOpacity:.2, birdsOpacity:.3, fogOpacity:.4, rainOpacity:0,
    ambLight:'rgba(180,80,20,.08)', label:'ðŸŒ… Ð Ð°ÑÑÐ²ÐµÑ‚', icon:'ðŸŒ…',
    biteBonus:1.3, forestFill:'#0e2210'
  },
  day: {
    skyTop:'#1a4870', skyBot:'#4a9ab0', waterTop:'#1a5060', waterBot:'#0c2030',
    moonOpacity:0, sunOpacity:1, starsOpacity:0, cloudsOpacity:.6,
    firefliesOpacity:0, birdsOpacity:.8, fogOpacity:0, rainOpacity:0,
    ambLight:'rgba(100,180,220,.06)', label:'â˜€ï¸ Ð”ÐµÐ½ÑŒ', icon:'â˜€ï¸',
    biteBonus:0.9, forestFill:'#154a18'
  },
  dusk: {
    skyTop:'#180e28', skyBot:'#6a2810', waterTop:'#1c2a30', waterBot:'#080a10',
    moonOpacity:.7, sunOpacity:.2, starsOpacity:.5, cloudsOpacity:.5,
    firefliesOpacity:.6, birdsOpacity:.4, fogOpacity:.1, rainOpacity:0,
    ambLight:'rgba(150,60,20,.07)', label:'ðŸŒ‡ Ð—Ð°ÐºÐ°Ñ‚', icon:'ðŸŒ‡',
    biteBonus:1.2, forestFill:'#0e1c0e'
  },
  rain: {
    skyTop:'#0a0e18', skyBot:'#141e24', waterTop:'#0e2a1e', waterBot:'#060e08',
    moonOpacity:.1, sunOpacity:0, starsOpacity:0, cloudsOpacity:.95,
    firefliesOpacity:0, birdsOpacity:0, fogOpacity:.3, rainOpacity:.9,
    ambLight:'rgba(20,40,60,.1)', label:'ðŸŒ§ï¸ Ð”Ð¾Ð¶Ð´ÑŒ', icon:'ðŸŒ§ï¸',
    biteBonus:1.5, forestFill:'#081008'
  },
  storm: {
    skyTop:'#050810', skyBot:'#0c1018', waterTop:'#0a1a14', waterBot:'#040a06',
    moonOpacity:0, sunOpacity:0, starsOpacity:0, cloudsOpacity:1,
    firefliesOpacity:0, birdsOpacity:0, fogOpacity:.5, rainOpacity:1,
    ambLight:'rgba(10,20,40,.15)', label:'â›ˆï¸ Ð“Ñ€Ð¾Ð·Ð°', icon:'â›ˆï¸',
    biteBonus:2.0, forestFill:'#060e06'
  },
  fog: {
    skyTop:'#0c1210', skyBot:'#181e18', waterTop:'#0e2018', waterBot:'#060e08',
    moonOpacity:.4, sunOpacity:0, starsOpacity:.2, cloudsOpacity:.8,
    firefliesOpacity:.3, birdsOpacity:0, fogOpacity:.85, rainOpacity:0,
    ambLight:'rgba(150,180,150,.05)', label:'ðŸŒ«ï¸ Ð¢ÑƒÐ¼Ð°Ð½', icon:'ðŸŒ«ï¸',
    biteBonus:0.8, forestFill:'#0a1808'
  },
};
const WEATHER_ORDER = ['night','night','night','dawn','day','day','dusk','dusk','night','rain','fog','storm','night'];

let weatherIdx = 0;
gs.weather = WEATHER_ORDER[0];

function applyWeather(name, fast) {
  const w = WEATHERS[name] || WEATHERS.night;
  const root = document.documentElement;
  // CSS vars
  root.style.setProperty('--sky-top', w.skyTop);
  root.style.setProperty('--sky-bot', w.skyBot);
  root.style.setProperty('--water-top', w.waterTop);
  root.style.setProperty('--water-bot', w.waterBot);
  root.style.setProperty('--amb-light', w.ambLight);
  // Elements
  document.getElementById('moon').style.opacity = w.moonOpacity;
  document.getElementById('sun').style.opacity  = w.sunOpacity;
  // Stars
  document.getElementById('stars').style.opacity = w.starsOpacity;
  // Clouds
  document.querySelectorAll('.cloud').forEach(c=>{ c.style.opacity = w.cloudsOpacity * (.3+Math.random()*.7); });
  // Fireflies
  document.querySelectorAll('.firefly').forEach(f=>{ f.style.opacity = w.firefliesOpacity; });
  // Birds
  document.querySelectorAll('.bird').forEach(b=>{ b.style.opacity = w.birdsOpacity; });
  // Fog
  document.getElementById('fog').style.opacity = w.fogOpacity;
  // Rain
  document.getElementById('rain-canvas').style.opacity = w.rainOpacity;
  gs.rainActive = w.rainOpacity > 0.1;
  // Sun position animation
  if(name === 'day') {
    document.getElementById('sun').style.left = '80px';
    document.getElementById('sun').style.top  = '35px';
  } else if(name === 'dawn' || name === 'dusk') {
    document.getElementById('sun').style.left = '30px';
    document.getElementById('sun').style.top  = '60px';
  }
  // Moon reflection / sun reflection
  document.getElementById('moon-reflection').style.opacity = w.moonOpacity;
  document.getElementById('sun-reflection').style.opacity  = w.sunOpacity * .8;
  // Forest color
  document.getElementById('forest-trees-back').setAttribute('fill', w.forestFill);
  // Badge & icon
  document.getElementById('weather-badge').textContent = w.label;
  document.getElementById('weather-icon').textContent  = w.icon;
  // Label flash
  const lbl = document.getElementById('time-period-label');
  lbl.textContent = w.label;
  lbl.style.opacity = '1';
  setTimeout(()=>lbl.style.opacity='0', 3000);

  gs.weather = name;
  gs.weatherBiteBonus = w.biteBonus;
}

function nextWeather() {
  weatherIdx = (weatherIdx + 1) % WEATHER_ORDER.length;
  const name = WEATHER_ORDER[weatherIdx];
  applyWeather(name);
  showToast(`ÐŸÐ¾Ð³Ð¾Ð´Ð°: ${WEATHERS[name].label}`);
}

// Initial weather
applyWeather('night', true);
// Change weather every 90 seconds (game time is fast)
setInterval(nextWeather, 90000);

// ============================================================
// RAIN ANIMATION
// ============================================================
let rainDrops = [];
function initRain() {
  rainDrops = [];
  for(let i=0;i<120;i++) {
    rainDrops.push({
      x: Math.random()*360, y: Math.random()*700,
      len: 8+Math.random()*12, spd: 8+Math.random()*8,
      op: .3+Math.random()*.5
    });
  }
}
initRain();

function drawRain() {
  rctx.clearRect(0,0,360,700);
  if(!gs.rainActive) return;
  rctx.strokeStyle='rgba(150,190,220,.5)'; rctx.lineWidth=1;
  rainDrops.forEach(d=>{
    rctx.globalAlpha = d.op;
    rctx.beginPath();
    rctx.moveTo(d.x, d.y);
    rctx.lineTo(d.x+d.len*.3, d.y+d.len);
    rctx.stroke();
    d.y += d.spd;
    d.x += d.spd*.2;
    if(d.y > 700) { d.y=-10; d.x=Math.random()*360; }
    if(d.x > 360) { d.x=0; }
  });
  rctx.globalAlpha=1;
}

// ============================================================
// LIGHTNING (storm)
// ============================================================
function doLightning() {
  if(gs.weather !== 'storm') return;
  const overlay = document.getElementById('sky-overlay');
  overlay.style.background='rgba(200,220,255,.4)';
  setTimeout(()=>{ overlay.style.background=WEATHERS.storm.ambLight; }, 80);
  setTimeout(doLightning, 4000+Math.random()*8000);
}
setTimeout(doLightning, 5000);

// ============================================================
// DRAW FISHING LINE
// ============================================================
function drawLine() {
  lctx.clearRect(0,0,360,700);
  if(gs.phase==='idle') return;
  // Rod tip â€” approximate coords
  const tipX = 330;
  const tipY = 90;
  const bX = gs.bobX;
  const bY = gs.bobY - 22;
  lctx.beginPath();
  lctx.moveTo(tipX, tipY);
  const cpX = bX + 25;
  const cpY = tipY - 25;
  lctx.quadraticCurveTo(cpX, cpY, bX, bY);
  lctx.strokeStyle='rgba(210,200,170,.75)';
  lctx.lineWidth=1.2;
  lctx.setLineDash([4,3]);
  lctx.stroke(); lctx.setLineDash([]);
}
setInterval(drawLine, 60);

// ============================================================
// RIPPLE
// ============================================================
function makeRipple(x, y, size) {
  const water = document.getElementById('water');
  const waterTop = fishingScreen.offsetHeight * 0.39 + 54;
  const wy = y - waterTop + 54;
  for(let i=0;i<3;i++) {
    setTimeout(()=>{
      const r=document.createElement('div'); r.className='ripple';
      const s=(size||50)+i*22;
      r.style.cssText=`left:${x}px;top:${wy}px;width:${s}px;height:${s*.38}px;`;
      water.appendChild(r);
      setTimeout(()=>r.remove(), 1800);
    }, i*320);
  }
}

// ============================================================
// TOAST
// ============================================================
let toastTimer;
function showToast(msg) {
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'), 2600);
}

// ============================================================
// COIN BURST ANIMATION
// ============================================================
function coinBurst(x, y) {
  for(let i=0;i<5;i++) {
    const c=document.createElement('div'); c.className='coin-burst';
    const angle = -90 + (i-2)*35;
    const dist  = 40+Math.random()*30;
    const cx = Math.cos(angle*Math.PI/180)*dist;
    const cy = Math.sin(angle*Math.PI/180)*dist;
    c.style.cssText=`left:${x}px;top:${y}px;--cx:${cx}px;--cy:${cy}px;animation-delay:${i*60}ms;`;
    c.textContent='ðŸª™';
    document.getElementById('game').appendChild(c);
    setTimeout(()=>c.remove(), 1200);
  }
}

// ============================================================
// CAST ANIMATION
// ============================================================
function animateCast(targetX, targetY, callback) {
  rodBody.classList.add('casting');
  reelSvg.classList.add('spinning');
  const tipX=330, tipY=90;
  const dur=580;
  const start=Date.now();
  function fly() {
    const t = Math.min(1,(Date.now()-start)/dur);
    const ease = t<.5?2*t*t:-1+(4-2*t)*t;
    const cpX=(tipX+targetX)/2, cpY=Math.min(tipY,targetY)-90;
    const bx=(1-ease)*(1-ease)*tipX + 2*(1-ease)*ease*cpX + ease*ease*targetX;
    const by=(1-ease)*(1-ease)*tipY + 2*(1-ease)*ease*cpY + ease*ease*targetY;
    lctx.clearRect(0,0,360,700);
    lctx.beginPath(); lctx.moveTo(tipX,tipY);
    lctx.quadraticCurveTo(cpX,cpY,bx,by);
    lctx.strokeStyle='rgba(210,200,170,.6)'; lctx.lineWidth=1.2;
    lctx.setLineDash([3,2]); lctx.stroke(); lctx.setLineDash([]);
    // Flying bobber dots
    lctx.fillStyle='#ee2222'; lctx.beginPath(); lctx.arc(bx,by,5,0,Math.PI*2); lctx.fill();
    lctx.fillStyle='#ffdd00'; lctx.beginPath(); lctx.arc(bx,by+7,4,0,Math.PI*2); lctx.fill();
    if(t<1) requestAnimationFrame(fly);
    else {
      rodBody.classList.remove('casting');
      reelSvg.classList.remove('spinning');
      callback();
    }
  }
  requestAnimationFrame(fly);
}

// ============================================================
// CAST
// ============================================================
function castTo(x, y) {
  gs.phase='casting';
  hint.style.display='none';
  animateCast(x, y, ()=>{
    gs.phase='waiting';
    gs.bobX=x; gs.bobY=y;
    bobWrap.style.left=x+'px';
    bobWrap.style.top =y+'px';
    bobWrap.style.display='block';
    bobWrap.style.animation='floatBob 2.2s ease-in-out infinite';
    makeRipple(x, y, 40);
    const weatherBonus = gs.weatherBiteBonus || 1.0;
    const rodMult      = gs.currentRod.biteChance;
    const upgBonus     = UPGRADES.find(u=>u.id==='fast_bite')?.owned ? 2 : 1;
    const activeBait   = BAITS.reduce((s,b)=>s+(b.qty>0?b.biteBonus:0), 0);
    const total        = rodMult * weatherBonus * upgBonus * (1+activeBait);
    const delay        = (3000+Math.random()*10000) / total;
    gs.biteTimer = setTimeout(triggerBite, delay);
  });
}

// ============================================================
// BITE
// ============================================================
function triggerBite() {
  if(gs.phase!=='waiting') return;
  gs.phase='bite';

  // â”€â”€ Pokemon mode â”€â”€
  if(gs.mapMode === 'pokemon') {
    const pool = getPokemonPool();
    const poke = pool[Math.floor(Math.random()*pool.length)];
    gs.currentCatch = {...poke, isPokemon:true, weight: (0.5 + Math.random()*2).toFixed(1)};
    bobWrap.style.animation='floatBite .9s ease-in-out 4';
    biteEl.classList.add('visible');
    if(navigator.vibrate) navigator.vibrate([80,30,80,30,80]);
    gs.biteTimeout = setTimeout(()=>{ if(gs.phase==='bite') miss(); }, 5000);
    return;
  }

  // â”€â”€ Normal mode â”€â”€
  const hasLucky = UPGRADES.find(u=>u.id==='lucky_charm')?.owned;
  const lureBonus = LURES.reduce((s,l)=>s+(l.qty>0?l.rareBonus:0),0);
  const pool=[];
  FISH_DATA.forEach(f=>{
    let w = f.rar==='common'?60 : f.rar==='rare'?30 : f.rar==='epic'?8 : 2;
    if(f.rar==='legend' && hasLucky) w*=1.5;
    if(f.rar!=='common') w *= (1+lureBonus);
    for(let i=0;i<Math.round(w);i++) pool.push(f);
  });
  gs.fish = pool[Math.floor(Math.random()*pool.length)];
  gs.currentCatch = {
    ...gs.fish,
    weight: (gs.fish.w[0]+Math.random()*(gs.fish.w[1]-gs.fish.w[0])).toFixed(2)
  };
  bobWrap.style.animation='floatBite .9s ease-in-out 4';
  biteEl.classList.add('visible');
  if(navigator.vibrate) navigator.vibrate([100,50,100]);
  const autoReel = UPGRADES.find(u=>u.id==='auto_reel')?.owned;
  if(autoReel) {
    setTimeout(()=>{ if(gs.phase==='bite') catchFish(); }, 1200);
  } else {
    gs.biteTimeout = setTimeout(()=>{ if(gs.phase==='bite') miss(); }, 5000);
  }
}


function miss() {
  gs.phase='idle';
  biteEl.classList.remove('visible');
  bobWrap.style.display='none'; bobWrap.style.animation='';
  hint.style.display='block'; hint.textContent='Ð£ÑˆÐ»Ð°... Ð—Ð°Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ ÑÐ½Ð¾Ð²Ð°?';
  lctx.clearRect(0,0,360,700);
}

// ============================================================
// CATCH FISH
// ============================================================
function catchFish() {
  if(gs.phase!=='bite') return;
  clearTimeout(gs.biteTimeout);
  gs.phase='idle';
  biteEl.classList.remove('visible');
  reelSvg.classList.add('spinning');
  setTimeout(()=>reelSvg.classList.remove('spinning'), 900);
  bobWrap.style.display='none'; bobWrap.style.animation='';
  lctx.clearRect(0,0,360,700);

  // â”€â”€ Pokemon mode â”€â”€
  if(gs.mapMode === 'pokemon') {
    catchPokemon(gs.currentCatch);
    return;
  }

  // â”€â”€ Normal mode â”€â”€
  const f=gs.currentCatch;
  gs.fishCount++;
  gs.score+=f.pts;
  document.getElementById('fish-count').textContent=gs.fishCount;
  document.getElementById('score-val').textContent=gs.score;
  updateCatchPopupFish(f);
  document.getElementById('catch-header').textContent = 'ðŸŽ‰ Ð£Ð»Ð¾Ð²!';
  document.getElementById('catch-name-txt').textContent=f.name;
  document.getElementById('catch-weight-txt').textContent=`${f.weight} ÐºÐ³ â€¢ +${f.pts} â˜…`;
  const rarEl=document.getElementById('catch-rarity');
  rarEl.textContent=f.label; rarEl.className=`rarity-${f.rar}`;
  const price=calcPrice(f);
  document.getElementById('popup-sell-price').textContent=' '+price;
  document.getElementById('catch-sell-btn').style.display = '';
  document.getElementById('catch-popup').classList.add('show');
  showScorePop('+'+f.pts, gs.bobX, gs.bobY);
  makeRipple(gs.bobX, gs.bobY, 65);
  const activeBaits=BAITS.filter(b=>b.qty>0);
  if(activeBaits.length>0) activeBaits[0].qty--;
  saveGame();
  syncLeaderboard();
}

function calcPrice(f) {
  return Math.round(parseFloat(f.weight) * f.coins);
}

function updateCatchPopupFish(f) {
  const g=document.querySelector('#fishG');
  if(g){
    g.children[0].setAttribute('stop-color', lighten(f.col,40));
    g.children[1].setAttribute('stop-color', f.col);
  }
}
function lighten(hex,amt){
  const n=parseInt(hex.replace('#',''),16);
  return `rgb(${Math.min(255,(n>>16)+amt)},${Math.min(255,((n>>8)&0xff)+amt)},${Math.min(255,(n&0xff)+amt)})`;
}

function showScorePop(txt, x, y) {
  const p=document.createElement('div'); p.className='score-pop';
  p.textContent=txt; p.style.left=x+'px'; p.style.top=(y-20)+'px';
  fishingScreen.appendChild(p);
  setTimeout(()=>p.remove(), 1800);
}

// ============================================================
// KEEP / SELL (popup buttons)
// ============================================================
function resetCatchPopup() {
  document.getElementById('catch-fish-svg').style.display = '';
  document.getElementById('catch-pokemon-emoji').style.display = 'none';
  document.getElementById('catch-pokemon-emoji').textContent = '';
  document.getElementById('catch-sell-btn').style.display = '';
}

function keepFish() {
  document.getElementById('catch-popup').classList.remove('show');
  resetCatchPopup();
  const f=gs.currentCatch;
  if(!f) return;
  if(f.isPokemon) { afterCatch(); return; } // pokÃ©mon go to leaderboard only
  if(gs.inventory.length >= gs.maxInv) {
    showToast('ðŸŽ’ Ð˜Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€ÑŒ Ð¿Ð¾Ð»Ð¾Ð½! ÐŸÑ€Ð¾Ð´Ð°Ð¹ Ñ€Ñ‹Ð±Ñƒ.'); afterCatch(); return;
  }
  gs.inventory.push({...f});
  showToast(`ðŸŸ ${f.name} Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° Ð² ÑÑƒÐ¼ÐºÑƒ!`);
  afterCatch(); saveGame();
}

function sellFish() {
  document.getElementById('catch-popup').classList.remove('show');
  resetCatchPopup();
  const f=gs.currentCatch;
  if(!f) return;
  const price=calcPrice(f);
  gs.coins+=price;
  updateCoins();
  coinBurst(180, 350);
  showToast(`ðŸ’° ÐŸÑ€Ð¾Ð´Ð°Ð½Ð¾: ${f.name} Ð·Ð° ${price}ðŸª™`);
  afterCatch(); saveGame();
}

function afterCatch() {
  hint.style.display='block';
  hint.textContent='ÐÐ°Ð¶Ð¼Ð¸ Ð½Ð° Ð²Ð¾Ð´Ñƒ Ð´Ð»Ñ Ð·Ð°Ð±Ñ€Ð¾ÑÐ°';
}

function updateCoins() {
  document.getElementById('coins-display').textContent=gs.coins;
}
updateCoins();
document.getElementById('fish-count').textContent=gs.fishCount;
document.getElementById('score-val').textContent=gs.score;
document.getElementById('current-rod-name').textContent='Ð£Ð´Ð¾Ñ‡ÐºÐ°: '+gs.currentRod.name;

// ============================================================
// SELL ALL
// ============================================================
function sellAll() {
  if(!gs.inventory.length){ showToast('ðŸŽ’ Ð¡ÑƒÐ¼ÐºÐ° Ð¿ÑƒÑÑ‚Ð°!'); return; }
  const total=gs.inventory.reduce((s,f)=>s+calcPrice(f),0);
  gs.coins+=total; gs.inventory=[];
  updateCoins(); renderInventory();
  coinBurst(180, 300);
  showToast(`ðŸ’° ÐŸÑ€Ð¾Ð´Ð°Ð½Ð¾ Ð²ÑÑ‘ Ð·Ð° ${total}ðŸª™`); saveGame();
}

// ============================================================
// WATER CLICK â€” CAST or CATCH
// ============================================================
fishingScreen.addEventListener('click', e=>{
  if(gs.currentScreen!=='fishing') return;
  if(gs.phase==='bite'){ catchFish(); return; }
  if(gs.phase!=='idle') return;
  const rect=fishingScreen.getBoundingClientRect();
  const scaleWrapper=document.getElementById('game-scale-wrapper');
  const scaleStr=scaleWrapper.style.transform;
  const scale=scaleStr ? parseFloat(scaleStr.replace('scale(','')) : 1;
  const x=(e.clientX-rect.left)/scale;
  const y=(e.clientY-rect.top)/scale;
  const waterTop=fishingScreen.offsetHeight*0.39+54;
  const toolbarTop=fishingScreen.offsetHeight-140;
  if(y < waterTop) return;
  if(y > toolbarTop) return;
  castTo(x, y);
});
biteEl.addEventListener('click', catchFish);

// ============================================================
// TOOL SELECT
// ============================================================
function selectTool(t) {
  document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('btn-'+t).classList.add('active');
}

// ============================================================
// ENERGY
// ============================================================
let eDir=1;
setInterval(()=>{
  gs.energy+=eDir*.055;
  if(gs.energy>=100){gs.energy=100;eDir=-1;}
  if(gs.energy<=12) {gs.energy=12; eDir=1;}
  document.getElementById('energyfill').style.width=gs.energy+'%';
}, 100);

// ============================================================
// AMBIENT RIPPLES
// ============================================================
function ambientRipple() {
  const wTop = 240;
  const x=30+Math.random()*(280);
  const y=wTop+Math.random()*(200);
  makeRipple(x,y,18);
  setTimeout(ambientRipple, 6000+Math.random()*5000);
}
setTimeout(ambientRipple, 4000);

// ============================================================
// RAIN LOOP
// ============================================================
function rainLoop() {
  drawRain();
  requestAnimationFrame(rainLoop);
}
rainLoop();

// ============================================================
// SCREEN SWITCH
// ============================================================
function switchScreen(name) {
  gs.currentScreen=name;
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.navtab').forEach(t=>t.classList.remove('active'));
  if(name === 'leaderboard') {
    document.getElementById('leaderboard-screen').classList.add('active');
    document.getElementById('nav-lb').classList.add('active');
    renderLeaderboard();
    updatePlayerLocation('leaderboard');
    return;
  }
  const map={fishing:'fishing-screen',shop:'shop-screen',inventory:'inventory-screen',multi:'multi-screen',garden:'garden-screen'};
  const navMap={fishing:'nav-fish',shop:'nav-shop',inventory:'nav-inv',multi:'nav-multi',garden:'nav-garden'};
  document.getElementById(map[name]).classList.add('active');
  document.getElementById(navMap[name]).classList.add('active');
  if(name==='shop')      renderShop();
  if(name==='inventory') renderInventory();
  if(name==='garden')    renderGarden();
  if(name==='multi')     renderMultiScreen();
  // Update location in Firebase if in a room
  updatePlayerLocation(name);
}

// ============================================================
// SHOP RENDER
// ============================================================
let currentShopTab='rods';
function switchShopTab(tab, el) {
  currentShopTab=tab;
  document.querySelectorAll('.shop-tab').forEach(t=>t.classList.remove('active'));
  if(el) el.classList.add('active');
  renderShop();
}

function renderShop() {
  const body=document.getElementById('shop-body');
  body.innerHTML='';
  if(currentShopTab==='rods')          renderRods(body);
  else if(currentShopTab==='bait')     renderBaits(body);
  else if(currentShopTab==='lures')    renderLures(body);
  else if(currentShopTab==='upgrades') renderUpgrades(body);
  else if(currentShopTab==='pikabufs') renderPikabufs(body);
}

function makeShopItem(iconHtml, name, desc, stats, priceHtml, btnHtml, extraClass) {
  const el=document.createElement('div');
  el.className='shop-item'+(extraClass?' '+extraClass:'');
  el.innerHTML=`
    <div class="shop-item-icon">${iconHtml}</div>
    <div class="shop-item-info">
      <div class="shop-item-name">${name}</div>
      <div class="shop-item-desc">${desc}</div>
      <div class="shop-item-stats">${stats}</div>
      ${priceHtml?`<div class="shop-item-price">ðŸª™ ${priceHtml}</div>`:''}
    </div>
    ${btnHtml}
  `;
  return el;
}

function rodIconSVG(rod) {
  const colors={wood:'#8b5e2a',bamboo:'#6a9030',carbon:'#405868',magic:'#9040c0',golden:'#d4a020'};
  const c=colors[rod.id]||'#8b5e2a';
  const glow=rod.id==='magic'?'filter:drop-shadow(0 0 6px rgba(160,50,255,.8));':'';
  return `<svg viewBox="0 0 52 52" xmlns="http://www.w3.org/2000/svg" style="${glow}">
    <circle cx="26" cy="26" r="24" fill="rgba(0,0,0,.35)" stroke="${c}" stroke-width="2.5"/>
    <line x1="40" y1="12" x2="12" y2="40" stroke="${c}" stroke-width="5" stroke-linecap="round"/>
    <circle cx="19" cy="33" r="5" fill="none" stroke="#888" stroke-width="2"/>
    <circle cx="19" cy="33" r="2" fill="#888"/>
    <line x1="40" y1="12" x2="45" y2="30" stroke="rgba(220,210,180,.5)" stroke-width="1" stroke-dasharray="2,2"/>
    ${rod.id==='golden'?'<polygon points="26,8 28,15 35,15 30,19 32,26 26,22 20,26 22,19 17,15 24,15" fill="rgba(255,220,30,.3)" stroke="rgba(255,200,20,.5)" stroke-width="0.5"/>':''}
    ${rod.id==='magic'?'<circle cx="40" cy="12" r="4" fill="rgba(180,80,255,.5)" stroke="rgba(200,100,255,.8)" stroke-width="1"/>':''}
  </svg>`;
}

function renderRods(body) {
  RODS.forEach(rod=>{
    const owned=rod.owned||false;
    const equipped=rod.equipped||false;
    let btnHtml;
    if(equipped) {
      btnHtml=`<button class="shop-item-btn btn-equipped-shop">âœ“ ÐÐ°Ð´ÐµÑ‚Ð°</button>`;
    } else if(owned) {
      btnHtml=`<button class="shop-item-btn btn-equip-shop" onclick="equipRod('${rod.id}')">ÐÐ°Ð´ÐµÑ‚ÑŒ</button>`;
    } else {
      btnHtml=`<button class="shop-item-btn btn-buy-shop" onclick="buyRod('${rod.id}')">ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ</button>`;
    }
    const cls=equipped?'equipped':owned?'owned':'';
    const el=makeShopItem(
      rodIconSVG(rod), rod.name, rod.desc, rod.stats,
      owned?'':rod.price, btnHtml, cls
    );
    body.appendChild(el);
  });
}

function renderBaits(body) {
  BAITS.forEach(b=>{
    const cost=b.price*5;
    const canBuy=gs.coins>=cost;
    const el=makeShopItem(
      `<span style="font-size:36px;animation:toolBounce 1.8s ease-in-out infinite;">${b.icon}</span>`,
      `${b.name} (Ã—${b.qty})`,
      b.desc,
      `ÐšÐ»Ñ‘Ð²: +${Math.round(b.biteBonus*100)}%`,
      `${cost} Ð·Ð° Ã—5`,
      `<button class="shop-item-btn btn-buy-shop" onclick="buyBait('${b.id}')"${canBuy?'':' style="opacity:.5"'}>+5ÑˆÑ‚</button>`,
      ''
    );
    body.appendChild(el);
  });
}

function renderLures(body) {
  LURES.forEach(l=>{
    const cost=l.price*3;
    const canBuy=gs.coins>=cost;
    const el=makeShopItem(
      `<span style="font-size:36px;animation:toolSpin 5s linear infinite;">${l.icon}</span>`,
      `${l.name} (Ã—${l.qty})`,
      l.desc,
      `Ð ÐµÐ´ÐºÐ¾ÑÑ‚ÑŒ: +${Math.round(l.rareBonus*100)}%`,
      `${cost} Ð·Ð° Ã—3`,
      `<button class="shop-item-btn btn-buy-shop" onclick="buyLure('${l.id}')"${canBuy?'':' style="opacity:.5"'}>+3ÑˆÑ‚</button>`,
      ''
    );
    body.appendChild(el);
  });
}

function renderUpgrades(body) {
  UPGRADES.forEach(u=>{
    const owned=u.owned||false;
    const canBuy=!owned && gs.coins>=u.price;
    const btnHtml=owned
      ?`<button class="shop-item-btn btn-owned-shop">âœ“ ÐšÑƒÐ¿Ð»ÐµÐ½Ð¾</button>`
      :`<button class="shop-item-btn btn-buy-shop" onclick="buyUpgrade('${u.id}')"${canBuy?'':' style="opacity:.5"'}>ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ</button>`;
    const el=makeShopItem(
      `<span style="font-size:36px;animation:toolPulse 2s ease-in-out infinite;">âš¡</span>`,
      u.name, u.desc, u.effect,
      owned?'':u.price, btnHtml, owned?'owned':''
    );
    body.appendChild(el);
  });
}

// ============================================================
// BUY FUNCTIONS â€” FIXED: proper coin check and deduction
// ============================================================
function buyRod(id) {
  const rod=RODS.find(r=>r.id===id);
  if(!rod||rod.owned) return;
  if(gs.coins < rod.price) { showToast('âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¼Ð¾Ð½ÐµÑ‚! ÐÑƒÐ¶Ð½Ð¾: '+rod.price+'ðŸª™'); return; }
  gs.coins -= rod.price;
  rod.owned=true;
  updateCoins(); renderShop();
  showToast(`ðŸŽ£ ${rod.name} ÐºÑƒÐ¿Ð»ÐµÐ½Ð°!`);
  coinBurst(180,350); saveGame();
}

function equipRod(id) {
  const rod=RODS.find(r=>r.id===id);
  if(!rod||!rod.owned) return;
  RODS.forEach(r=>{r.equipped=false;});
  rod.equipped=true;
  gs.currentRod=rod;
  document.getElementById('current-rod-name').textContent='Ð£Ð´Ð¾Ñ‡ÐºÐ°: '+rod.name;
  renderShop();
  showToast(`ðŸŽ£ ÐÐ°Ð´ÐµÑ‚Ð°: ${rod.name}`); saveGame();
  updateRodVisual();
}

function buyBait(id) {
  const b=BAITS.find(b=>b.id===id);
  if(!b) return;
  const cost=b.price*5;
  if(gs.coins < cost) { showToast(`âŒ ÐÑƒÐ¶Ð½Ð¾ ${cost}ðŸª™, Ñƒ Ñ‚ÐµÐ±Ñ ${gs.coins}ðŸª™`); return; }
  gs.coins-=cost; b.qty+=5;
  updateCoins(); renderShop();
  showToast(`${b.icon} ${b.name} Ã—5 ÐºÑƒÐ¿Ð»ÐµÐ½Ð¾!`); saveGame();
}

function buyLure(id) {
  const l=LURES.find(l=>l.id===id);
  if(!l) return;
  const cost=l.price*3;
  if(gs.coins < cost) { showToast(`âŒ ÐÑƒÐ¶Ð½Ð¾ ${cost}ðŸª™, Ñƒ Ñ‚ÐµÐ±Ñ ${gs.coins}ðŸª™`); return; }
  gs.coins-=cost; l.qty+=3;
  updateCoins(); renderShop();
  showToast(`${l.icon} ${l.name} Ã—3 ÐºÑƒÐ¿Ð»ÐµÐ½Ð¾!`); saveGame();
}

function buyUpgrade(id) {
  const u=UPGRADES.find(u=>u.id===id);
  if(!u||u.owned) return;
  if(gs.coins < u.price) { showToast(`âŒ ÐÑƒÐ¶Ð½Ð¾ ${u.price}ðŸª™, Ñƒ Ñ‚ÐµÐ±Ñ ${gs.coins}ðŸª™`); return; }
  gs.coins-=u.price; u.owned=true;
  if(id==='bigger_bag') gs.maxInv=30;
  updateCoins(); renderShop();
  showToast(`âš¡ ${u.name} ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð¾!`); saveGame();
}

// ============================================================
// INVENTORY RENDER
// ============================================================
function renderInventory() {
  const body=document.getElementById('inv-body');
  body.innerHTML='';
  let total=0;
  for(let i=0;i<gs.maxInv;i++){
    const slot=document.createElement('div');
    if(i<gs.inventory.length){
      const f=gs.inventory[i];
      const price=calcPrice(f);
      total+=price;
      slot.className='inv-slot';
      slot.title=`ÐŸÑ€Ð¾Ð´Ð°Ñ‚ÑŒ ${f.name}`;
      slot.innerHTML=`
        <svg class="inv-fish-svg" width="48" height="26" viewBox="0 0 48 26" xmlns="http://www.w3.org/2000/svg">
          <ellipse cx="20" cy="13" rx="17" ry="9" fill="${f.col}"/>
          <polygon points="37,13 48,7 48,19" fill="${f.col2}"/>
          <circle cx="8" cy="11" r="2.5" fill="#fff" stroke="#333" stroke-width=".5"/>
          <circle cx="7.5" cy="11" r="1.2" fill="#111"/>
        </svg>
        <div class="inv-fish-name">${f.name}</div>
        <div class="inv-fish-weight">${f.weight}ÐºÐ³</div>
        <div class="inv-coins-small">ðŸª™${price}</div>
      `;
      slot.onclick=()=>sellOne(i);
    } else {
      slot.className='inv-slot empty';
      slot.innerHTML='<div style="font-size:22px;opacity:.25;">ðŸª£</div>';
    }
    body.appendChild(slot);
  }
  document.getElementById('sell-all-amount').textContent=total;
  document.getElementById('inv-total').textContent=total;
}

function sellOne(idx) {
  const f=gs.inventory[idx];
  if(!f) return;
  const price=calcPrice(f);
  gs.coins+=price;
  gs.inventory.splice(idx,1);
  updateCoins(); renderInventory();
  coinBurst(180,300);
  showToast(`ðŸ’° ${f.name} Ð¿Ñ€Ð¾Ð´Ð°Ð½Ð° Ð·Ð° ${price}ðŸª™`); saveGame();
}

// ============================================================
// GARDEN SYSTEM
// ============================================================
const SEEDS = [
  {id:'rose',     name:'Ð Ð¾Ð·Ð°',       bag:'ðŸŒ¹', seed:'ðŸŒ±', flower:'ðŸŒ¹', color:'#e05060',
   desc:'ÐšÐ»Ð°ÑÑÐ¸Ñ‡ÐµÑÐºÐ°Ñ ÐºÑ€Ð°ÑÐ°Ð²Ð¸Ñ†Ð°',    flowerDesc:'ÐÐ»Ð°Ñ Ñ€Ð¾Ð·Ð° Ñ Ð½ÐµÐ¶Ð½Ñ‹Ð¼ Ð°Ñ€Ð¾Ð¼Ð°Ñ‚Ð¾Ð¼. Ð”Ð¾Ð»Ð³Ð¾ Ñ€Ð°ÑÑ‚Ñ‘Ñ‚, Ð½Ð¾ Ð´Ð¾Ñ€Ð¾Ð³Ð¾ ÑÑ‚Ð¾Ð¸Ñ‚.',
   growTime:60000, price:25, sellPrice:40, owned:0},
  {id:'sunflower',name:'ÐŸÐ¾Ð´ÑÐ¾Ð»Ð½ÑƒÑ…',  bag:'ðŸŒ»', seed:'ðŸŒ¾', flower:'ðŸŒ»', color:'#f0c020',
   desc:'Ð¯Ñ€ÐºÐ¸Ð¹ Ð¸ Ð¶Ð¸Ð·Ð½ÐµÑ€Ð°Ð´Ð¾ÑÑ‚Ð½Ñ‹Ð¹',   flowerDesc:'Ð‘Ð¾Ð»ÑŒÑˆÐ¾Ð¹ Ð¶Ñ‘Ð»Ñ‚Ñ‹Ð¹ Ñ†Ð²ÐµÑ‚Ð¾Ðº, Ñ‚ÑÐ½ÐµÑ‚ÑÑ Ðº ÑÐ¾Ð»Ð½Ñ†Ñƒ. Ð‘Ñ‹ÑÑ‚Ñ€Ð¾ Ñ€Ð°ÑÑ‚Ñ‘Ñ‚!',
   growTime:30000, price:15, sellPrice:22, owned:0},
  {id:'tulip',    name:'Ð¢ÑŽÐ»ÑŒÐ¿Ð°Ð½',    bag:'ðŸŒ·', seed:'ðŸŒ±', flower:'ðŸŒ·', color:'#e06090',
   desc:'Ð’ÐµÑÐµÐ½Ð½Ð¸Ð¹ Ð»ÑŽÐ±Ð¸Ð¼ÐµÑ†',          flowerDesc:'ÐÐµÐ¶Ð½Ñ‹Ð¹ Ñ‚ÑŽÐ»ÑŒÐ¿Ð°Ð½ Ñ€Ð°ÑÑ†Ð²ÐµÑ‚Ð°ÐµÑ‚ Ð·Ð° ÑÑ€ÐµÐ´Ð½ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ.',
   growTime:45000, price:20, sellPrice:32, owned:0},
  {id:'daisy',    name:'Ð Ð¾Ð¼Ð°ÑˆÐºÐ°',    bag:'ðŸŒ¼', seed:'ðŸ«˜', flower:'ðŸŒ¼', color:'#f0f0a0',
   desc:'ÐŸÑ€Ð¾ÑÑ‚Ð°Ñ Ð¸ ÐºÑ€Ð°ÑÐ¸Ð²Ð°Ñ',        flowerDesc:'Ð‘ÐµÐ»Ð°Ñ Ñ€Ð¾Ð¼Ð°ÑˆÐºÐ° â€” ÑÐ¸Ð¼Ð²Ð¾Ð» Ñ‡Ð¸ÑÑ‚Ð¾Ñ‚Ñ‹. Ð¡Ð°Ð¼Ð°Ñ Ð´ÐµÑˆÑ‘Ð²Ð°Ñ!',
   growTime:20000, price:8,  sellPrice:12, owned:0},
  {id:'orchid',   name:'ÐžÑ€Ñ…Ð¸Ð´ÐµÑ',    bag:'ðŸª·', seed:'ðŸŒ±', flower:'ðŸª·', color:'#c070e0',
   desc:'Ð ÐµÐ´ÐºÐ°Ñ ÑÐºÐ·Ð¾Ñ‚Ð¸ÐºÐ°',           flowerDesc:'ÐšÐ°Ð¿Ñ€Ð¸Ð·Ð½Ð°Ñ ÐºÑ€Ð°ÑÐ°Ð²Ð¸Ñ†Ð°. Ð”Ð¾Ð»Ð³Ð¾ Ñ€Ð°ÑÑ‚Ñ‘Ñ‚ Ð½Ð¾ Ð¾Ñ‡ÐµÐ½ÑŒ Ð´Ð¾Ñ€Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾Ð´Ð°Ñ‘Ñ‚ÑÑ!',
   growTime:120000,price:60, sellPrice:120, owned:0},
  {id:'clover',   name:'ÐšÐ»ÐµÐ²ÐµÑ€',     bag:'ðŸ€', seed:'ðŸ«˜', flower:'ðŸ€', color:'#40c060',
   desc:'ÐÐ° ÑƒÐ´Ð°Ñ‡Ñƒ!',                 flowerDesc:'Ð§ÐµÑ‚Ñ‹Ñ€Ñ‘Ñ…Ð»Ð¸ÑÑ‚Ð½Ñ‹Ð¹ ÐºÐ»ÐµÐ²ÐµÑ€ Ð¿Ñ€Ð¸Ð½Ð¾ÑÐ¸Ñ‚ ÑƒÐ´Ð°Ñ‡Ñƒ Ð² Ñ€Ñ‹Ð±Ð°Ð»ÐºÐµ (+10% ÐºÐ»Ñ‘Ð²).',
   growTime:40000, price:30, sellPrice:30, owned:0, bonusEffect:'bite'},
];

const GARDEN_PLOTS = 6; // 3 left + 3 right
let gardenPlots = []; // {seedId, plantedAt, state:'empty'|'seeded'|'growing'|'ready'}
let gardenFlowersSold = 0;

function initGardenPlots() {
  if(gardenPlots.length === 0) {
    for(let i=0;i<GARDEN_PLOTS;i++) gardenPlots.push({seedId:null,plantedAt:0,state:'empty'});
  }
}
initGardenPlots();

function gardenGrowInterval() {
  gardenPlots.forEach((p,i)=>{
    if(p.state==='seeded'||p.state==='growing') {
      const seed = SEEDS.find(s=>s.id===p.seedId);
      if(!seed) return;
      const elapsed = Date.now()-p.plantedAt;
      if(elapsed >= seed.growTime) { p.state='ready'; }
      else if(elapsed >= seed.growTime*0.3) { p.state='growing'; }
    }
  });
  if(gs.currentScreen==='garden') renderGardenPlots();
}
setInterval(gardenGrowInterval, 2000);

function renderGarden() {
  renderGardenPlots();
}

function renderGardenPlots() {
  const leftEl  = document.getElementById('garden-plots-left');
  const rightEl = document.getElementById('garden-plots-right');
  if(!leftEl || !rightEl) return;
  leftEl.innerHTML=''; rightEl.innerHTML='';
  gardenPlots.forEach((p,i)=>{
    const el=document.createElement('div');
    const seed=p.seedId?SEEDS.find(s=>s.id===p.seedId):null;
    let icon='ðŸŒ¿', label='', prog=0;
    if(p.state==='empty')   { icon='ðŸŸ«'; label='ÐŸÑƒÑÑ‚Ð¾'; }
    if(p.state==='seeded')  { icon=seed?seed.seed:'ðŸŒ±'; label='ÐŸÐ¾ÑÐµÑÐ½Ð¾'; prog=15; }
    if(p.state==='growing') { icon=seed?seed.seed:'ðŸŒ¿'; label='Ð Ð°ÑÑ‚Ñ‘Ñ‚'; prog=seed?Math.min(90,((Date.now()-p.plantedAt)/seed.growTime)*100):50; }
    if(p.state==='ready')   { icon=seed?seed.flower:'ðŸŒ¸'; label='Ð“Ð¾Ñ‚Ð¾Ð²Ð¾!'; prog=100; }
    el.className=`gdn-plot ${p.state}`;
    el.innerHTML=`<div class="gdn-plot-icon">${icon}</div><div class="gdn-plot-label">${label}</div>${p.state!=='empty'?`<div class="gdn-progress"><div class="gdn-progress-fill" style="width:${prog}%"></div></div>`:''}`;
    el.onclick=()=>clickPlot(i);
    (i<3?leftEl:rightEl).appendChild(el);
  });
}

function clickPlot(idx) {
  const p=gardenPlots[idx];
  if(p.state==='ready') { harvestPlot(idx); return; }
  if(p.state!=='empty') { showToast('â³ Ð•Ñ‰Ñ‘ Ñ€Ð°ÑÑ‚Ñ‘Ñ‚...'); return; }
  // Show seed picker
  showSeedPicker(idx);
}

function showSeedPicker(plotIdx) {
  const ownedSeeds=SEEDS.filter(s=>s.owned>0);
  if(!ownedSeeds.length) { showToast('ðŸŒ± ÐšÑƒÐ¿Ð¸ ÑÐµÐ¼ÐµÐ½Ð° Ð² Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ðµ!'); return; }
  // Simple picker via toast sequence
  ownedSeeds.forEach((s,i)=>{
    setTimeout(()=>{
      const el=document.createElement('div');
      el.style.cssText=`position:absolute;left:50%;transform:translateX(-50%);top:${130+i*46}px;z-index:300;background:rgba(20,60,10,.97);border:2px solid #4a7a18;border-radius:14px;padding:8px 18px;font-family:'Neucha',cursive;font-size:13px;color:#a0f060;cursor:pointer;white-space:nowrap;`;
      el.innerHTML=`${s.flower} ${s.name} (Ã—${s.owned}) â€” Ð¡Ð°Ð¶Ð°Ñ‚ÑŒ?`;
      el.onclick=()=>{ plantSeed(plotIdx,s.id); document.querySelectorAll('.seed-picker-item').forEach(x=>x.remove()); };
      el.className='seed-picker-item';
      document.getElementById('garden-screen').appendChild(el);
      setTimeout(()=>el.remove(), 5000);
    },0);
  });
}

function plantSeed(plotIdx, seedId) {
  const seed=SEEDS.find(s=>s.id===seedId);
  if(!seed||seed.owned<=0) return;
  seed.owned--;
  gardenPlots[plotIdx]={seedId,plantedAt:Date.now(),state:'seeded'};
  renderGardenPlots();
  showToast(`ðŸŒ± ${seed.name} Ð¿Ð¾ÑÐ°Ð¶ÐµÐ½Ð°!`);
  saveGame(); saveGarden();
  if(gs.fullMultiMode) syncGardenToFirebase();
}

function harvestPlot(idx) {
  const p=gardenPlots[idx];
  const seed=SEEDS.find(s=>s.id===p.seedId);
  if(!seed) return;
  const price=seed.sellPrice;
  gs.coins+=price;
  gardenFlowersSold++;
  gardenPlots[idx]={seedId:null,plantedAt:0,state:'empty'};
  updateCoins();
  renderGardenPlots();
  coinBurst(180,350);
  showToast(`${seed.flower} ${seed.name} Ð¿Ñ€Ð¾Ð´Ð°Ð½Ð° Ð·Ð° ${price}ðŸª™!`);
  if(seed.bonusEffect==='bite') showToast('ðŸ€ Ð‘Ð¾Ð½ÑƒÑ ÐºÐ»Ñ‘Ð²Ð° +10% Ð½Ð° 60Ñ!');
  saveGame(); saveGarden();
  if(gs.fullMultiMode) syncGardenToFirebase();
}

function harvestAll() {
  let total=0;
  gardenPlots.forEach((p,i)=>{
    if(p.state==='ready') {
      const seed=SEEDS.find(s=>s.id===p.seedId);
      if(seed){ total+=seed.sellPrice; gardenFlowersSold++; gardenPlots[i]={seedId:null,plantedAt:0,state:'empty'}; }
    }
  });
  if(!total){ showToast('ðŸŒ± ÐÐµÑ‡ÐµÐ³Ð¾ ÑÐ¾Ð±Ð¸Ñ€Ð°Ñ‚ÑŒ!'); return; }
  gs.coins+=total; updateCoins(); renderGardenPlots();
  coinBurst(180,350);
  showToast(`ðŸŒ¸ Ð¡Ð¾Ð±Ñ€Ð°Ð½Ð¾ Ð½Ð° ${total}ðŸª™!`);
  saveGame(); saveGarden();
  if(gs.fullMultiMode) syncGardenToFirebase();
}

// ============================================================
// GARDEN ROAD / SHOP ANIMATIONS
// ============================================================
let gardenScene = 'garden'; // 'garden' | 'road' | 'seedshop'

function fadeScene(cb) {
  const fade=document.getElementById('scene-fade');
  fade.classList.add('fading');
  setTimeout(()=>{ cb(); fade.classList.remove('fading'); }, 650);
}

function showGardenScene(name) {
  gardenScene=name;
  document.getElementById('gscene-garden').style.display='none';
  document.getElementById('gscene-road').style.display='none';
  document.getElementById('gscene-seedshop').style.display='none';
  const kioskEl = document.getElementById('gscene-kiosk');
  if(kioskEl) kioskEl.style.display='none';
  if(name==='garden')    document.getElementById('gscene-garden').style.display='block';
  if(name==='road')      document.getElementById('gscene-road').style.display='block';
  if(name==='seedshop')  document.getElementById('gscene-seedshop').style.display='flex';
  if(name==='kiosk' && kioskEl) kioskEl.style.display='flex';
}

function walkToShop() {
  fadeScene(()=>{
    showGardenScene('road');
    document.getElementById('road-hint').textContent='Ð˜Ð´Ñ‘Ð¼ Ð² Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½...';
    const walker=document.getElementById('walker');
    walker.className='walker to-shop';
    walker.style.bottom='200px';
    updatePlayerLocation('garden-road');
    setTimeout(()=>{
      document.getElementById('road-hint').textContent='ÐŸÑ€Ð¸ÑˆÐ»Ð¸! Ð—Ð°Ñ…Ð¾Ð´Ð¸Ð¼?';
      // Open door animation
      const door=document.getElementById('shop-door');
      door.classList.add('open');
      setTimeout(()=>{
        door.classList.remove('open');
        fadeScene(()=>{ showGardenScene('seedshop'); renderSeedShop(); updatePlayerLocation('garden-shop'); });
      }, 800);
    }, 2500);
  });
}

function enterShop() {
  const door=document.getElementById('shop-door');
  door.classList.add('open');
  setTimeout(()=>{
    door.classList.remove('open');
    fadeScene(()=>{ showGardenScene('seedshop'); renderSeedShop(); updatePlayerLocation('garden-shop'); });
  }, 700);
}

function leaveShop() {
  fadeScene(()=>{
    showGardenScene('road');
    document.getElementById('road-hint').textContent='Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ÑÑ...';
    const walker=document.getElementById('walker');
    walker.style.bottom='580px'; walker.className='walker from-shop';
    updatePlayerLocation('garden-road');
    setTimeout(()=>{
      fadeScene(()=>{ showGardenScene('garden'); renderGardenPlots(); updatePlayerLocation('garden'); });
    }, 2100);
  });
}

function renderSeedShop() {
  const container=document.getElementById('seedshop-items');
  container.innerHTML='';
  SEEDS.forEach(seed=>{
    const canBuy=gs.coins>=seed.price;
    const el=document.createElement('div');
    el.className='seed-pack';
    el.innerHTML=`
      <div class="seed-pack-left">
        <div class="seed-pack-bag" style="background:rgba(60,30,10,.8);border-color:${seed.color}44;">${seed.bag}</div>
      </div>
      <div class="seed-pack-info">
        <div class="seed-pack-name">${seed.name}</div>
        <div class="seed-pack-desc">${seed.desc}</div>
        <div class="seed-pack-flower">
          <div class="seed-pack-flower-icon">${seed.flower}</div>
          <div class="seed-pack-flower-desc">${seed.flowerDesc}</div>
        </div>
        <div class="seed-pack-price">ðŸª™ ${seed.price} <span style="color:#6a5030;font-size:10px;">â†’ Ð¿Ñ€Ð¾Ð´Ð°Ñ‚ÑŒ Ð·Ð° ${seed.sellPrice}ðŸª™</span></div>
        <div style="display:flex;align-items:center;gap:8px;margin-top:6px;">
          <div class="seed-buy-btn" onclick="buySeed('${seed.id}')${canBuy?'':";showToast('âŒ ÐÐµÑ‚ Ð¼Ð¾Ð½ÐµÑ‚!')"}" style="${canBuy?'':'opacity:.4;'}">ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ Ã—1</div>
          <div style="font-family:'Neucha',cursive;font-size:11px;color:#6a5030;">Ð’ Ð·Ð°Ð¿Ð°ÑÐµ: ${seed.owned}</div>
        </div>
      </div>`;
    container.appendChild(el);
  });
}

function buySeed(id) {
  const seed=SEEDS.find(s=>s.id===id);
  if(!seed) return;
  if(gs.coins<seed.price){ showToast('âŒ ÐÐµÑ‚ Ð¼Ð¾Ð½ÐµÑ‚!'); return; }
  gs.coins-=seed.price; seed.owned++;
  updateCoins(); renderSeedShop();
  showToast(`${seed.bag} ÐšÑƒÐ¿Ð»ÐµÐ½Ð¾: ${seed.name}!`);
  saveGame(); saveGarden();
}

// ============================================================
// FIREBASE MULTIPLAYER â€” IMPROVED
// ============================================================
let firebaseApp=null, firebaseDB=null;
let currentRoomId=null;
let myPlayerId='player_'+Math.random().toString(36).substr(2,8);
let myPlayerName='Ð Ñ‹Ð±Ð°Ðº '+Math.floor(Math.random()*999);
let playersData={};
let heartbeatInterval=null;
let connectionStatus='offline';

gs.fullMultiMode=false;

const FIREBASE_CONFIG={
  apiKey:"AIzaSyAQKXcmFEKBKsZvLbqDCGudVTLBQVV9R7o",
  authDomain:"fishingonlinereborn.firebaseapp.com",
  databaseURL:"https://fishingonlinereborn-default-rtdb.firebaseio.com",
  projectId:"fishingonlinereborn",
  storageBucket:"fishingonlinereborn.firebasestorage.app",
  messagingSenderId:"104300782903",
  appId:"1:104300782903:web:8db9d1c0a930959994a6b2"
};

const fb={
  r:(path)=>window._fbRef(firebaseDB,path),
  set:(path,val)=>window._fbSet(fb.r(path),val),
  upd:(path,val)=>window._fbUpdate(fb.r(path),val),
  on:(path,cb)=>window._fbOnValue(fb.r(path),cb),
  get:(path)=>window._fbGet(fb.r(path)),
  rm:(path)=>window._fbRemove(fb.r(path)),
};

async function initFirebase() {
  if(firebaseApp) return true;
  setConnectionStatus('connecting');
  try {
    // Use compat SDK loaded via <script> tags â€” avoids dynamic import() CSP issues
    if(typeof firebase === 'undefined') throw new Error('Firebase compat SDK not loaded');
    // Reuse existing app if already initialized (e.g. hot reload)
    firebaseApp = firebase.apps.length ? firebase.app() : firebase.initializeApp(FIREBASE_CONFIG);
    firebaseDB  = firebase.database();
    // Map compat API to the same internal helpers the rest of the code uses
    window._fbRef        = (db, path) => db.ref(path);
    window._fbSet        = (ref, val) => ref.set(val);
    window._fbOnValue    = (ref, cb)  => { ref.on('value', cb); return cb; };
    window._fbGet        = (ref)      => ref.get();
    window._fbUpdate     = (ref, val) => ref.update(val);
    window._fbRemove     = (ref)      => ref.remove();
    window._fbOnDisconnect = (ref)    => ref.onDisconnect();
    setConnectionStatus('online');
    return true;
  } catch(e){
    console.warn('Firebase init failed', e);
    setConnectionStatus('offline');
    showToast('âš ï¸ ÐÐµÑ‚ Ð¸Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚-ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ');
    return false;
  }
}

function setConnectionStatus(status) {
  connectionStatus=status;
  const label=document.getElementById('session-label');
  if(!label) return;
  if(currentRoomId && status==='online') label.textContent=`ðŸŸ¢ ÐšÐ¾Ð¼Ð½Ð°Ñ‚Ð°: ${currentRoomId}`;
  else if(status==='connecting') label.textContent='ðŸŸ¡ ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ...';
  else label.textContent='ðŸ”´ ÐÐµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ñ‘Ð½';
}

function generateRoomCode() {
  const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let s=''; for(let i=0;i<4;i++) s+=c[Math.floor(Math.random()*c.length)]; return s;
}

async function createRoom() {
  const ok=await initFirebase(); if(!ok) return;
  const code=generateRoomCode();
  document.getElementById('room-code-input').value=code;
  try {
    await fb.set(`rooms/${code}`,{
      created:Date.now(), host:myPlayerId, fullMulti:false,
      sharedCoins:gs.coins, sharedFishCount:gs.fishCount, sharedFlowers:gardenFlowersSold,
      sharedInventory:JSON.stringify(gs.inventory), sharedGarden:JSON.stringify(gardenPlots),
    });
    await _joinRoomSetup(code);
    showToast(`âœ… ÐšÐ¾Ð¼Ð½Ð°Ñ‚Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð°: ${code}`);
  } catch(e){ console.error(e); showToast('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ'); }
}

async function joinRoom() {
  const code=document.getElementById('room-code-input').value.trim().toUpperCase();
  if(code.length<2){ showToast('Ð’Ð²ÐµÐ´Ð¸ ÐºÐ¾Ð´ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹!'); return; }
  const ok=await initFirebase(); if(!ok) return;
  try {
    const snap=await fb.get(`rooms/${code}`);
    if(!snap.exists()){ showToast(`âŒ ÐšÐ¾Ð¼Ð½Ð°Ñ‚Ð° ${code} Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°`); return; }
    await _joinRoomSetup(code);
    showToast(`âœ… Ð’Ð¾ÑˆÑ‘Ð» Ð² ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ ${code}`);
  } catch(e){ console.error(e); showToast('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ'); }
}

async function _joinRoomSetup(code) {
  currentRoomId=code;
  const presRef=fb.r(`rooms/${code}/players/${myPlayerId}`);
  await window._fbSet(presRef,{
    name:myPlayerName, location:gs.currentScreen, joinedAt:Date.now(),
    lastSeen:Date.now(), fishCaught:gs.fishCount, flowersSold:gardenFlowersSold, online:true
  });
  // Auto-remove when disconnected
  window._fbOnDisconnect(presRef).remove();
  // Heartbeat every 5s
  if(heartbeatInterval) clearInterval(heartbeatInterval);
  heartbeatInterval=setInterval(()=>{
    if(!currentRoomId) return;
    fb.upd(`rooms/${code}/players/${myPlayerId}`,{
      lastSeen:Date.now(), online:true,
      location:gs.currentScreen, fishCaught:gs.fishCount, flowersSold:gardenFlowersSold
    }).catch(()=>{});
  },5000);
  // Listen to room in real-time
  fb.on(`rooms/${code}`,(snap)=>{
    const data=snap.val(); if(!data) return;
    const now=Date.now();
    playersData={};
    if(data.players) Object.entries(data.players).forEach(([pid,p])=>{
      if(now-(p.lastSeen||0)<30000||pid===myPlayerId) playersData[pid]=p;
    });
    const remoteFullMulti=data.fullMulti||false;
    if(remoteFullMulti!==gs.fullMultiMode && data.lastToggler!==myPlayerId) {
      gs.fullMultiMode=remoteFullMulti;
      const tog=document.getElementById('full-multi-toggle');
      if(tog) tog.checked=gs.fullMultiMode;
      updateMultiRodVisibility();
    }
    if(gs.fullMultiMode && data.lastSyncer!==myPlayerId) {
      // Only accept remote coins if they're different and more recent
      if(data.sharedCoins!==undefined && data.sharedCoins!==gs.coins && data.lastSyncTime > (gs._lastLocalSync||0)){
        gs.coins=data.sharedCoins;updateCoins();
      }
      if(data.sharedFishCount!==undefined && data.sharedFishCount!==gs.fishCount){gs.fishCount=data.sharedFishCount;document.getElementById('fish-count').textContent=gs.fishCount;}
      if(data.sharedInventory){try{gs.inventory=JSON.parse(data.sharedInventory);}catch(e){}}
      if(data.sharedGarden){try{const pg=JSON.parse(data.sharedGarden);gardenPlots=pg;if(gs.currentScreen==='garden')renderGardenPlots();}catch(e){}}
    }
    if(gs.currentScreen==='multi') renderMultiScreen();
    updateNavPlayerDots();
  });
  setConnectionStatus('online');
  updateMultiRodVisibility();
  if(gs.currentScreen==='multi') renderMultiScreen();
}

async function leaveRoom() {
  if(!currentRoomId) return;
  try{ await fb.rm(`rooms/${currentRoomId}/players/${myPlayerId}`); }catch(e){}
  if(heartbeatInterval){clearInterval(heartbeatInterval);heartbeatInterval=null;}
  currentRoomId=null; playersData={}; gs.fullMultiMode=false;
  setConnectionStatus('offline'); updateMultiRodVisibility();
  showToast('ðŸ‘‹ Ð’Ñ‹ÑˆÐµÐ» Ð¸Ð· ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹');
  if(gs.currentScreen==='multi') renderMultiScreen();
}

function updateMultiRodVisibility() {
  const show=gs.fullMultiMode&&!!currentRoomId;
  document.getElementById('rod-wrapper2').style.display=show?'block':'none';
  document.getElementById('linecanvas2').style.display=show?'block':'none';
}

async function toggleFullMulti(enabled) {
  gs.fullMultiMode=enabled;
  document.getElementById('full-multi-note').style.display=enabled?'none':'block';
  document.getElementById('shared-stats-section').style.display=enabled?'block':'none';
  if(!currentRoomId){showToast('Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ð¾Ð¹Ð´Ð¸ Ð² ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ!');document.getElementById('full-multi-toggle').checked=false;gs.fullMultiMode=false;return;}
  if(!enabled){
    clearTimeout(partner2Timer);
    partnerPhase = 'idle';
    const lctx2el = document.getElementById('linecanvas2');
    if(lctx2el) lctx2el.getContext('2d').clearRect(0,0,360,700);
    await fairSplitAndDisable();
    return;
  }
  try{
    await fb.upd(`rooms/${currentRoomId}`,{
      fullMulti:true,lastToggler:myPlayerId,
      sharedCoins:gs.coins,sharedFishCount:gs.fishCount,sharedFlowers:gardenFlowersSold,
      sharedInventory:JSON.stringify(gs.inventory),sharedGarden:JSON.stringify(gardenPlots),
    });
    updateMultiRodVisibility();
    showToast('ðŸ‘¥ ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ð¼ÑƒÐ»ÑŒÑ‚Ð¸Ð¿Ð»ÐµÐµÑ€ Ð²ÐºÐ»ÑŽÑ‡Ñ‘Ð½!');
    setTimeout(()=>{ simulatePartner2(); }, 2000);
  }catch(e){showToast('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸');}
}

async function fairSplitAndDisable() {
  const n=Math.max(1,Object.keys(playersData).length);
  const myShare=Math.floor(gs.coins/n);
  gs.coins=myShare; gs.inventory=gs.inventory.slice(0,Math.ceil(gs.inventory.length/n));
  updateCoins();
  if(currentRoomId) await fb.upd(`rooms/${currentRoomId}`,{fullMulti:false,lastToggler:myPlayerId}).catch(()=>{});
  updateMultiRodVisibility();
  showToast(`ðŸ’° Ð§ÐµÑÑ‚Ð½Ñ‹Ð¹ Ñ€Ð°Ð·Ð´ÐµÐ»: ${myShare}ðŸª™ Ñ‚ÐµÐ±Ðµ!`);
  saveGame(); saveGarden();  
}

function syncGardenToFirebase() {
  if(!firebaseDB||!currentRoomId||!gs.fullMultiMode) return;
  fb.upd(`rooms/${currentRoomId}`,{sharedGarden:JSON.stringify(gardenPlots),sharedFlowers:gardenFlowersSold,lastSyncer:myPlayerId}).catch(()=>{});
}

function syncFishingToFirebase() {
  if(!firebaseDB||!currentRoomId||!gs.fullMultiMode) return;
  gs._lastLocalSync = Date.now();
  fb.upd(`rooms/${currentRoomId}`,{
    sharedCoins:gs.coins,
    sharedFishCount:gs.fishCount,
    sharedInventory:JSON.stringify(gs.inventory),
    lastSyncer:myPlayerId,
    lastSyncTime: gs._lastLocalSync
  }).catch(()=>{});
  _lastSyncedCoins = gs.coins;
  _lastSyncedFish = gs.fishCount;
}

function updatePlayerLocation(loc) {
  if(!firebaseDB||!currentRoomId) return;
  fb.upd(`rooms/${currentRoomId}/players/${myPlayerId}`,{location:loc}).catch(()=>{});
}

function updateNavPlayerDots() {
  document.querySelectorAll('.nav-player-dot').forEach(d=>d.style.display='none');
  const map={fishing:'nav-fish-dot',shop:'nav-shop-dot',inventory:'nav-inv-dot',garden:'nav-garden-dot','garden-road':'nav-garden-dot','garden-shop':'nav-garden-dot',multi:'nav-multi-dot'};
  Object.entries(playersData).forEach(([pid,p])=>{
    if(pid===myPlayerId) return;
    const el=document.getElementById(map[p.location]||'');
    if(el) el.style.display='block';
  });
}

function renderMultiScreen() {
  const list=document.getElementById('players-list'); if(!list) return;
  list.innerHTML='';
  const locE={fishing:'ðŸŽ£',shop:'ðŸª',inventory:'ðŸŽ’',garden:'ðŸŒ¸','garden-road':'ðŸš¶','garden-shop':'ðŸŒ±',multi:'ðŸŒ'};
  const locN={fishing:'Ð Ñ‹Ð±Ð°Ð»ÐºÐ°',shop:'Ð›Ð°Ð²ÐºÐ°',inventory:'Ð˜Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€ÑŒ',garden:'Ð¡Ð°Ð´','garden-road':'ÐÐ° Ð´Ð¾Ñ€Ð¾Ð¶ÐºÐµ','garden-shop':'ÐœÐ°Ð³Ð°Ð·Ð¸Ð½ ÑÐµÐ¼ÑÐ½',multi:'ÐžÐ½Ð»Ð°Ð¹Ð½'};
  const players=Object.entries(playersData);
  if(!players.length){
    list.innerHTML='<div style="font-family:\'Neucha\',cursive;font-size:12px;color:#3040a0;padding:8px 0;">Ð’Ð¾Ð¹Ð´Ð¸ Ð² ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ð¸Ð´ÐµÑ‚ÑŒ Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²</div>';
  } else {
    players.forEach(([pid,p])=>{
      const isMe=pid===myPlayerId;
      const online=Date.now()-(p.lastSeen||0)<15000;
      const loc=p.location||'fishing';
      const card=document.createElement('div'); card.className='multi-player-card';
      card.innerHTML=`
        <div class="player-avatar" style="${online?'box-shadow:0 0 10px rgba(80,200,100,.6);':''}">${isMe?'ðŸ˜Š':'ðŸŽ®'}</div>
        <div class="player-info">
          <div class="player-name">${p.name||'Ð Ñ‹Ð±Ð°Ðº'}${isMe?' <span style="font-size:10px;color:#4060a0;">(Ð’Ñ‹)</span>':''}</div>
          <div class="player-status">ðŸŸ${p.fishCaught||0} ðŸŒ¸${p.flowersSold||0} ${online?'<span style="color:#40c060;font-size:10px;">â— Ð¾Ð½Ð»Ð°Ð¹Ð½</span>':'<span style="color:#505060;font-size:10px;">â—‹ Ð½ÐµÑ‚</span>'}</div>
        </div>
        <div class="player-location-badge">${locE[loc]||'â“'} ${locN[loc]||loc}</div>`;
      list.appendChild(card);
    });
  }
  if(gs.fullMultiMode){
    const sc=document.getElementById('shared-coins');const sf=document.getElementById('shared-fish');const sfl=document.getElementById('shared-flowers');
    if(sc)sc.textContent=gs.coins; if(sf)sf.textContent=gs.fishCount; if(sfl)sfl.textContent=gardenFlowersSold;
    document.getElementById('shared-stats-section').style.display='block';
  }
}

// ============================================================
// POKEMON MAP MODE
// ============================================================
const POKEMON_DATA = [
  {name:'ÐŸÐ¸ÐºÐ°Ñ‡Ñƒ',    emoji:'âš¡', pts:40,  coins:0, pikaCoins:20, rar:'common',  label:'ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹',    col:'#f0d040', col2:'#c0a010'},
  {name:'Ð‘ÑƒÐ»ÑŒÐ±Ð°Ð·Ð°Ð²Ñ€',emoji:'ðŸŒ¿', pts:50,  coins:0, pikaCoins:25, rar:'common',  label:'ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹',    col:'#40a040', col2:'#206020'},
  {name:'Ð§Ð°Ñ€Ð¼Ð°Ð½Ð´ÐµÑ€', emoji:'ðŸ”¥', pts:50,  coins:0, pikaCoins:25, rar:'common',  label:'ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹',    col:'#f06020', col2:'#a03010'},
  {name:'Ð¡ÐºÐ²Ð¸Ñ€Ñ‚Ð»',   emoji:'ðŸ’§', pts:50,  coins:0, pikaCoins:25, rar:'common',  label:'ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹',    col:'#4090f0', col2:'#2060c0'},
  {name:'ÐœÐ°Ð´Ð¶Ð¸ÐºÐ°Ñ€Ð¿', emoji:'ðŸŸ', pts:10,  coins:0, pikaCoins:5,  rar:'common',  label:'ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹',    col:'#f04040', col2:'#a01010'},
  {name:'ÐŸÑÐ¸Ð´Ð°Ðº',    emoji:'ðŸ¦†', pts:60,  coins:0, pikaCoins:30, rar:'rare',    label:'Ð ÐµÐ´ÐºÐ¸Ð¹',     col:'#f0e040', col2:'#c0a010'},
  {name:'Ð“Ð°ÑÑ‚Ð»Ð¸',    emoji:'ðŸ‘»', pts:70,  coins:0, pikaCoins:35, rar:'rare',    label:'Ð ÐµÐ´ÐºÐ¸Ð¹',     col:'#8040c0', col2:'#4010a0'},
  {name:'Ð›Ð°Ð¿Ñ€Ð°Ñ',    emoji:'ðŸŒŠ', pts:100, coins:0, pikaCoins:50, rar:'epic',    label:'Ð­Ð¿Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹',  col:'#4080c0', col2:'#2050a0'},
  {name:'Ð“ÐµÐ½Ð³Ð°Ñ€',    emoji:'ðŸ˜ˆ', pts:120, coins:0, pikaCoins:60, rar:'epic',    label:'Ð­Ð¿Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹',  col:'#6030a0', col2:'#301060'},
  {name:'ÐœÑŒÑŽÑ‚Ñƒ',     emoji:'ðŸ”®', pts:200, coins:0, pikaCoins:100,rar:'legend',  label:'Ð›ÐµÐ³ÐµÐ½Ð´Ð°Ñ€Ð½Ñ‹Ð¹',col:'#c040c0', col2:'#801080'},
  {name:'ÐœÑŒÑŽ',       emoji:'ðŸ’—', pts:250, coins:0, pikaCoins:150,rar:'legend',  label:'Ð›ÐµÐ³ÐµÐ½Ð´Ð°Ñ€Ð½Ñ‹Ð¹',col:'#f080c0', col2:'#c04090'},
];

const PIKABUFS = [
  {id:'combo_x2',  name:'ÐŸÐ¸ÐºÐ°-ÐšÐ¾Ð¼Ð±Ð¾ Ã—2', desc:'Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ 5 Ð¿Ð¾ÐºÐµÐ¼Ð¾Ð½Ð¾Ð² Ð´Ð°ÑŽÑ‚ x2 Ð¿Ð¸ÐºÐ°ÐºÐ¾Ð¸Ð½Ñ‹',    price:30,  icon:'âš¡Ã—2', effect:'combo2'},
  {id:'combo_x3',  name:'ÐŸÐ¸ÐºÐ°-ÐšÐ¾Ð¼Ð±Ð¾ Ã—3', desc:'Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ 3 Ð¿Ð¾ÐºÐµÐ¼Ð¾Ð½Ð° Ð´Ð°ÑŽÑ‚ x3 Ð¿Ð¸ÐºÐ°ÐºÐ¾Ð¸Ð½Ñ‹',     price:60,  icon:'âš¡Ã—3', effect:'combo3'},
  {id:'rare_boost',name:'Ð Ð°Ñ€Ð‘ÑƒÑÑ‚',        desc:'Ð ÐµÐ´ÐºÐ¸Ðµ Ð¿Ð¾ÐºÐµÐ¼Ð¾Ð½Ñ‹ Ð¿Ð¾ÑÐ²Ð»ÑÑŽÑ‚ÑÑ Ð²Ð´Ð²Ð¾Ðµ Ñ‡Ð°Ñ‰Ðµ',       price:80,  icon:'ðŸŒŸ',   effect:'rare'},
  {id:'legend_call',name:'Ð—Ð¾Ð² Ð›ÐµÐ³ÐµÐ½Ð´Ñ‹',   desc:'Ð¨Ð°Ð½Ñ Ð¿Ð¾Ð¹Ð¼Ð°Ñ‚ÑŒ Ð»ÐµÐ³ÐµÐ½Ð´Ð°Ñ€Ð½Ð¾Ð³Ð¾ Ð¿Ð¾ÐºÐµÐ¼Ð¾Ð½Ð°',          price:150, icon:'ðŸ”®',   effect:'legend'},
];

gs.mapMode = 'normal'; // 'normal' | 'pokemon'
gs.pikaCoins = 0;
gs.pikaCatchCount = 0;
gs.activePikaBuf = null;
gs.pikaBufCount = 0;

function setMap(mode) {
  gs.mapMode = mode;
  document.getElementById('map-btn-normal').classList.toggle('active', mode==='normal');
  document.getElementById('map-btn-pokemon').classList.toggle('active', mode==='pokemon');
  
  const pokeBadge = document.getElementById('poke-mode-badge');
  const pikaBox = document.getElementById('pika-coins-box');
  
  if(mode === 'pokemon') {
    pokeBadge.style.display = 'block';
    pikaBox.style.display = 'flex';
    // Change sky colors to purple
    document.documentElement.style.setProperty('--sky-top','#1a0828');
    document.documentElement.style.setProperty('--sky-bot','#0a0418');
    showToast('âš¡ ÐŸÐ¾ÐºÐµÐ¼Ð¾Ð½ Ñ€ÐµÐ¶Ð¸Ð¼! Ð›Ð¾Ð²Ð¸ Ð¿Ð¾ÐºÐµÐ¼Ð¾Ð½Ð¾Ð² Ð·Ð° ÐŸÐ¸ÐºÐ°ÐšÐ¾Ð¸Ð½Ñ‹!');
  } else {
    pokeBadge.style.display = 'none';
    pikaBox.style.display = 'none';
    applyWeather(gs.weather, true);
    showToast('ðŸŒŠ ÐžÐ±Ñ‹Ñ‡Ð½Ð°Ñ ÐºÐ°Ñ€Ñ‚Ð° â€” Ð»Ð¾Ð²Ð¸Ð¼ Ñ€Ñ‹Ð±Ñƒ!');
  }
}

function getPokemonPool() {
  const hasBuf = gs.activePikaBuf;
  const pool = [];
  POKEMON_DATA.forEach(p => {
    let w = p.rar==='common'?60 : p.rar==='rare'?30 : p.rar==='epic'?8 : 2;
    if(hasBuf?.effect==='rare' && p.rar!=='common') w*=2;
    if(hasBuf?.effect==='legend' && p.rar==='legend') w*=3;
    for(let i=0;i<Math.round(w);i++) pool.push(p);
  });
  return pool;
}

function updatePikaCoins() {
  document.getElementById('pika-coins-display').textContent = gs.pikaCoins;
}


function catchPokemon(f) {
  gs.fishCount++;
  gs.pikaCatchCount++;
  gs.score += f.pts;
  document.getElementById('fish-count').textContent = gs.fishCount;
  document.getElementById('score-val').textContent = gs.score;
  
  let earned = f.pikaCoins;
  // Apply active buffs
  if(gs.activePikaBuf?.effect === 'combo2') { earned *= 2; gs.pikaBufCount--; }
  if(gs.activePikaBuf?.effect === 'combo3') { earned *= 3; gs.pikaBufCount--; }
  if(gs.pikaBufCount <= 0) gs.activePikaBuf = null;
  
  gs.pikaCoins += earned;
  updatePikaCoins();
  
  // Show popup with pokemon style
  document.getElementById('catch-header').textContent = 'âš¡ ÐŸÐ¾ÐºÐµÐ¼Ð¾Ð½!';
  document.getElementById('catch-name-txt').textContent = f.name;
  document.getElementById('catch-weight-txt').textContent = `+${f.pts} â˜… â€¢ +${earned}âš¡`;
  const rarEl = document.getElementById('catch-rarity');
  rarEl.textContent = f.label; rarEl.className = `rarity-${f.rar}`;
  // Show pokemon emoji, hide fish SVG
  document.getElementById('catch-fish-svg').style.display = 'none';
  const pokeEmoji = document.getElementById('catch-pokemon-emoji');
  pokeEmoji.textContent = f.emoji;
  pokeEmoji.style.display = 'block';
  document.getElementById('catch-sell-btn').style.display = 'none';
  document.getElementById('catch-popup').classList.add('show');
  showScorePop('+'+earned+'âš¡', gs.bobX, gs.bobY);
  makeRipple(gs.bobX, gs.bobY, 65);
  saveGame();
  // Sync leaderboard
  syncLeaderboard();
}



// ============================================================
// PIKABUFS SHOP
// ============================================================
function renderPikabufs(body) {
  if(gs.mapMode !== 'pokemon') {
    const note = document.createElement('div');
    note.style.cssText='font-family:\'Neucha\',cursive;font-size:13px;color:#5050a0;padding:16px;text-align:center;';
    note.textContent='âš¡ ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð¸ÑÑŒ Ð½Ð° ÐŸÐ¾ÐºÐµÐ¼Ð¾Ð½ ÐºÐ°Ñ€Ñ‚Ñƒ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ ÐŸÐ¸ÐºÐ°Ð‘Ð°Ñ„Ñ„Ñ‹!';
    body.appendChild(note);
    return;
  }
  const wrap = document.createElement('div'); wrap.className='pikabufs-section';
  wrap.innerHTML=`<div class="pikabufs-title">âš¡ ÐŸÐ¸ÐºÐ°Ð‘Ð°Ñ„Ñ„Ñ‹</div><div style="font-family:'Neucha',cursive;font-size:10px;color:#8070a0;margin-bottom:8px;text-align:center;">ÐŸÐ¾ÐºÑƒÐ¿Ð°ÑŽÑ‚ÑÑ Ð·Ð° ÐŸÐ¸ÐºÐ°ÐšÐ¾Ð¸Ð½Ñ‹ âš¡ â€¢ Ð”Ð°ÑŽÑ‚ ÐšÐ¾Ð¼Ð±Ð¾!</div>`;
  
  const bal = document.createElement('div');
  bal.style.cssText='font-family:\'Neucha\',cursive;font-size:13px;color:#f0d040;text-align:center;margin-bottom:10px;';
  bal.textContent = `Ð£ Ñ‚ÐµÐ±Ñ: ${gs.pikaCoins}âš¡ ÐŸÐ¸ÐºÐ°ÐšÐ¾Ð¸Ð½Ð¾Ð²`;
  wrap.appendChild(bal);
  
  PIKABUFS.forEach(pb => {
    const canBuy = gs.pikaCoins >= pb.price;
    const active = gs.activePikaBuf?.id === pb.id;
    const el = document.createElement('div');
    el.className='shop-item';
    if(active) el.style.borderColor='#f0d040';
    el.innerHTML=`
      <div class="shop-item-icon"><span style="font-size:36px;">${pb.icon}</span></div>
      <div class="shop-item-info">
        <div class="shop-item-name">${pb.name}</div>
        <div class="shop-item-desc">${pb.desc}</div>
        <div class="shop-item-price">âš¡ ${pb.price} ÐŸÐ¸ÐºÐ°ÐšÐ¾Ð¸Ð½Ð¾Ð²</div>
      </div>
      <button class="shop-item-btn ${active?'btn-equipped-shop':canBuy?'btn-buy-shop':'btn-owned-shop'}"
        onclick="buyPikaBuf('${pb.id}')" ${active||!canBuy?'disabled':''}>
        ${active?'âœ“ ÐÐºÑ‚Ð¸Ð²ÐµÐ½':'ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ'}
      </button>`;
    wrap.appendChild(el);
  });
  body.appendChild(wrap);
}

function buyPikaBuf(id) {
  const pb = PIKABUFS.find(p=>p.id===id);
  if(!pb) return;
  if(gs.pikaCoins < pb.price) { showToast(`âŒ ÐÑƒÐ¶Ð½Ð¾ ${pb.price}âš¡, Ñƒ Ñ‚ÐµÐ±Ñ ${gs.pikaCoins}âš¡`); return; }
  gs.pikaCoins -= pb.price;
  updatePikaCoins();
  gs.activePikaBuf = pb;
  gs.pikaBufCount = pb.effect.startsWith('combo') ? parseInt(pb.effect.slice(-1))*2 : 10;
  renderShop();
  showToast(`âš¡ ${pb.name} Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½!`);
}

// ============================================================
// FORTUNE WHEEL
// ============================================================
const FORTUNE_PRIZES = [
  {label:'50ðŸª™',    color:'#c04010', type:'coins', val:50},
  {label:'100ðŸª™',   color:'#206040', type:'coins', val:100},
  {label:'ðŸŸ Ð Ñ‹Ð±Ð°', color:'#2040a0', type:'fish',  val:1},
  {label:'20ðŸª™',    color:'#a02030', type:'coins', val:20},
  {label:'200ðŸª™',   color:'#806010', type:'coins', val:200},
  {label:'âš¡Ã—10',   color:'#8020a0', type:'pika',  val:10},
  {label:'30ðŸª™',    color:'#204060', type:'coins', val:30},
  {label:'ðŸŒ±Ð¡ÐµÐ¼Ñ',  color:'#1a5010', type:'seed',  val:1},
  {label:'500ðŸª™!',  color:'#a06010', type:'coins', val:500},
  {label:'ÐÐ¸Ñ‡ÐµÐ³Ð¾',  color:'#1a1a2a', type:'none',  val:0},
  {label:'80ðŸª™',    color:'#302050', type:'coins', val:80},
  {label:'âš¡Ã—25',   color:'#6010a0', type:'pika',  val:25},
];
const FORTUNE_COST = 50;
let fortuneSpinning = false;
let fortuneAngle = 0;

function openFortune() {
  document.getElementById('fortune-overlay').classList.add('show');
  drawFortuneWheel(fortuneAngle);
  document.getElementById('fortune-result').textContent = '';
}

function closeFortune() {
  if(fortuneSpinning) return;
  document.getElementById('fortune-overlay').classList.remove('show');
}

function drawFortuneWheel(rotation) {
  const canvas = document.getElementById('fortune-wheel-canvas');
  const ctx = canvas.getContext('2d');
  const cx = 130, cy = 130, r = 126;
  const n = FORTUNE_PRIZES.length;
  const arc = (Math.PI*2)/n;
  ctx.clearRect(0,0,260,260);
  // Outer ring
  ctx.beginPath(); ctx.arc(cx,cy,r+4,0,Math.PI*2);
  ctx.strokeStyle='#f0d040'; ctx.lineWidth=4; ctx.stroke();
  
  FORTUNE_PRIZES.forEach((p,i) => {
    const start = rotation + i*arc - Math.PI/2;
    const end   = start + arc;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,start,end);
    ctx.closePath();
    ctx.fillStyle = p.color;
    ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,.3)'; ctx.lineWidth=1; ctx.stroke();
    // Label
    const mid = start + arc/2;
    ctx.save();
    ctx.translate(cx + Math.cos(mid)*r*.65, cy + Math.sin(mid)*r*.65);
    ctx.rotate(mid + Math.PI/2);
    ctx.fillStyle='#fff';
    ctx.font='bold 11px Neucha,cursive';
    ctx.textAlign='center';
    ctx.fillText(p.label, 0, 0);
    ctx.restore();
  });
  // Center
  ctx.beginPath(); ctx.arc(cx,cy,18,0,Math.PI*2);
  ctx.fillStyle='#2a1608'; ctx.fill();
  ctx.strokeStyle='#f0d040'; ctx.lineWidth=2; ctx.stroke();
}

function spinFortune() {
  if(fortuneSpinning) return;
  if(gs.coins < FORTUNE_COST) { showToast(`âŒ ÐÑƒÐ¶Ð½Ð¾ ${FORTUNE_COST}ðŸª™ Ð´Ð»Ñ Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ñ!`); return; }
  gs.coins -= FORTUNE_COST;
  updateCoins();
  fortuneSpinning = true;
  document.getElementById('fortune-spin-btn').style.opacity = '0.5';
  document.getElementById('fortune-result').textContent = 'ðŸŽ¡ ÐšÑ€ÑƒÑ‚Ð¸Ñ‚ÑÑ...';
  
  const prizeIdx = Math.floor(Math.random()*FORTUNE_PRIZES.length);
  const n = FORTUNE_PRIZES.length;
  const arc = (Math.PI*2)/n;
  // Target angle: spin 5-8 full rotations + land on prize
  const targetOffset = -(prizeIdx * arc + arc/2);
  const extraSpins = (5 + Math.floor(Math.random()*3)) * Math.PI * 2;
  const finalAngle = targetOffset + extraSpins;
  
  let startTime = null;
  const duration = 4000;
  
  function animate(ts) {
    if(!startTime) startTime = ts;
    const elapsed = ts - startTime;
    const t = Math.min(1, elapsed/duration);
    // Ease out cubic
    const ease = 1 - Math.pow(1-t, 3);
    const currentAngle = fortuneAngle + finalAngle * ease;
    drawFortuneWheel(currentAngle);
    if(t < 1) {
      requestAnimationFrame(animate);
    } else {
      fortuneAngle = (fortuneAngle + finalAngle) % (Math.PI*2);
      fortuneSpinning = false;
      document.getElementById('fortune-spin-btn').style.opacity = '1';
      const prize = FORTUNE_PRIZES[prizeIdx];
      applyFortunePrize(prize);
    }
  }
  requestAnimationFrame(animate);
}

function applyFortunePrize(prize) {
  let msg = '';
  if(prize.type === 'coins') { gs.coins += prize.val; updateCoins(); coinBurst(180,350); msg = `ðŸŽ‰ Ð’Ñ‹Ð¸Ð³Ñ€Ð°Ð» ${prize.val}ðŸª™!`; }
  else if(prize.type === 'pika') { gs.pikaCoins += prize.val; updatePikaCoins(); msg = `âš¡ Ð’Ñ‹Ð¸Ð³Ñ€Ð°Ð» ${prize.val} ÐŸÐ¸ÐºÐ°ÐšÐ¾Ð¸Ð½Ð¾Ð²!`; }
  else if(prize.type === 'fish') { 
    const f = FISH_DATA[Math.floor(Math.random()*5)];
    gs.inventory.push({...f, weight:(f.w[0]+Math.random()*(f.w[1]-f.w[0])).toFixed(2)});
    msg = `ðŸŸ Ð’Ñ‹Ð¸Ð³Ñ€Ð°Ð» Ñ€Ñ‹Ð±Ñƒ: ${f.name}!`;
  }
  else if(prize.type === 'seed') {
    SEEDS[Math.floor(Math.random()*SEEDS.length)].owned++;
    msg = 'ðŸŒ± Ð’Ñ‹Ð¸Ð³Ñ€Ð°Ð» ÑÐµÐ¼Ñ!';
  }
  else { msg = 'ðŸ˜… ÐÐ¸Ñ‡ÐµÐ³Ð¾... ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ ÐµÑ‰Ñ‘ Ñ€Ð°Ð·!'; }
  
  document.getElementById('fortune-result').textContent = msg;
  showToast(msg);
  saveGame();
}

// ============================================================
// LEADERBOARD
// ============================================================
let lbTab = 'fish';

function switchLbTab(tab, el) {
  lbTab = tab;
  document.querySelectorAll('.lb-tab').forEach(t=>t.classList.remove('active'));
  if(el) el.classList.add('active');
  renderLeaderboard();
}

async function renderLeaderboard() {
  const list = document.getElementById('lb-list');
  list.innerHTML = '<div style="font-family:\'Neucha\',cursive;font-size:12px;color:#4040a0;padding:16px;text-align:center;">â³ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...</div>';
  
  // Try Firebase
  const ok = await initFirebase();
  if(!ok) {
    list.innerHTML = '<div style="font-family:\'Neucha\',cursive;font-size:12px;color:#4040a0;padding:16px;text-align:center;">âŒ ÐÑƒÐ¶Ð½Ð¾ Ð¸Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚-ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ</div>';
    return;
  }
  
  // Push own data
  await fb.upd(`leaderboard/${myPlayerId}`, {
    name: myPlayerName,
    fishCount: gs.fishCount,
    pikaCount: gs.pikaCatchCount,
    coins: gs.coins
  }).catch(()=>{});
  
  const snap = await fb.get('leaderboard').catch(()=>null);
  if(!snap || !snap.exists()) { list.innerHTML='<div style="font-family:\'Neucha\',cursive;font-size:12px;color:#4040a0;padding:16px;text-align:center;">ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…</div>'; return; }
  
  const data = snap.val();
  let entries = Object.entries(data).map(([id,d])=>({id,...d}));
  
  const field = lbTab==='fish'?'fishCount': lbTab==='pika'?'pikaCount':'coins';
  const icon  = lbTab==='fish'?'ðŸŸ': lbTab==='pika'?'âš¡':'ðŸª™';
  entries.sort((a,b)=>(b[field]||0)-(a[field]||0));
  entries = entries.slice(0,20);
  
  list.innerHTML = '';
  const medals = ['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
  entries.forEach((e,i)=>{
    const isMe = e.id === myPlayerId;
    const row = document.createElement('div');
    row.className = 'lb-row' + (isMe?' lb-me':'');
    row.innerHTML = `
      <div class="lb-rank">${medals[i]||('#'+(i+1))}</div>
      <div class="lb-name">${e.name||'Ð Ñ‹Ð±Ð°Ðº'}${isMe?' ðŸ‘ˆ':''}</div>
      <div class="lb-val">${icon} ${e[field]||0}</div>`;
    list.appendChild(row);
  });
}

async function syncLeaderboard() {
  if(!firebaseDB) return;
  fb.upd(`leaderboard/${myPlayerId}`, {
    name: myPlayerName,
    fishCount: gs.fishCount,
    pikaCount: gs.pikaCatchCount,
    coins: gs.coins
  }).catch(()=>{});
}

// ============================================================
// KIOSK (Player Marketplace)
// ============================================================
let kioskListings = {}; // Local cache of market

async function claimKioskPayments() {
  try {
    const snap = await fb.get(`kiosk_payments/${myPlayerId}/pending`);
    if(!snap.exists()) return;
    const amount = snap.val() || 0;
    if(amount <= 0) return;
    gs.coins += amount;
    updateCoins();
    await fb.set(`kiosk_payments/${myPlayerId}/pending`, 0);
    saveGame();
    showToast(`U0001F4B0 ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ Ð¾Ñ‚ Ð¿Ñ€Ð¾Ð´Ð°Ð¶ Ð² ÐºÐ¸Ð¾ÑÐºÐµ: +${amount}U0001F9B8!`);
  } catch(e) {}
}

async function enterKiosk() {
  const ok = await initFirebase();
  showGardenScene('kiosk');
  updatePlayerLocation('kiosk');
  renderKiosk();
  if(ok) {
    listenKioskMarket();
    claimKioskPayments();
  }
}

function leaveKiosk() {
  fadeScene(()=>{
    showGardenScene('road');
    document.getElementById('road-hint').textContent = 'Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ÑÑ...';
    const walker = document.getElementById('walker');
    walker.style.bottom='580px'; walker.className='walker from-shop';
    updatePlayerLocation('garden-road');
    setTimeout(()=>{
      fadeScene(()=>{ showGardenScene('garden'); renderGardenPlots(); updatePlayerLocation('garden'); });
    }, 2100);
  });
}

function renderKiosk() {
  renderKioskSell();
  renderKioskMarket();
}

function renderKioskSell() {
  const sec = document.getElementById('kiosk-sell-section');
  sec.innerHTML = '';
  
  // Fish from inventory
  if(gs.inventory.length === 0 && SEEDS.every(s=>s.owned===0) && gs.pikaCatchCount === 0) {
    sec.innerHTML = '<div style="font-family:\'Neucha\',cursive;font-size:12px;color:#6a5030;padding:8px;">ÐÐµÑ‚ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ð¸</div>';
    return;
  }
  
  // List inventory fish
  const uniqueFish = {};
  gs.inventory.forEach((f,i)=>{
    if(!uniqueFish[f.name]) uniqueFish[f.name] = {f, count:0, idx:[]};
    uniqueFish[f.name].count++;
    uniqueFish[f.name].idx.push(i);
  });
  
  Object.values(uniqueFish).forEach(({f,count,idx})=>{
    const defaultPrice = calcPrice(f);
    const div = document.createElement('div');
    div.className='kiosk-my-listing';
    div.innerHTML=`
      <div class="kiosk-listing-icon">ðŸŸ</div>
      <div class="kiosk-listing-info">
        <div class="kiosk-listing-name">${f.name} Ã—${count}</div>
        <div class="kiosk-listing-price">ÐÐ²Ñ‚Ð¾-Ñ†ÐµÐ½Ð°: ${defaultPrice}ðŸª™</div>
      </div>
      <input class="kiosk-price-input" id="price-${f.name}" type="number" value="${defaultPrice}" min="1" max="99999"/>
      <button class="kiosk-listing-btn btn-list" onclick="listKioskItem('fish','${f.name}',${idx[0]})">ðŸ“¦ Ð’Ñ‹ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ</button>`;
    sec.appendChild(div);
  });
  
  // Seeds
  SEEDS.filter(s=>s.owned>0).forEach(s=>{
    const div = document.createElement('div');
    div.className='kiosk-my-listing';
    div.innerHTML=`
      <div class="kiosk-listing-icon">${s.bag}</div>
      <div class="kiosk-listing-info">
        <div class="kiosk-listing-name">${s.name} (ÑÐµÐ¼Ñ) Ã—${s.owned}</div>
        <div class="kiosk-listing-price">Ð Ñ‹Ð½Ð¾Ñ‡Ð½Ð°Ñ Ñ†ÐµÐ½Ð°: ${s.price}ðŸª™</div>
      </div>
      <input class="kiosk-price-input" id="price-seed-${s.id}" type="number" value="${s.price}" min="1" max="99999"/>
      <button class="kiosk-listing-btn btn-list" onclick="listKioskItem('seed','${s.id}',0)">ðŸ“¦ Ð’Ñ‹ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ</button>`;
    sec.appendChild(div);
  });
}

async function listKioskItem(type, id, invIdx) {
  const ok = await initFirebase();
  if(!ok) { showToast('âŒ ÐÐµÑ‚ Ð¸Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚Ð°'); return; }
  
  let price, name, icon;
  if(type==='fish') {
    const priceInput = document.getElementById('price-'+id);
    price = parseInt(priceInput?.value)||10;
    const f = gs.inventory[invIdx]; if(!f) return;
    name = f.name; icon = 'ðŸŸ';
    gs.inventory.splice(invIdx, 1);
    saveGame();
  } else if(type==='seed') {
    const priceInput = document.getElementById('price-seed-'+id);
    price = parseInt(priceInput?.value)||10;
    const s = SEEDS.find(x=>x.id===id); if(!s||s.owned<=0) return;
    name = s.name+' (ÑÐµÐ¼Ñ)'; icon = s.bag;
    s.owned--;
    saveGame();
  }
  
  await fb.set(`kiosk/${myPlayerId}_${Date.now()}`, {
    sellerId: myPlayerId, sellerName: myPlayerName,
    type, id, price, name, icon, listedAt: Date.now()
  });
  showToast(`ðŸ“¦ ${name} Ð²Ñ‹ÑÑ‚Ð°Ð²Ð»ÐµÐ½ Ð·Ð° ${price}ðŸª™!`);
  renderKiosk();
}

function listenKioskMarket() {
  fb.on('kiosk', snap=>{
    kioskListings = snap.val() || {};
    renderKioskMarket();
  });
}

function renderKioskMarket() {
  const list = document.getElementById('kiosk-market-list');
  if(!list) return;
  list.innerHTML = '';
  const entries = Object.entries(kioskListings);
  if(!entries.length) {
    list.innerHTML='<div style="font-family:\'Neucha\',cursive;font-size:12px;color:#6a5030;padding:8px;">Ð Ñ‹Ð½Ð¾Ðº Ð¿ÑƒÑÑ‚. Ð¡Ñ‚Ð°Ð½ÑŒ Ð¿ÐµÑ€Ð²Ñ‹Ð¼ Ð¿Ñ€Ð¾Ð´Ð°Ð²Ñ†Ð¾Ð¼!</div>';
    return;
  }
  entries.sort((a,b)=>a[1].listedAt-b[1].listedAt).forEach(([key,item])=>{
    const isOwn = item.sellerId === myPlayerId;
    const canBuy = gs.coins >= item.price;
    const div = document.createElement('div');
    div.className='kiosk-my-listing';
    div.innerHTML=`
      <div class="kiosk-listing-icon">${item.icon}</div>
      <div class="kiosk-listing-info">
        <div class="kiosk-listing-name">${item.name}</div>
        <div class="kiosk-listing-price">${isOwn?'Ð¢Ñ‹ Ð¿Ñ€Ð¾Ð´Ð°Ñ‘ÑˆÑŒ':'ÐžÑ‚: '+item.sellerName} â€¢ ${item.price}ðŸª™</div>
      </div>
      ${isOwn
        ? `<button class="kiosk-listing-btn btn-cancel-listing" onclick="cancelKioskListing('${key}')">ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ</button>`
        : `<button class="kiosk-listing-btn btn-buy-listing" onclick="buyKioskListing('${key}')" ${canBuy?'':'style="opacity:.4"'}>${canBuy?'ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ':'ÐœÐ°Ð»Ð¾ ðŸª™'}</button>`
      }`;
    list.appendChild(div);
  });
}

async function buyKioskListing(key) {
  const item = kioskListings[key];
  if(!item) return;
  if(gs.coins < item.price) { showToast('âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¼Ð¾Ð½ÐµÑ‚!'); return; }
  const ok = await initFirebase();
  if(!ok) return;
  // Check still exists
  const snap = await fb.get(`kiosk/${key}`);
  if(!snap.exists()) { showToast('âŒ Ð¢Ð¾Ð²Ð°Ñ€ ÑƒÐ¶Ðµ Ð¿Ñ€Ð¾Ð´Ð°Ð½!'); return; }
  gs.coins -= item.price;
  updateCoins();
  // Add to inventory if fish
  if(item.type === 'fish') {
    const f = FISH_DATA.find(x=>x.name===item.id||x.name===item.name);
    if(f) gs.inventory.push({...f, weight:(f.w[0]+Math.random()*(f.w[1]-f.w[0])).toFixed(2)});
  } else if(item.type==='seed') {
    const s = SEEDS.find(x=>x.id===item.id);
    if(s) s.owned++;
  }
  await fb.rm(`kiosk/${key}`);
  // Give coins to seller â€” accumulate pending payment in Firebase
  try {
    const paySnap = await fb.get(`kiosk_payments/${item.sellerId}/pending`);
    const cur = paySnap.exists() ? (paySnap.val() || 0) : 0;
    await fb.set(`kiosk_payments/${item.sellerId}/pending`, cur + item.price);
  } catch(e) {}
  showToast(`âœ… ÐšÑƒÐ¿Ð»ÐµÐ½Ð¾: ${item.name} Ð·Ð° ${item.price}ðŸª™!`);
  saveGame(); renderKiosk();
}

async function cancelKioskListing(key) {
  const item = kioskListings[key]; if(!item) return;
  const ok = await initFirebase(); if(!ok) return;
  await fb.rm(`kiosk/${key}`);
  // Return item
  if(item.type==='fish') {
    const f = FISH_DATA.find(x=>x.name===item.id||x.name===item.name);
    if(f) gs.inventory.push({...f, weight:(f.w[0]+Math.random()*(f.w[1]-f.w[0])).toFixed(2)});
  } else if(item.type==='seed') {
    const s = SEEDS.find(x=>x.id===item.id);
    if(s) s.owned++;
  }
  showToast('ðŸ”™ Ð¢Ð¾Ð²Ð°Ñ€ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ñ‘Ð½!');
  saveGame(); renderKiosk();
}

// ============================================================
// ROD VISUAL â€” Change rod appearance on fishing screen
// ============================================================
const ROD_COLORS = {
  wood:   {color:'#8b5e2a', glow:'none'},
  bamboo: {color:'#6a9030', glow:'0 0 8px rgba(100,160,40,.5)'},
  carbon: {color:'#405868', glow:'0 0 8px rgba(60,100,120,.6)'},
  magic:  {color:'#9040c0', glow:'0 0 16px rgba(160,50,255,.8)'},
  golden: {color:'#d4a020', glow:'0 0 20px rgba(255,200,30,.9)'},
};

function updateRodVisual() {
  const rod = gs.currentRod;
  const rc = ROD_COLORS[rod.id] || ROD_COLORS.wood;
  const rodBody = document.getElementById('rod-body');
  rodBody.style.background = `linear-gradient(to right, ${rc.color}80, ${rc.color}, ${rc.color}80)`;
  rodBody.style.boxShadow = rc.glow;
  // Update all rod rings color
  document.querySelectorAll('#rod-body .rod-ring').forEach(r=>{
    r.style.borderColor = rc.color;
  });
  document.getElementById('current-rod-name').textContent = 'ðŸŽ£ '+rod.name;
  document.getElementById('current-rod-name').style.color = rc.color;
}



// ============================================================
// MULTIPLAYER ROD 2 â€” Show partner's rod with animation
// ============================================================
// Second bobber for partner
let bob2X = 180, bob2Y = 380;
let partnerPhase = 'idle'; // 'idle' | 'waiting' | 'bite'
let partner2Timer = null;

function simulatePartner2() {
  if(!gs.fullMultiMode || !currentRoomId) return;
  // Find another player in the room
  const others = Object.entries(playersData).filter(([pid])=>pid!==myPlayerId);
  if(!others.length) return;
  
  const lctx2 = document.getElementById('linecanvas2').getContext('2d');
  if(partnerPhase === 'idle') {
    // Partner casts
    bob2X = 60 + Math.random()*140;
    bob2Y = 320 + Math.random()*120;
    partnerPhase = 'waiting';
    // Draw line from left rod
    lctx2.clearRect(0,0,360,700);
    lctx2.beginPath();
    lctx2.moveTo(30, 90);
    lctx2.quadraticCurveTo(bob2X-20, 60, bob2X, bob2Y);
    lctx2.strokeStyle='rgba(180,170,140,.65)'; lctx2.lineWidth=1.2;
    lctx2.setLineDash([4,3]); lctx2.stroke(); lctx2.setLineDash([]);
    
    // Random bite after 3-8 seconds
    clearTimeout(partner2Timer);
    partner2Timer = setTimeout(()=>{
      if(!gs.fullMultiMode) return;
      partnerPhase = 'bite';
      // Flash the rod2
      document.getElementById('rod-body2').style.filter = 'brightness(2)';
      setTimeout(()=>{
        document.getElementById('rod-body2').style.filter='';
        partnerPhase = 'idle';
        lctx2.clearRect(0,0,360,700);
        setTimeout(simulatePartner2, 1000 + Math.random()*2000);
      }, 1200);
    }, 3000 + Math.random()*5000);
  }
}



// Periodic sync every 8s
setInterval(()=>{ if(gs.fullMultiMode&&currentRoomId) syncFishingToFirebase(); },8000);

let _lastSyncedCoins = -1;
let _lastSyncedFish = -1;

function syncFishingToFirebase() {
  if(!firebaseDB||!currentRoomId||!gs.fullMultiMode) return;
  fb.upd(`rooms/${currentRoomId}`,{
    sharedCoins:gs.coins,
    sharedFishCount:gs.fishCount,
    sharedInventory:JSON.stringify(gs.inventory),
    lastSyncer:myPlayerId,
    lastSyncTime:Date.now()
  }).catch(()=>{});
  _lastSyncedCoins = gs.coins;
  _lastSyncedFish = gs.fishCount;
}


// ============================================================
// GARDEN SCENE EXTENSION for kiosk - override first definition
// ============================================================
// This replaces the earlier showGardenScene to add kiosk support

// Override walkToShop to show choice
function walkToShop() {
  fadeScene(()=>{
    showGardenScene('road');
    document.getElementById('road-hint').textContent='Ð˜Ð´Ñ‘Ð¼...';
    document.getElementById('road-choice').style.display='none';
    const walker=document.getElementById('walker');
    walker.className='walker to-shop';
    walker.style.bottom='200px';
    updatePlayerLocation('garden-road');
    setTimeout(()=>{
      document.getElementById('road-hint').textContent='ÐŸÑ€Ð¸ÑˆÐ»Ð¸! ÐšÑƒÐ´Ð° Ð¸Ð´Ñ‘Ð¼?';
      document.getElementById('road-choice').style.display='flex';
    }, 2500);
  });
}

function enterShopFromRoad() {
  // Click on door = go to plant shop
  if(document.getElementById('road-choice').style.display==='flex') {
    enterShop();
  }
}

// (switchScreen, renderShop, saveGame wrappers merged into originals above)

// Load extra on startup
(function loadExtra() {
  try {
    const raw = localStorage.getItem('fishing_reborn_extra');
    if(!raw) return;
    const d = JSON.parse(raw);
    gs.pikaCoins = d.pikaCoins || 0;
    gs.pikaCatchCount = d.pikaCatchCount || 0;
    if(d.mapMode) { gs.mapMode = d.mapMode; /* will be applied after DOM ready */ }
  } catch(e){}
})();

// ============================================================
// INIT â€” apply rod visual on load
// ============================================================
setTimeout(()=>{
  updateRodVisual();
  updatePikaCoins();
  if(gs.mapMode === 'pokemon') setMap('pokemon');
  // Check for pending kiosk payments on startup (sold while offline)
  initFirebase().then(ok=>{ if(ok) claimKioskPayments(); });
}, 100);

// Leaderboard auto-refresh when on lb screen
setInterval(()=>{
  if(gs.currentScreen==='leaderboard') renderLeaderboard();
}, 30000);






// ============================================================
// DEBUG â€” uncomment to reset save
// ============================================================
// localStorage.removeItem(SAVE_KEY);
function saveGarden() {
  // Ð¿Ñ€Ð¸Ð¼ÐµÑ€ â€” ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÑÐ°Ð´ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾
  localStorage.setItem('garden', JSON.stringify(gardenPlots));
}

</script>
</body>
</html>
